#% if proxmox_csi_token_id and proxmox_csi_token_secret %#
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: proxmox-csi-plugin
spec:
  chartRef:
    kind: OCIRepository
    name: proxmox-csi-plugin
  interval: 1h
  values:
    # Use existing secret for Proxmox credentials
    existingConfigSecret: proxmox-csi-plugin
    existingConfigSecretKey: config.yaml

    # StorageClass is managed separately
    storageClass: []

    controller:
      # Network policy labels for CCNP tiered policies
      podLabels:
        network.cilium.io/api-access: "true"
      plugin:
        image:
          repository: ghcr.io/sergelogvinov/proxmox-csi-controller
          # renovate: datasource=docker depName=ghcr.io/sergelogvinov/proxmox-csi-controller
          tag: v0.16.0
      # CSI sidecar versions - registry.k8s.io doesn't support Docker API lookups
      # so we use GitHub releases for version tracking
      provisioner:
        image:
          repository: registry.k8s.io/sig-storage/csi-provisioner
          # renovate: datasource=github-releases depName=kubernetes-csi/external-provisioner
          tag: v6.1.0
      attacher:
        image:
          repository: registry.k8s.io/sig-storage/csi-attacher
          # renovate: datasource=github-releases depName=kubernetes-csi/external-attacher
          tag: v4.10.0
      resizer:
        image:
          repository: registry.k8s.io/sig-storage/csi-resizer
          # renovate: datasource=github-releases depName=kubernetes-csi/external-resizer
          tag: v2.0.0
      # Optional: Enable snapshotter sidecar for volume snapshots
      # snapshotter:
      #   enabled: true
      #   image:
      #     repository: registry.k8s.io/sig-storage/csi-snapshotter
      #     # renovate: datasource=github-releases depName=kubernetes-csi/external-snapshotter
      #     tag: v8.4.0

    node:
      plugin:
        image:
          repository: ghcr.io/sergelogvinov/proxmox-csi-node
          # renovate: datasource=docker depName=ghcr.io/sergelogvinov/proxmox-csi-node
          tag: v0.16.0
      driverRegistrar:
        image:
          repository: registry.k8s.io/sig-storage/csi-node-driver-registrar
          # renovate: datasource=github-releases depName=kubernetes-csi/node-driver-registrar
          tag: v2.15.0
      # Talos uses standard kubelet directory
      kubeletDir: /var/lib/kubelet
#% endif %#
