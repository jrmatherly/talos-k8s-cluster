#% if agentgateway_enabled %#
---
#| AgentgatewayParameters for agentgateway runtime config and deployment settings #|
#| Referenced by GatewayClass.parametersRef - controls both K8s resources and agentgateway config.yaml #|
#| NOTE: We use AgentgatewayParameters (not GatewayParameters) because: #|
#| 1. It supports rawConfig for native agentgateway configuration (adminAddr, binds, etc.) #|
#| 2. It also supports service/deployment overrides like GatewayParameters #|
#| 3. Gateway.infrastructure.parametersRef has a bug in kgateway v2.2.0-main that rejects agentgateway.dev group #|
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayParameters
metadata:
  name: agentgateway-mcp-config
spec:
  #| Service type override - LoadBalancer for external access #|
  service:
    spec:
      type: LoadBalancer
  #| Native agentgateway configuration via rawConfig #|
  rawConfig:
    #| Admin UI configuration - bind to all interfaces for external access #|
    config:
      adminAddr: "0.0.0.0:15000"
      logging:
        level: info
    binds:
    - port: 3000
      listeners:
      - routes:
        - name: mcp-authenticated
          policies:
            #| MCP Authentication with Keycloak (RFC 9728) #|
            mcpAuthentication:
              issuer: "https://auth.#{ primary_domain }#/realms/k8s-cluster"
              jwksUrl: "https://auth.#{ primary_domain }#/realms/k8s-cluster/protocol/openid-connect/certs"
              audience: "agentgateway-mcp"
              provider:
                keycloak: {}
              resourceMetadata:
                resource: "https://mcp-auth.#{ primary_domain }#/mcp"
                scopesSupported:
#% for scope in agentgateway_scopes | default(['openid', 'profile', 'email', 'offline_access']) %#
                - "#{ scope }#"
#% endfor %#
                bearerMethodsSupported:
                - header
                - body
                - query
            #| CORS policy for MCP clients #|
            cors:
              allowOrigins:
              - "https://*.#{ primary_domain }#"
              allowHeaders:
              - mcp-protocol-version
              - content-type
              - cache-control
              - authorization
              allowMethods:
              - GET
              - POST
              - OPTIONS
              exposeHeaders:
              - mcp-session-id
          #| MCP Backend Targets (placeholder) #|
          backends:
          - mcp:
              targets:
              - name: example-tools
                stdio:
                  cmd: echo
                  args: ["MCP backend not configured"]
---
#| Service for agentgateway admin UI (port 15000 is reserved in Gateway) #|
#| This exposes the admin interface which agentgateway binds to 0.0.0.0:15000 #|
apiVersion: v1
kind: Service
metadata:
  name: agentgateway-admin
  labels:
    app.kubernetes.io/name: agentgateway-admin
spec:
  selector:
    app.kubernetes.io/name: agentgateway
    gateway.networking.k8s.io/gateway-name: agentgateway
  ports:
  - name: admin
    port: 15000
    targetPort: 15000
    protocol: TCP
  type: ClusterIP
---
#| HTTPRoute for agentgateway admin UI #|
#| Routes /ui and related paths to the admin interface via agentgateway-admin service #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: agentgateway-ui
spec:
  parentRefs:
  - name: agentgateway
    namespace: agentgateway
    sectionName: https
  hostnames:
  - "mcp-auth.#{ primary_domain }#"
  rules:
  #| Admin UI routes #|
  - matches:
    - path:
        type: PathPrefix
        value: /ui
    backendRefs:
    - name: agentgateway-admin
      port: 15000
  #| Health check endpoint #|
  - matches:
    - path:
        type: Exact
        value: /healthz
    backendRefs:
    - name: agentgateway-admin
      port: 15000
  #| API endpoints for UI #|
  - matches:
    - path:
        type: PathPrefix
        value: /api
    backendRefs:
    - name: agentgateway-admin
      port: 15000
---
#| TrafficPolicy for rate limiting #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: agentgateway-rate-limit
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: agentgateway
  rateLimit:
    local:
      tokenBucket:
        maxTokens: 100
        tokensPerFill: 100
        fillInterval: "60s"
---
#| HTTPListenerPolicy for access logging #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: HTTPListenerPolicy
metadata:
  name: agentgateway-logging
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: agentgateway
  accessLog:
  - fileSink:
      path: /dev/stdout
      jsonFormat:
        timestamp: "%START_TIME%"
        method: "%REQ(:METHOD)%"
        path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
        protocol: "%PROTOCOL%"
        responseCode: "%RESPONSE_CODE%"
        responseFlags: "%RESPONSE_FLAGS%"
        bytesReceived: "%BYTES_RECEIVED%"
        bytesSent: "%BYTES_SENT%"
        duration: "%DURATION%"
        upstreamHost: "%UPSTREAM_HOST%"
        userAgent: "%REQ(USER-AGENT)%"
        requestId: "%REQ(X-REQUEST-ID)%"
        authority: "%REQ(:AUTHORITY)%"
#% endif %#
