#% if agentgateway_enabled %#
---
#| GatewayParameters for Kubernetes deployment settings (gateway.kgateway.dev API) #|
#| Referenced by GatewayClass.parametersRef - controls K8s resources #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: GatewayParameters
metadata:
  name: agentgateway-params
spec:
  kube:
    deployment:
      replicas: 1
    service:
      type: LoadBalancer
    #| Configure agentgateway container environment #|
    agentgateway:
      env:
        #| Bind admin UI to all interfaces for external access (default: 127.0.0.1:15000) #|
        - name: ADMIN_ADDR
          value: "0.0.0.0:15000"
---
#| Service for agentgateway stats/metrics endpoint #|
#| agentgateway binds stats to [::]:15020 by default (not configurable via env) #|
#| Exposes Prometheus metrics for ServiceMonitor scraping #|
apiVersion: v1
kind: Service
metadata:
  name: agentgateway-metrics
  labels:
    app.kubernetes.io/name: agentgateway
    gateway.networking.k8s.io/gateway-name: agentgateway
spec:
  selector:
    app.kubernetes.io/name: agentgateway
    gateway.networking.k8s.io/gateway-name: agentgateway
  ports:
  - name: metrics
    port: 15020
    targetPort: 15020
    protocol: TCP
  type: ClusterIP
---
#| Service for agentgateway admin UI (port 15000 is reserved in Gateway) #|
#| This exposes the admin interface which agentgateway binds to 0.0.0.0:15000 #|
apiVersion: v1
kind: Service
metadata:
  name: agentgateway-admin
  labels:
    app.kubernetes.io/name: agentgateway-admin
spec:
  selector:
    app.kubernetes.io/name: agentgateway
    gateway.networking.k8s.io/gateway-name: agentgateway
  ports:
  - name: admin
    port: 15000
    targetPort: 15000
    protocol: TCP
  type: ClusterIP
---
#| HTTPRoute for agentgateway admin UI #|
#| Routes /ui, /config, /config_dump path prefixes to admin interface #|
#| Protected by OAuth2 via TrafficPolicy when keycloak_enabled #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: agentgateway-ui
spec:
  parentRefs:
  - name: agentgateway
    namespace: agentgateway
    sectionName: https
  hostnames:
  - "mcp-gw.#{ primary_domain }#"
  - "ai-gw.#{ primary_domain }#"
  rules:
  #| Route /ui paths to admin UI service #|
  - matches:
    - path:
        type: PathPrefix
        value: /ui
    backendRefs:
    - name: agentgateway-admin
      port: 15000
  #| Route /config paths to admin UI service #|
  - matches:
    - path:
        type: PathPrefix
        value: /config
    backendRefs:
    - name: agentgateway-admin
      port: 15000
  #| Route /config_dump path to admin UI service (separate from /config) #|
  - matches:
    - path:
        type: PathPrefix
        value: /config_dump
    backendRefs:
    - name: agentgateway-admin
      port: 15000
  #| OAuth2 callback path (handled by kgateway TrafficPolicy) #|
  - matches:
    - path:
        type: PathPrefix
        value: /oauth2
    backendRefs:
    - name: agentgateway-admin
      port: 15000
#% if keycloak_enabled %#
---
#| =========================================== #|
#| OAuth2 Protection for Admin UI (kgateway)   #|
#| =========================================== #|
#| GatewayExtension for Keycloak OIDC configuration #|
#| REF: https://kgateway.dev/docs/guides/oidc/ #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: GatewayExtension
metadata:
  name: keycloak-oauth
spec:
  oauth2:
    backendRef:
      kind: Backend
      group: gateway.kgateway.dev
      name: keycloak-oauth
    issuerURI: "https://auth.#{ primary_domain }#/realms/k8s-cluster"
    credentials:
      clientID: "agentgateway-mcp"
      clientSecretRef:
        name: agentgateway-oauth-secret
    redirectURI: "https://ai-gw.#{ primary_domain }#/oauth2/callback"
    logoutPath: /logout
    forwardAccessToken: true
    scopes:
      - openid
      - profile
      - email
---
#| Backend for Keycloak OAuth endpoints #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: Backend
metadata:
  name: keycloak-oauth
spec:
  type: Static
  static:
    hosts:
    - host: "auth.#{ primary_domain }#"
      port: 443
---
#| BackendTLSPolicy for Keycloak OAuth #|
apiVersion: gateway.networking.k8s.io/v1
kind: BackendTLSPolicy
metadata:
  name: keycloak-oauth-tls
spec:
  targetRefs:
  - group: gateway.kgateway.dev
    kind: Backend
    name: keycloak-oauth
  validation:
    hostname: "auth.#{ primary_domain }#"
    wellKnownCACertificates: System
---
#| Secret for OAuth client credentials #|
apiVersion: v1
kind: Secret
metadata:
  name: agentgateway-oauth-secret
type: Opaque
stringData:
  client-secret: "#{ keycloak_agentgateway_client_secret | default(keycloak_oidc_client_secret) }#"
---
#| TrafficPolicy to protect admin UI with OAuth2 #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: agentgateway-ui-oauth
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: agentgateway-ui
  oauth2:
    extensionRef:
      name: keycloak-oauth
#% endif %#
---
#| MCP Backend for routing to MCP servers #|
#| Uses label selector to dynamically discover MCP server pods #|
#| Requires Services with appProtocol: kgateway.dev/mcp #|
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: mcp-backend
spec:
  mcp:
    targets:
    - name: mcp-servers
      selector:
        services:
          matchLabels:
            agentgateway.dev/mcp: "true"
---
#| HTTPRoute for MCP traffic on HTTPS listener #|
#| Routes mcp-gw.<domain> to MCP backend with OAuth authentication #|
#| The mcp-oauth-authentication policy targets this route #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: mcp-route
spec:
  parentRefs:
  - name: agentgateway
    namespace: agentgateway
    sectionName: https
  hostnames:
  - "mcp-gw.#{ primary_domain }#"
  rules:
  - backendRefs:
    - group: agentgateway.dev
      kind: AgentgatewayBackend
      name: mcp-backend
---
#| =========================================== #|
#| TrafficPolicy: Rate Limiting                #|
#| =========================================== #|
#| TrafficPolicy with token bucket rate limiting for MCP traffic #|
#| Limits: 100 requests burst, 50 requests/min sustained #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: agentgateway-rate-limit
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: agentgateway
  #| Token bucket rate limiting for MCP requests #|
  rateLimit:
    local:
      tokenBucket:
        maxTokens: 100           # Maximum burst capacity (requests)
        tokensPerFill: 50        # Requests added per interval
        fillInterval: "60s"      # Refill interval (1 minute)
---
#| HTTPListenerPolicy for enhanced access logging #|
#| Includes AI-specific fields: tokens, cost, prompt guard actions #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: HTTPListenerPolicy
metadata:
  name: agentgateway-logging
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: agentgateway
  accessLog:
  - fileSink:
      path: /dev/stdout
      jsonFormat:
        #| Standard fields #|
        timestamp: "%START_TIME%"
        method: "%REQ(:METHOD)%"
        path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
        protocol: "%PROTOCOL%"
        responseCode: "%RESPONSE_CODE%"
        responseFlags: "%RESPONSE_FLAGS%"
        bytesReceived: "%BYTES_RECEIVED%"
        bytesSent: "%BYTES_SENT%"
        duration: "%DURATION%"
        upstreamHost: "%UPSTREAM_HOST%"
        userAgent: "%REQ(USER-AGENT)%"
        requestId: "%REQ(X-REQUEST-ID)%"
        authority: "%REQ(:AUTHORITY)%"
        #| AI-specific fields #|
        xAiModel: "%REQ(X-AI-EG-MODEL)%"
        #| Token usage and cost tracking (if available from backend) #|
        inputTokens: "%RESP(X-INPUT-TOKENS)%"
        outputTokens: "%RESP(X-OUTPUT-TOKENS)%"
        costUsd: "%RESP(X-COST-USD)%"
        #| Prompt guard action tracking #|
        promptGuardAction: "%RESP(X-PROMPT-GUARD-ACTION)%"
#| Note: Azure OpenAI backends are defined in azure-backends.yaml.j2 #|
#% if keycloak_enabled %#
---
#| =========================================== #|
#| AgentgatewayPolicy: MCP OAuth Authentication #|
#| =========================================== #|
#| Applies MCP backend authentication policy to MCP routes #|
#| Uses Keycloak for MCP OAuth 2.1 spec compliance (RFC 9728, RFC 8707) #|
#| REF: https://modelcontextprotocol.io/specification/2025-11-25/basic/authorization #|
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: mcp-oauth-authentication
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: mcp-route
  #| Backend policy for MCP authentication (spec.backend.mcp.authentication) #|
  backend:
    mcp:
      authentication:
        #| Keycloak realm issuer URL #|
        issuer: "https://auth.#{ primary_domain }#/realms/k8s-cluster"
        #| Expected audiences for token validation (RFC 8707) #|
        audiences:
          - "https://mcp-gw.#{ primary_domain }#/mcp"
        #| Provider-specific settings for Keycloak #|
        provider: Keycloak
        #| JWKS endpoint for JWT signature validation #|
        jwks:
          uri: "https://auth.#{ primary_domain }#/realms/k8s-cluster/protocol/openid-connect/certs"
        #| RFC 9728 Protected Resource Metadata #|
        #| Exposed at /.well-known/oauth-protected-resource #|
        resourceMetadata:
          default:
            resource: "https://mcp-gw.#{ primary_domain }#/mcp"
            authorizationServers:
              - "https://auth.#{ primary_domain }#/realms/k8s-cluster"
            scopesSupported:
              - openid
              - profile
              - email
              - mcp:tools
              - offline_access
            bearerMethodsSupported:
              - header
---
#| =========================================== #|
#| AgentgatewayPolicy: CORS for MCP             #|
#| =========================================== #|
#| Enables browser-based MCP clients (MCP Inspector, Claude Desktop) #|
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: mcp-cors
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: mcp-route
  #| Traffic policy for CORS (spec.traffic.cors) #|
  traffic:
    cors:
      #| Wildcard port patterns not supported - use specific common dev ports #|
      allowOrigins:
        - "https://mcp-gw.#{ primary_domain }#"
        - "https://ai-gw.#{ primary_domain }#"
        - "https://*.#{ primary_domain }#"
        - "http://localhost"
        - "http://localhost:3000"
        - "http://localhost:5173"
        - "http://localhost:8080"
        - "http://127.0.0.1"
        - "http://127.0.0.1:3000"
        - "http://127.0.0.1:5173"
        - "http://127.0.0.1:8080"
      allowMethods:
        - GET
        - POST
        - OPTIONS
      allowHeaders:
        - Authorization
        - Content-Type
        - X-Request-ID
      exposeHeaders:
        - X-Request-ID
        - WWW-Authenticate
      allowCredentials: true
      #| maxAge is integer (seconds), not string #|
      maxAge: 86400
#% endif %#
#% endif %#