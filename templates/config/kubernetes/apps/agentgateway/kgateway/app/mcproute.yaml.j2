#% if agentgateway_enabled %#
---
#| GatewayParameters for Kubernetes deployment settings (gateway.kgateway.dev API) #|
#| Referenced by GatewayClass.parametersRef - controls K8s resources #|
#| Enhanced with metrics endpoint for observability (Phase 1) #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: GatewayParameters
metadata:
  name: agentgateway-params
spec:
  kube:
    deployment:
      replicas: 1
    service:
      type: LoadBalancer
    #| Configure agentgateway container environment #|
    agentgateway:
      env:
        #| Bind admin UI to all interfaces for external access (default: 127.0.0.1:15000) #|
        - name: ADMIN_ADDR
          value: "0.0.0.0:15000"
        #| Enable metrics endpoint for Prometheus scraping (Phase 1) #|
        - name: METRICS_ENABLED
          value: "true"
        - name: METRICS_PORT
          value: "9090"
---
#| Service for agentgateway metrics endpoint (Phase 1) #|
#| Exposes metrics on port 9090 for Prometheus ServiceMonitor #|
apiVersion: v1
kind: Service
metadata:
  name: agentgateway-metrics
  labels:
    app.kubernetes.io/name: agentgateway
    gateway.networking.k8s.io/gateway-name: agentgateway
spec:
  selector:
    app.kubernetes.io/name: agentgateway
    gateway.networking.k8s.io/gateway-name: agentgateway
  ports:
  - name: metrics
    port: 9090
    targetPort: 9090
    protocol: TCP
  type: ClusterIP
---
#| Service for agentgateway admin UI (port 15000 is reserved in Gateway) #|
#| This exposes the admin interface which agentgateway binds to 0.0.0.0:15000 #|
apiVersion: v1
kind: Service
metadata:
  name: agentgateway-admin
  labels:
    app.kubernetes.io/name: agentgateway-admin
spec:
  selector:
    app.kubernetes.io/name: agentgateway
    gateway.networking.k8s.io/gateway-name: agentgateway
  ports:
  - name: admin
    port: 15000
    targetPort: 15000
    protocol: TCP
  type: ClusterIP
---
#| HTTPRoute for agentgateway admin UI #|
#| Routes all traffic for mcp-gw hostname to admin interface #|
#| Admin UI calls /config, /config_dump, /ui, /api, etc. at root level #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: agentgateway-ui
spec:
  parentRefs:
  - name: agentgateway
    namespace: agentgateway
    sectionName: https
  hostnames:
  - "mcp-gw.#{ primary_domain }#"
  rules:
  #| Route all paths to admin UI service #|
  - backendRefs:
    - name: agentgateway-admin
      port: 15000
---
#| MCP Backend for routing to MCP servers #|
#| Uses placeholder target - configure actual MCP servers as needed #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: Backend
metadata:
  name: mcp-backend
spec:
  type: MCP
  mcp:
    targets:
    - name: placeholder
      static:
        host: localhost
        port: 9999
        protocol: HTTP
---
#| HTTPRoute for MCP traffic on port 8080 listener #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: mcp-route
spec:
  parentRefs:
  - name: agentgateway
    namespace: agentgateway
    sectionName: mcp
  rules:
  - backendRefs:
    - group: gateway.kgateway.dev
      kind: Backend
      name: mcp-backend
---
#| =========================================== #|
#| TrafficPolicy: Token-based Rate Limiting    #|
#| and Prompt Guards (Phase 2 + Phase 3)       #|
#| =========================================== #|
#| Comprehensive TrafficPolicy with token-based rate limiting and prompt guards #|
#| Token limits: 100K burst, 10K/min sustained for general traffic #|
#| Built-in guards: CREDIT_CARD (mask), SSN (reject), EMAIL (mask) #|
#| Custom regex: credential patterns (reject) #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: agentgateway-comprehensive
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: agentgateway
  #| Phase 2: Token-based rate limiting #|
  #| Limits token usage for LLM requests (more accurate than request count) #|
  rateLimit:
    local:
      tokenBucket:
        maxTokens: 100000        # Maximum burst capacity
        tokensPerFill: 10000     # Tokens added per interval
        fillInterval: "60s"      # Refill interval (1 minute)
  #| Phase 3: Prompt guards for sensitive data protection #|
  ai:
    promptGuard:
      #| Request guards - filter incoming prompts #|
      request:
        customResponseMessage: "Request blocked by security policy: contains sensitive data"
        #| Built-in pattern guards #|
        builtins:
          CREDIT_CARD:
            action: MASK         # Replace with [REDACTED]
          SSN:
            action: REJECT       # Block the request
          EMAIL:
            action: MASK         # Replace with [REDACTED]
          PHONE_NUMBER:
            action: MASK
          IP_ADDRESS:
            action: MASK
        #| Custom regex patterns for credential detection #|
        matches:
        - regex: "\\b(?:password|secret|api[_-]?key|token)\\s*[:=]\\s*\\S+"
          action: REJECT
          name: "credential-pattern"
        - regex: "\\b(?:BEGIN|END)\\s+(?:RSA|OPENSSH|PRIVATE)\\s+KEY"
          action: REJECT
          name: "private-key-pattern"
      #| Response guards - filter LLM outputs #|
      response:
        builtins:
          CREDIT_CARD:
            action: MASK
          SSN:
            action: MASK
          EMAIL:
            action: MASK
---
#| HTTPListenerPolicy for enhanced access logging #|
#| Includes AI-specific fields: tokens, cost, prompt guard actions #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: HTTPListenerPolicy
metadata:
  name: agentgateway-logging
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: agentgateway
  accessLog:
  - fileSink:
      path: /dev/stdout
      jsonFormat:
        #| Standard fields #|
        timestamp: "%START_TIME%"
        method: "%REQ(:METHOD)%"
        path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
        protocol: "%PROTOCOL%"
        responseCode: "%RESPONSE_CODE%"
        responseFlags: "%RESPONSE_FLAGS%"
        bytesReceived: "%BYTES_RECEIVED%"
        bytesSent: "%BYTES_SENT%"
        duration: "%DURATION%"
        upstreamHost: "%UPSTREAM_HOST%"
        userAgent: "%REQ(USER-AGENT)%"
        requestId: "%REQ(X-REQUEST-ID)%"
        authority: "%REQ(:AUTHORITY)%"
        #| AI-specific fields #|
        xAiModel: "%REQ(X-AI-EG-MODEL)%"
        #| Token usage and cost tracking (if available from backend) #|
        inputTokens: "%RESP(X-INPUT-TOKENS)%"
        outputTokens: "%RESP(X-OUTPUT-TOKENS)%"
        costUsd: "%RESP(X-COST-USD)%"
        #| Prompt guard action tracking #|
        promptGuardAction: "%RESP(X-PROMPT-GUARD-ACTION)%"
#% if azure_openai_us_east_api_key %#
---
#| ============================================= #|
#| Azure OpenAI US East AI Backend Configuration #|
#| ============================================= #|
#| Backend with type: AI for Azure OpenAI US East #|
#| Supports chat models (gpt-4.1, gpt-4.1-nano, gpt-4o-mini) #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: Backend
metadata:
  name: azure-openai-us-east
  labels:
    provider: azure-openai
    region: us-east
spec:
  type: AI
  ai:
    llm:
      azureopenai:
        endpoint: "#{ azure_openai_us_east_resource_name }#.openai.azure.com"
        deploymentName: "gpt-4.1"
        apiVersion: "2025-01-01-preview"
      authToken:
        kind: SecretRef
        secretRef:
          name: azure-openai-us-east-secret
      authHeader:
        headerName: api-key
        prefix: ""
---
#| HTTPRoute for Azure OpenAI US East chat completions #|
#| Routes ai-gw.domain/v1/chat/completions to Azure OpenAI #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: azure-openai-us-east-route
spec:
  parentRefs:
  - name: agentgateway
    namespace: agentgateway
    sectionName: https
  hostnames:
  - "ai-gw.#{ primary_domain }#"
  rules:
  #| Route chat completions to Azure OpenAI US East based on x-ai-eg-model header #|
  - matches:
    - path:
        type: PathPrefix
        value: /v1/chat/completions
      headers:
      - name: x-ai-eg-model
        type: Exact
        value: "gpt-4.1"
    - path:
        type: PathPrefix
        value: /v1/chat/completions
      headers:
      - name: x-ai-eg-model
        type: Exact
        value: "gpt-4.1-nano"
    - path:
        type: PathPrefix
        value: /v1/chat/completions
      headers:
      - name: x-ai-eg-model
        type: Exact
        value: "gpt-4o-mini"
    backendRefs:
    - group: gateway.kgateway.dev
      kind: Backend
      name: azure-openai-us-east
  #| Route reasoning models (o3, o4-mini) to Azure OpenAI US East #|
  - matches:
    - path:
        type: PathPrefix
        value: /v1/chat/completions
      headers:
      - name: x-ai-eg-model
        type: Exact
        value: "o3"
    - path:
        type: PathPrefix
        value: /v1/chat/completions
      headers:
      - name: x-ai-eg-model
        type: Exact
        value: "o4-mini"
    backendRefs:
    - group: gateway.kgateway.dev
      kind: Backend
      name: azure-openai-us-east
  #| Route embedding requests to Azure OpenAI US East #|
  - matches:
    - path:
        type: PathPrefix
        value: /v1/embeddings
      headers:
      - name: x-ai-eg-model
        type: Exact
        value: "text-embedding-3-small"
    - path:
        type: PathPrefix
        value: /v1/embeddings
      headers:
      - name: x-ai-eg-model
        type: Exact
        value: "text-embedding-ada-002"
    backendRefs:
    - group: gateway.kgateway.dev
      kind: Backend
      name: azure-openai-us-east
#% endif %#
#% if azure_openai_us_east2_api_key %#
---
#| ============================================== #|
#| Azure OpenAI US East2 AI Backend Configuration #|
#| ============================================== #|
#| Backend with type: AI for Azure OpenAI US East2 #|
#| Supports chat models (gpt-5, gpt-5-nano, etc.) #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: Backend
metadata:
  name: azure-openai-us-east2
  labels:
    provider: azure-openai
    region: us-east2
spec:
  type: AI
  ai:
    llm:
      azureopenai:
        endpoint: "#{ azure_openai_us_east2_resource_name }#.openai.azure.com"
        deploymentName: "gpt-5"
        apiVersion: "2025-01-01-preview"
      authToken:
        kind: SecretRef
        secretRef:
          name: azure-openai-us-east2-secret
      authHeader:
        headerName: api-key
        prefix: ""
---
#| HTTPRoute for Azure OpenAI US East2 chat completions #|
#| Routes ai-gw.domain/v1/chat/completions to Azure OpenAI US East2 #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: azure-openai-us-east2-route
spec:
  parentRefs:
  - name: agentgateway
    namespace: agentgateway
    sectionName: https
  hostnames:
  - "ai-gw.#{ primary_domain }#"
  rules:
  #| Route GPT-5 models to Azure OpenAI US East2 #|
  - matches:
    - path:
        type: PathPrefix
        value: /v1/chat/completions
      headers:
      - name: x-ai-eg-model
        type: Exact
        value: "gpt-5"
    - path:
        type: PathPrefix
        value: /v1/chat/completions
      headers:
      - name: x-ai-eg-model
        type: Exact
        value: "gpt-5-nano"
    - path:
        type: PathPrefix
        value: /v1/chat/completions
      headers:
      - name: x-ai-eg-model
        type: Exact
        value: "gpt-5-mini"
    - path:
        type: PathPrefix
        value: /v1/chat/completions
      headers:
      - name: x-ai-eg-model
        type: Exact
        value: "gpt-5.1"
    backendRefs:
    - group: gateway.kgateway.dev
      kind: Backend
      name: azure-openai-us-east2
  #| Route thinking models (gpt-5-chat, gpt-5.1-chat) to Azure OpenAI US East2 #|
  - matches:
    - path:
        type: PathPrefix
        value: /v1/chat/completions
      headers:
      - name: x-ai-eg-model
        type: Exact
        value: "gpt-5-chat"
    - path:
        type: PathPrefix
        value: /v1/chat/completions
      headers:
      - name: x-ai-eg-model
        type: Exact
        value: "gpt-5.1-chat"
    backendRefs:
    - group: gateway.kgateway.dev
      kind: Backend
      name: azure-openai-us-east2
  #| Route codex models to Azure OpenAI US East2 #|
  - matches:
    - path:
        type: PathPrefix
        value: /v1/chat/completions
      headers:
      - name: x-ai-eg-model
        type: Exact
        value: "gpt-5.1-codex"
    - path:
        type: PathPrefix
        value: /v1/chat/completions
      headers:
      - name: x-ai-eg-model
        type: Exact
        value: "gpt-5.1-codex-mini"
    backendRefs:
    - group: gateway.kgateway.dev
      kind: Backend
      name: azure-openai-us-east2
  #| Route text-embedding-3-large to Azure OpenAI US East2 #|
  - matches:
    - path:
        type: PathPrefix
        value: /v1/embeddings
      headers:
      - name: x-ai-eg-model
        type: Exact
        value: "text-embedding-3-large"
    backendRefs:
    - group: gateway.kgateway.dev
      kind: Backend
      name: azure-openai-us-east2
#% endif %#
#% endif %#