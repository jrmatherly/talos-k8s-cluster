#% if keycloak_enabled %#
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: keycloak
spec:
  chart:
    spec:
      chart: keycloak
      version: "18.10.0"
      sourceRef:
        kind: HelmRepository
        name: codecentric
  interval: 1h
  timeout: 15m
  values:
    # ============================================================
    # Image Configuration - Use official Keycloak image
    # ============================================================
    image:
      repository: quay.io/keycloak/keycloak
      tag: "26.0.7"

    # ============================================================
    # Replicas for HA
    # ============================================================
    replicas: #{ keycloak_replicas | default(2) }#

    # ============================================================
    # Command - Run in production mode
    # ============================================================
    command:
      - "/opt/keycloak/bin/kc.sh"
      - "start"
      - "--hostname-strict=false"
      - "--http-enabled=true"

    # ============================================================
    # PostgreSQL Database - Disabled (using external CloudNativePG)
    # ============================================================
    postgresql:
      enabled: false

    # ============================================================
    # Database Configuration via Environment Variables
    # ============================================================
    extraEnv: |
      - name: KC_DB
        value: postgres
      - name: KC_DB_URL_HOST
        value: keycloak-db-rw.keycloak.svc.cluster.local
      - name: KC_DB_URL_PORT
        value: "5432"
      - name: KC_DB_URL_DATABASE
        value: keycloak
      - name: KC_DB_USERNAME
        value: keycloak
      - name: KC_DB_PASSWORD
        valueFrom:
          secretKeyRef:
            name: keycloak-db-secret
            key: password
      - name: KEYCLOAK_ADMIN
        value: admin
      - name: KEYCLOAK_ADMIN_PASSWORD
        valueFrom:
          secretKeyRef:
            name: keycloak-secret
            key: admin-password
      - name: KC_HOSTNAME
        value: "auth.${SECRET_DOMAIN}"
      - name: KC_PROXY_HEADERS
        value: "xforwarded"
      - name: KC_HTTP_ENABLED
        value: "true"
      - name: KC_HEALTH_ENABLED
        value: "true"
      - name: KC_METRICS_ENABLED
        value: "true"

    # ============================================================
    # Service Configuration
    # ============================================================
    service:
      type: ClusterIP
      httpPort: 8080
      httpsPort: 8443

    # ============================================================
    # Resource Limits
    # ============================================================
    resources:
      requests:
        cpu: "#{ keycloak_cpu_request | default('250m') }#"
        memory: "#{ keycloak_memory_request | default('512Mi') }#"
      limits:
        cpu: "#{ keycloak_cpu_limit | default('1000m') }#"
        memory: "#{ keycloak_memory_limit | default('1Gi') }#"

    # ============================================================
    # Startup/Liveness/Readiness Probes (Quarkus health endpoints)
    # ============================================================
    startupProbe: |
      httpGet:
        path: /health/started
        port: http
      initialDelaySeconds: 30
      timeoutSeconds: 5
      periodSeconds: 10
      failureThreshold: 30

    livenessProbe: |
      httpGet:
        path: /health/live
        port: http
      initialDelaySeconds: 0
      timeoutSeconds: 5
      periodSeconds: 10
      failureThreshold: 3

    readinessProbe: |
      httpGet:
        path: /health/ready
        port: http
      initialDelaySeconds: 10
      timeoutSeconds: 5
      periodSeconds: 10
      failureThreshold: 3

    # ============================================================
    # Metrics for Prometheus - ServiceMonitor
    # ============================================================
    serviceMonitor:
      enabled: true
      namespace: keycloak
      labels:
        release: kube-prometheus-stack
      path: /metrics
      port: http

    # ============================================================
    # Security Context
    # ============================================================
    securityContext:
      fsGroup: 1000

    podSecurityContext:
      runAsUser: 1000
      runAsNonRoot: true
#% endif %#
