#% if keycloak_enabled %#
---
# ConfigMap containing the k8s-cluster realm configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-realm-config
data:
  k8s-cluster-realm.json: |
    {
      "realm": "k8s-cluster",
      "enabled": true,
      "displayName": "Kubernetes Cluster",
      "displayNameHtml": "<strong>Kubernetes Cluster</strong>",
      "sslRequired": "external",
      "registrationAllowed": false,
      "loginWithEmailAllowed": true,
      "duplicateEmailsAllowed": false,
      "resetPasswordAllowed": true,
      "editUsernameAllowed": false,
      "bruteForceProtected": true,
      "permanentLockout": false,
      "maxFailureWaitSeconds": 900,
      "minimumQuickLoginWaitSeconds": 60,
      "waitIncrementSeconds": 60,
      "quickLoginCheckMilliSeconds": 1000,
      "maxDeltaTimeSeconds": 43200,
      "failureFactor": 5,
      "defaultSignatureAlgorithm": "RS256",
      "accessTokenLifespan": 300,
      "accessTokenLifespanForImplicitFlow": 900,
      "ssoSessionIdleTimeout": 1800,
      "ssoSessionMaxLifespan": 36000,
      "offlineSessionIdleTimeout": 2592000,
      "accessCodeLifespan": 60,
      "accessCodeLifespanUserAction": 300,
      "accessCodeLifespanLogin": 1800,
      "actionTokenGeneratedByAdminLifespan": 43200,
      "actionTokenGeneratedByUserLifespan": 300,
      "clients": [
        {
          "clientId": "account",
          "name": "Account Management",
          "enabled": true,
          "publicClient": true,
          "standardFlowEnabled": true,
          "directAccessGrantsEnabled": false,
          "redirectUris": [
            "https://auth.#{primary_domain}#/realms/k8s-cluster/account/*"
          ],
          "webOrigins": ["*"],
          "attributes": {}
        },
        {
          "clientId": "account-console",
          "name": "Account Console",
          "enabled": true,
          "publicClient": true,
          "standardFlowEnabled": true,
          "directAccessGrantsEnabled": false,
          "redirectUris": [
            "https://auth.#{primary_domain}#/realms/k8s-cluster/account/*"
          ],
          "webOrigins": ["*"],
          "attributes": {
            "pkce.code.challenge.method": "S256"
          }
        },
        {
          "clientId": "kgateway",
          "name": "kgateway OIDC Client",
          "description": "OIDC client for kgateway SecurityPolicy authentication",
          "enabled": true,
          "clientAuthenticatorType": "client-secret",
          "secret": "#{keycloak_oidc_client_secret}#",
          "redirectUris": [
            "https://sso.#{primary_domain}#/oauth2/redirect"
          ],
          "webOrigins": [
            "https://*.#{primary_domain}#"
          ],
          "protocol": "openid-connect",
          "publicClient": false,
          "bearerOnly": false,
          "consentRequired": false,
          "standardFlowEnabled": true,
          "implicitFlowEnabled": false,
          "directAccessGrantsEnabled": false,
          "serviceAccountsEnabled": false,
          "authorizationServicesEnabled": false,
          "fullScopeAllowed": true,
          "defaultClientScopes": [
            "web-origins",
            "profile",
            "roles",
            "email"
          ],
          "optionalClientScopes": [
            "address",
            "phone",
            "offline_access"
          ],
          "attributes": {
            "pkce.code.challenge.method": "S256",
            "post.logout.redirect.uris": "https://*.#{primary_domain}#/*"
          }
        }#% if agentgateway_enabled %#,
        {
          "clientId": "agentgateway-mcp",
          "name": "agentgateway MCP OAuth Client",
          "description": "OAuth client for agentgateway MCP authentication proxy - MCP 2025-11-25 compliant",
          "enabled": true,
          "clientAuthenticatorType": "client-secret",
          "secret": "#{keycloak_agentgateway_client_secret | default(keycloak_oidc_client_secret)}#",
          "redirectUris": [
            "https://mcp-gw.#{primary_domain}#/*",
            "https://ai-gw.#{primary_domain}#/*",
            "http://localhost:*",
            "http://127.0.0.1:*"
          ],
          "webOrigins": [
            "https://mcp-gw.#{primary_domain}#",
            "https://ai-gw.#{primary_domain}#",
            "https://*.#{primary_domain}#",
            "http://localhost",
            "http://127.0.0.1"
          ],
          "protocol": "openid-connect",
          "publicClient": false,
          "bearerOnly": false,
          "consentRequired": false,
          "standardFlowEnabled": true,
          "implicitFlowEnabled": false,
          "directAccessGrantsEnabled": false,
          "serviceAccountsEnabled": true,
          "authorizationServicesEnabled": false,
          "fullScopeAllowed": true,
          "defaultClientScopes": [
            "web-origins",
            "profile",
            "roles",
            "email",
            "offline_access",
            "mcp:tools"
          ],
          "optionalClientScopes": [
            "address",
            "phone"
          ],
          "protocolMappers": [
            {
              "name": "mcp-resource-audience",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-audience-mapper",
              "consentRequired": false,
              "config": {
                "included.client.audience": "",
                "included.custom.audience": "https://mcp-gw.#{primary_domain}#/mcp",
                "id.token.claim": "true",
                "access.token.claim": "true"
              }
            }
          ],
          "attributes": {
            "pkce.code.challenge.method": "S256",
            "post.logout.redirect.uris": "https://mcp-gw.#{primary_domain}#/*++https://ai-gw.#{primary_domain}#/*",
            "oauth2.device.authorization.grant.enabled": "true",
            "backchannel.logout.session.required": "true",
            "display.on.consent.screen": "false"
          }
        }#% endif %##% if obot_keycloak_enabled | default(false) %#,
        {
          "clientId": "#{obot_keycloak_client_id | default('obot')}#",
          "name": "obot AI Agent Platform",
          "description": "OIDC client for obot AI agent platform authentication",
          "enabled": true,
          "clientAuthenticatorType": "client-secret",
          "secret": "#{obot_keycloak_client_secret}#",
          "redirectUris": [
            "https://#{obot_hostname | default('obot')}#.#{primary_domain}#/oauth2/callback",
            "https://#{obot_hostname | default('obot')}#.#{primary_domain}#/*"
          ],
          "webOrigins": [
            "https://#{obot_hostname | default('obot')}#.#{primary_domain}#",
            "https://*.#{primary_domain}#"
          ],
          "protocol": "openid-connect",
          "publicClient": false,
          "bearerOnly": false,
          "consentRequired": false,
          "standardFlowEnabled": true,
          "implicitFlowEnabled": false,
          "directAccessGrantsEnabled": false,
          "serviceAccountsEnabled": false,
          "authorizationServicesEnabled": false,
          "fullScopeAllowed": true,
          "defaultClientScopes": [
            "web-origins",
            "profile",
            "roles",
            "email",
            "openid"
          ],
          "optionalClientScopes": [
            "address",
            "phone",
            "offline_access"
          ],
          "protocolMappers": [
            {
              "name": "obot-audience",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-audience-mapper",
              "consentRequired": false,
              "config": {
                "included.client.audience": "#{obot_keycloak_client_id | default('obot')}#",
                "id.token.claim": "true",
                "access.token.claim": "true"
              }
            },
            {
              "name": "email-verified",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-attribute-mapper",
              "consentRequired": false,
              "config": {
                "user.attribute": "emailVerified",
                "claim.name": "email_verified",
                "jsonType.label": "boolean",
                "id.token.claim": "true",
                "access.token.claim": "true",
                "userinfo.token.claim": "true"
              }
            }
          ],
          "attributes": {
            "pkce.code.challenge.method": "S256",
            "post.logout.redirect.uris": "https://#{obot_hostname | default('obot')}#.#{primary_domain}#/*",
            "backchannel.logout.session.required": "true",
            "display.on.consent.screen": "false"
          }
        }#% endif %#
      ],
      "roles": {
        "realm": [
          {
            "name": "admin",
            "description": "Cluster administrator with full access",
            "composite": false
          },
          {
            "name": "developer",
            "description": "Developer with limited cluster access",
            "composite": false
          },
          {
            "name": "viewer",
            "description": "Read-only access to cluster resources",
            "composite": false
          }
        ]
      },
      "groups": [
        {
          "name": "cluster-admins",
          "path": "/cluster-admins",
          "realmRoles": ["admin"]
        },
        {
          "name": "developers",
          "path": "/developers",
          "realmRoles": ["developer"]
        },
        {
          "name": "viewers",
          "path": "/viewers",
          "realmRoles": ["viewer"]
        }
      ],
      "scopeMappings": [],
      "clientScopeMappings": {},
      "clientScopes": [
#% if agentgateway_enabled %#
        {
          "name": "mcp:tools",
          "description": "MCP Tool Server Access - Enables RFC 8707 audience restriction for MCP clients",
          "protocol": "openid-connect",
          "attributes": {
            "include.in.token.scope": "true",
            "display.on.consent.screen": "true",
            "consent.screen.text": "Access to MCP tool servers"
          },
          "protocolMappers": [
            {
              "name": "mcp-resource-audience",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-audience-mapper",
              "consentRequired": false,
              "config": {
                "included.client.audience": "",
                "included.custom.audience": "https://mcp-gw.#{primary_domain}#/mcp",
                "id.token.claim": "true",
                "access.token.claim": "true"
              }
            }
          ]
        }
#% endif %#
      ]#% set has_idp = (keycloak_entra_id_enabled and keycloak_entra_id_tenant_id and keycloak_entra_id_client_id and keycloak_entra_id_client_secret) or (keycloak_google_enabled and keycloak_google_client_id and keycloak_google_client_secret) or (keycloak_github_enabled and keycloak_github_client_id and keycloak_github_client_secret) %##% if has_idp %#,
      "identityProviders": [
        #% set idp_list = [] %#
        #% if keycloak_entra_id_enabled and keycloak_entra_id_tenant_id and keycloak_entra_id_client_id and keycloak_entra_id_client_secret %#
        #% set _ = idp_list.append('entra-id') %#
        {
          "alias": "entra-id",
          "displayName": "Microsoft Entra ID",
          "providerId": "oidc",
          "enabled": true,
          "trustEmail": true,
          "storeToken": false,
          "addReadTokenRoleOnCreate": false,
          "linkOnly": false,
          "firstBrokerLoginFlowAlias": "first broker login",
          "config": {
            "useJwksUrl": "true",
            "syncMode": "FORCE",
            "clientAuthMethod": "client_secret_post",
            "clientId": "#{keycloak_entra_id_client_id}#",
            "clientSecret": "$$(env:ENTRA_ID_CLIENT_SECRET)",
            "defaultScope": "openid profile email",
            "authorizationUrl": "https://login.microsoftonline.com/#{keycloak_entra_id_tenant_id}#/oauth2/v2.0/authorize",
            "tokenUrl": "https://login.microsoftonline.com/#{keycloak_entra_id_tenant_id}#/oauth2/v2.0/token",
            "logoutUrl": "https://login.microsoftonline.com/#{keycloak_entra_id_tenant_id}#/oauth2/v2.0/logout",
            "jwksUrl": "https://login.microsoftonline.com/#{keycloak_entra_id_tenant_id}#/discovery/v2.0/keys",
            "userInfoUrl": "https://graph.microsoft.com/oidc/userinfo",
            "issuer": "https://login.microsoftonline.com/#{keycloak_entra_id_tenant_id}#/v2.0",
            "validateSignature": "true",
            "pkceEnabled": "true",
            "pkceMethod": "S256"
          }
        }#% if (keycloak_google_enabled and keycloak_google_client_id and keycloak_google_client_secret) or (keycloak_github_enabled and keycloak_github_client_id and keycloak_github_client_secret) %#,#% endif %#
        #% endif %#
        #% if keycloak_google_enabled and keycloak_google_client_id and keycloak_google_client_secret %#
        #% set _ = idp_list.append('google') %#
        {
          "alias": "google",
          "displayName": "Google",
          "providerId": "google",
          "enabled": true,
          "trustEmail": true,
          "storeToken": false,
          "addReadTokenRoleOnCreate": false,
          "linkOnly": false,
          "firstBrokerLoginFlowAlias": "first broker login",
          "config": {
            "clientId": "#{keycloak_google_client_id}#",
            "clientSecret": "$$(env:GOOGLE_CLIENT_SECRET)",
            "defaultScope": "openid profile email",
            "syncMode": "FORCE"
          }
        }#% if keycloak_github_enabled and keycloak_github_client_id and keycloak_github_client_secret %#,#% endif %#
        #% endif %#
        #% if keycloak_github_enabled and keycloak_github_client_id and keycloak_github_client_secret %#
        #% set _ = idp_list.append('github') %#
        {
          "alias": "github",
          "displayName": "GitHub",
          "providerId": "github",
          "enabled": true,
          "trustEmail": true,
          "storeToken": false,
          "addReadTokenRoleOnCreate": false,
          "linkOnly": false,
          "firstBrokerLoginFlowAlias": "first broker login",
          "config": {
            "clientId": "#{keycloak_github_client_id}#",
            "clientSecret": "$$(env:GITHUB_CLIENT_SECRET)",
            "defaultScope": "user:email read:org",
            "syncMode": "FORCE"
          }
        }
        #% endif %#
      ],
      "identityProviderMappers": [
        #% set mapper_list = [] %#
        #| === Entra ID Mappers === #|
        #% if keycloak_entra_id_enabled and keycloak_entra_id_tenant_id and keycloak_entra_id_client_id and keycloak_entra_id_client_secret %#
        {
          "name": "entra-id-email",
          "identityProviderAlias": "entra-id",
          "identityProviderMapper": "oidc-user-attribute-idp-mapper",
          "config": {
            "syncMode": "INHERIT",
            "claim": "email",
            "user.attribute": "email"
          }
        },
        {
          "name": "entra-id-first-name",
          "identityProviderAlias": "entra-id",
          "identityProviderMapper": "oidc-user-attribute-idp-mapper",
          "config": {
            "syncMode": "INHERIT",
            "claim": "given_name",
            "user.attribute": "firstName"
          }
        },
        {
          "name": "entra-id-last-name",
          "identityProviderAlias": "entra-id",
          "identityProviderMapper": "oidc-user-attribute-idp-mapper",
          "config": {
            "syncMode": "INHERIT",
            "claim": "family_name",
            "user.attribute": "lastName"
          }
        },
        {
          "name": "entra-id-username",
          "identityProviderAlias": "entra-id",
          "identityProviderMapper": "oidc-username-idp-mapper",
          "config": {
            "syncMode": "INHERIT",
            "template": "$${CLAIM.preferred_username}"
          }
        },
        {
          "name": "entra-id-manage-account-role",
          "identityProviderAlias": "entra-id",
          "identityProviderMapper": "oidc-hardcoded-role-idp-mapper",
          "config": {
            "syncMode": "FORCE",
            "role": "account.manage-account"
          }
        },
        {
          "name": "entra-id-view-profile-role",
          "identityProviderAlias": "entra-id",
          "identityProviderMapper": "oidc-hardcoded-role-idp-mapper",
          "config": {
            "syncMode": "FORCE",
            "role": "account.view-profile"
          }
        }#% if (keycloak_google_enabled and keycloak_google_client_id and keycloak_google_client_secret) or (keycloak_github_enabled and keycloak_github_client_id and keycloak_github_client_secret) %#,#% endif %#
        #% endif %#
        #| === Google Mappers === #|
        #| Note: Use oidc-user-attribute-idp-mapper (not google-user-attribute-mapper) #|
        #| The google-specific mapper was deprecated in Keycloak 26.x                  #|
        #% if keycloak_google_enabled and keycloak_google_client_id and keycloak_google_client_secret %#
        {
          "name": "google-email",
          "identityProviderAlias": "google",
          "identityProviderMapper": "oidc-user-attribute-idp-mapper",
          "config": {
            "syncMode": "INHERIT",
            "claim": "email",
            "user.attribute": "email"
          }
        },
        {
          "name": "google-first-name",
          "identityProviderAlias": "google",
          "identityProviderMapper": "oidc-user-attribute-idp-mapper",
          "config": {
            "syncMode": "INHERIT",
            "claim": "given_name",
            "user.attribute": "firstName"
          }
        },
        {
          "name": "google-last-name",
          "identityProviderAlias": "google",
          "identityProviderMapper": "oidc-user-attribute-idp-mapper",
          "config": {
            "syncMode": "INHERIT",
            "claim": "family_name",
            "user.attribute": "lastName"
          }
        },
        {
          "name": "google-manage-account-role",
          "identityProviderAlias": "google",
          "identityProviderMapper": "oidc-hardcoded-role-idp-mapper",
          "config": {
            "syncMode": "FORCE",
            "role": "account.manage-account"
          }
        },
        {
          "name": "google-view-profile-role",
          "identityProviderAlias": "google",
          "identityProviderMapper": "oidc-hardcoded-role-idp-mapper",
          "config": {
            "syncMode": "FORCE",
            "role": "account.view-profile"
          }
        }#% if keycloak_github_enabled and keycloak_github_client_id and keycloak_github_client_secret %#,#% endif %#
        #% endif %#
        #| === GitHub Mappers === #|
        #% if keycloak_github_enabled and keycloak_github_client_id and keycloak_github_client_secret %#
        {
          "name": "github-email",
          "identityProviderAlias": "github",
          "identityProviderMapper": "github-user-attribute-mapper",
          "config": {
            "syncMode": "INHERIT",
            "jsonField": "email",
            "userAttribute": "email"
          }
        },
        {
          "name": "github-username",
          "identityProviderAlias": "github",
          "identityProviderMapper": "github-user-attribute-mapper",
          "config": {
            "syncMode": "INHERIT",
            "jsonField": "login",
            "userAttribute": "username"
          }
        },
        {
          "name": "github-name",
          "identityProviderAlias": "github",
          "identityProviderMapper": "github-user-attribute-mapper",
          "config": {
            "syncMode": "INHERIT",
            "jsonField": "name",
            "userAttribute": "firstName"
          }
        },
        {
          "name": "github-manage-account-role",
          "identityProviderAlias": "github",
          "identityProviderMapper": "oidc-hardcoded-role-idp-mapper",
          "config": {
            "syncMode": "FORCE",
            "role": "account.manage-account"
          }
        },
        {
          "name": "github-view-profile-role",
          "identityProviderAlias": "github",
          "identityProviderMapper": "oidc-hardcoded-role-idp-mapper",
          "config": {
            "syncMode": "FORCE",
            "role": "account.view-profile"
          }
        }
        #% endif %#
      ]
#% endif %#
    }
---
# Job to import the realm configuration using keycloak-config-cli
apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-realm-import-v23
  annotations:
    # Re-create job with new name when config changes (jobs are immutable)
    config-version: "23"
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/component: realm-import
    spec:
      restartPolicy: OnFailure
      containers:
        - name: keycloak-config-cli
          image: quay.io/adorsys/keycloak-config-cli:latest-26
          env:
            - name: KEYCLOAK_URL
              value: "http://keycloak-http.keycloak.svc.cluster.local:8080"
            - name: KEYCLOAK_USER
              value: "admin"
            - name: KEYCLOAK_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-secret
                  key: admin-password
            - name: KEYCLOAK_AVAILABILITYCHECK_ENABLED
              value: "true"
            - name: KEYCLOAK_AVAILABILITYCHECK_TIMEOUT
              value: "120s"
            - name: IMPORT_VARSUBSTITUTION_ENABLED
              value: "true"
#% if keycloak_entra_id_enabled and keycloak_entra_id_client_secret %#
            - name: ENTRA_ID_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: keycloak-secret
                  key: entra-id-client-secret
#% endif %#
#% if keycloak_google_enabled and keycloak_google_client_secret %#
            - name: GOOGLE_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: keycloak-secret
                  key: google-client-secret
#% endif %#
#% if keycloak_github_enabled and keycloak_github_client_secret %#
            - name: GITHUB_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: keycloak-secret
                  key: github-client-secret
#% endif %#
            #| Use no-delete to preserve built-in clients (account, account-console) #|
            - name: IMPORT_MANAGED_CLIENT
              value: "no-delete"
            - name: IMPORT_MANAGED_GROUP
              value: "full"
            - name: IMPORT_MANAGED_ROLE
              value: "full"
            #| Use full for IDP mappers to clean up old/invalid mappers #|
            - name: IMPORT_MANAGED_IDENTITY_PROVIDER_MAPPER
              value: "full"
            - name: IMPORT_FILES_LOCATIONS
              value: "/config/*"
          volumeMounts:
            - name: realm-config
              mountPath: /config
              readOnly: true
      volumes:
        - name: realm-config
          configMap:
            name: keycloak-realm-config
#% endif %#
