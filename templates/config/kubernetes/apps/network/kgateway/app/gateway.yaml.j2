#% if kgateway_enabled | default(true) %#
---
#| ============================================================ #|
#| GatewayParameters for kgateway (Envoy data plane)            #|
#| Kubernetes deployment settings for Envoy proxies             #|
#| ============================================================ #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: GatewayParameters
metadata:
  name: kgateway-params
spec:
  kube:
    deployment:
      replicas: 2
    envoyContainer:
      image:
        repository: mirror.gcr.io/envoyproxy/envoy
      resources:
        requests:
          cpu: 100m
        limits:
          memory: 1Gi
    service:
      type: LoadBalancer
      externalTrafficPolicy: Cluster
---
#| ============================================================ #|
#| GatewayClass for kgateway (Envoy data plane)                  #|
#| Controller: kgateway.dev/kgateway                             #|
#| ============================================================ #|
apiVersion: gateway.networking.k8s.io/v1
kind: GatewayClass
metadata:
  name: kgateway
spec:
  controllerName: kgateway.dev/kgateway
  description: "kgateway for HTTP traffic using Envoy data plane"
  parametersRef:
    group: gateway.kgateway.dev
    kind: GatewayParameters
    name: kgateway-params
    namespace: network
---
#| ============================================================ #|
#| External Gateway - Cloudflare Tunnel (192.168.22.130)         #|
#| Handles external traffic via Cloudflare                       #|
#| ============================================================ #|
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: external
  annotations:
    external-dns.alpha.kubernetes.io/target: external.${SECRET_DOMAIN}
spec:
  gatewayClassName: kgateway
  infrastructure:
    annotations:
      external-dns.alpha.kubernetes.io/hostname: external.${SECRET_DOMAIN}
      lbipam.cilium.io/ips: "#{ cloudflare_gateway_addr }#"
  listeners:
    - name: http
      protocol: HTTP
      port: 80
      allowedRoutes:
        namespaces:
          from: Same
    - name: https
      protocol: HTTPS
      port: 443
      allowedRoutes:
        namespaces:
          from: All
      tls:
        certificateRefs:
#% for domain in cloudflare_domains %#
          - kind: Secret
            name: #{ domain | replace('.', '-') }#-production-tls
#% endfor %#
---
#| ============================================================ #|
#| Internal Gateway - Local network (192.168.22.140)             #|
#| Handles internal HTTP traffic                                 #|
#| ============================================================ #|
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: internal
  annotations:
    external-dns.alpha.kubernetes.io/target: internal.${SECRET_DOMAIN}
spec:
  gatewayClassName: kgateway
  infrastructure:
    annotations:
      external-dns.alpha.kubernetes.io/hostname: internal.${SECRET_DOMAIN}
      lbipam.cilium.io/ips: "#{ cluster_gateway_addr }#"
  listeners:
    - name: http
      protocol: HTTP
      port: 80
      allowedRoutes:
        namespaces:
          from: Same
    - name: https
      protocol: HTTPS
      port: 443
      allowedRoutes:
        namespaces:
          from: All
      tls:
        certificateRefs:
#% for domain in cloudflare_domains %#
          - kind: Secret
            name: #{ domain | replace('.', '-') }#-production-tls
#% endfor %#
---
#| ============================================================ #|
#| TrafficPolicy for HTTP traffic                                #|
#| Compression, buffer limits, timeouts, retry, health checks    #|
#| ============================================================ #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: kgateway-traffic
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: external
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: internal
  #| Connection settings #|
  connectionConfig:
    connectTimeout: 10s
    #| Buffer limits for request/response bodies (8Mi) #|
    perConnectionBufferLimitBytes: 8388608
  #| Request timeout (0 = unlimited for streaming) #|
  requestTimeout: 0s
  #| Retry policy for transient failures #|
  retries:
    retryOn: "connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes"
    numRetries: 2
    perTryTimeout: 30s
    retryBackOff:
      baseInterval: 1s
      maxInterval: 10s
  #| Passive health checking (outlier detection) #|
  outlierDetection:
    consecutive5xxErrors: 5
    consecutiveGatewayErrors: 3
    interval: 10s
    baseEjectionTime: 30s
---
#| ============================================================ #|
#| HTTPListenerPolicy for HTTP/2 and access logging              #|
#| ============================================================ #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: HTTPListenerPolicy
metadata:
  name: kgateway-listener
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: external
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: internal
  accessLog:
    - fileSink:
        path: /dev/stdout
        jsonFormat:
          timestamp: "%START_TIME%"
          method: "%REQ(:METHOD)%"
          path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
          protocol: "%PROTOCOL%"
          responseCode: "%RESPONSE_CODE%"
          responseFlags: "%RESPONSE_FLAGS%"
          bytesReceived: "%BYTES_RECEIVED%"
          bytesSent: "%BYTES_SENT%"
          duration: "%DURATION%"
          upstreamHost: "%UPSTREAM_HOST%"
          userAgent: "%REQ(USER-AGENT)%"
          requestId: "%REQ(X-REQUEST-ID)%"
          authority: "%REQ(:AUTHORITY)%"
---
#| ============================================================ #|
#| HTTP to HTTPS redirect                                        #|
#| ============================================================ #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: https-redirect
  annotations:
    external-dns.alpha.kubernetes.io/controller: none
spec:
  parentRefs:
    - name: external
      namespace: network
      sectionName: http
    - name: internal
      namespace: network
      sectionName: http
  rules:
    - filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301
---
#| ============================================================ #|
#| kgateway Admin UI Service                                     #|
#| Exposes controller admin/metrics on port 9091                 #|
#| ============================================================ #|
apiVersion: v1
kind: Service
metadata:
  name: kgateway-admin
  labels:
    app.kubernetes.io/name: kgateway-admin
spec:
  selector:
    app.kubernetes.io/name: kgateway
  ports:
    - name: admin
      port: 9091
      targetPort: 9091
      protocol: TCP
  type: ClusterIP
---
#| ============================================================ #|
#| HTTPRoute to expose kgateway Admin UI via internal gateway    #|
#| ============================================================ #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: kgateway-admin-ui
  annotations:
    external-dns.alpha.kubernetes.io/controller: none
spec:
  parentRefs:
    - name: internal
      namespace: network
      sectionName: https
  hostnames:
    - "kgateway-ui.${SECRET_DOMAIN}"
  rules:
    - backendRefs:
        - name: kgateway-admin
          port: 9091
#% endif %#
