#% if kgateway_enabled | default(true) %#
#% if kgateway_oauth2_enabled | default(false) and keycloak_enabled and keycloak_oidc_client_secret %#
---
#| ============================================================ #|
#| GatewayExtension - OAuth2 with Keycloak OIDC                 #|
#| Implements OAuth2 authorization code flow with PKCE          #|
#| Ref: https://docs.kgateway.dev/main/security/access-control/oauth2/ #|
#| ============================================================ #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: GatewayExtension
metadata:
  name: keycloak-oauth2
spec:
  type: OAuth2
  oauth2:
    #| Keycloak OIDC issuer URL - enables auto-discovery of endpoints #|
    issuerURI: "https://auth.#{ primary_domain }#/realms/k8s-cluster"
    #| Backend reference to Keycloak service for token exchange #|
    backendRef:
      name: keycloak-http
      namespace: keycloak
      port: 8080
    #| Client credentials from Secret #|
    credentials:
      clientID: "kgateway"
      clientSecretRef:
        name: keycloak-oidc-credentials
    #| OAuth2 scopes to request #|
    scopes:
      - openid
      - profile
      - email
    #| Forward access token to backend services #|
    forwardAccessToken: true
    #| Logout path for RP-Initiated Logout #|
    logoutPath: "/logout"
    #| End session endpoint for single logout #|
    endSessionEndpoint: "https://auth.#{ primary_domain }#/realms/k8s-cluster/protocol/openid-connect/logout"
#% if keycloak_oidc_cookie_domain %#
    #| Cookie configuration for cross-subdomain SSO #|
    cookies:
      domain: "#{ keycloak_oidc_cookie_domain }#"
      sameSite: Lax
#% endif %#
    #| Deny redirect for AJAX requests (return 401 instead) #|
    denyRedirect:
      headers:
        - name: "X-Requested-With"
          value: "XMLHttpRequest"
---
#| ============================================================ #|
#| TrafficPolicy - Apply OAuth2 to internal Gateway             #|
#| All routes through internal Gateway will require OAuth2      #|
#| ============================================================ #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: kgateway-internal-oauth2
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: internal
  oauth2:
    extensionRef:
      name: keycloak-oauth2
      namespace: network
#% endif %#
#% endif %#
