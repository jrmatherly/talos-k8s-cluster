#% if kgateway_enabled | default(true) %#
#% if kgateway_oauth2_enabled | default(false) and keycloak_enabled and keycloak_oidc_client_secret %#
---
#| ============================================================ #|
#| GatewayExtension - OAuth2 with Keycloak OIDC                 #|
#| Implements OAuth2 authorization code flow with PKCE          #|
#| Ref: https://docs.kgateway.dev/main/security/access-control/oauth2/ #|
#| ============================================================ #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: GatewayExtension
metadata:
  name: keycloak-oauth2
spec:
  type: OAuth2
  oauth2:
    #| Keycloak OIDC issuer URL - enables auto-discovery of endpoints #|
    issuerURI: "https://auth.#{ primary_domain }#/realms/k8s-cluster"
    #| Single dedicated callback endpoint for all OAuth2 flows        #|
    #| Keycloak doesn't support subdomain wildcards, so we use a      #|
    #| single redirect URI for all services behind the internal GW    #|
    redirectURI: "https://sso.#{ primary_domain }#/oauth2/redirect"
    #| Backend reference to Keycloak service for token exchange #|
    backendRef:
      name: keycloak-http
      namespace: keycloak
      port: 8080
    #| Client credentials from Secret #|
    credentials:
      clientID: "kgateway"
      clientSecretRef:
        name: keycloak-oidc-credentials
    #| OAuth2 scopes to request #|
    scopes:
      - openid
      - profile
      - email
    #| Forward access token to backend services #|
    forwardAccessToken: true
    #| Logout path for RP-Initiated Logout #|
    logoutPath: "/logout"
    #| End session endpoint for single logout #|
    endSessionEndpoint: "https://auth.#{ primary_domain }#/realms/k8s-cluster/protocol/openid-connect/logout"
#% if keycloak_oidc_cookie_domain %#
    #| Cookie configuration for cross-subdomain SSO #|
    cookies:
      domain: "#{ keycloak_oidc_cookie_domain }#"
      sameSite: Lax
#% endif %#
    #| Deny redirect for AJAX requests (return 401 instead) #|
    denyRedirect:
      headers:
        - name: "X-Requested-With"
          value: "XMLHttpRequest"
---
#| ============================================================ #|
#| TrafficPolicy - Apply OAuth2 to internal Gateway             #|
#| All routes through internal Gateway will require OAuth2      #|
#| ============================================================ #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: kgateway-internal-oauth2
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: internal
  oauth2:
    extensionRef:
      name: keycloak-oauth2
      namespace: network
---
#| ============================================================ #|
#| HTTPRoute - SSO Callback Endpoint                            #|
#| Dedicated endpoint for OAuth2 callback handling              #|
#| Keycloak doesn't support subdomain wildcards, so all OAuth2  #|
#| flows use this single callback URL                           #|
#| ============================================================ #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: sso-callback
spec:
  hostnames:
    - sso.#{ primary_domain }#
  parentRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: internal
      namespace: network
      sectionName: https
  rules:
    #| OAuth2 callback path - intercepted by OAuth2 extension    #|
    #| The extension processes /oauth2/redirect before routing   #|
    - matches:
        - path:
            type: PathPrefix
            value: /oauth2/redirect
      backendRefs:
        #| Dummy backend - never reached for OAuth2 callbacks    #|
        - name: keycloak-http
          namespace: keycloak
          port: 8080
    #| Root path - redirect to Keycloak account page             #|
    - matches:
        - path:
            type: PathPrefix
            value: /
      filters:
        - type: RequestRedirect
          requestRedirect:
            hostname: auth.#{ primary_domain }#
            path:
              type: ReplaceFullPath
              replaceFullPath: /realms/k8s-cluster/account
            statusCode: 302
#% endif %#
#% endif %#
