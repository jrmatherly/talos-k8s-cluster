#% if kgateway_enabled | default(true) and keycloak_enabled %#
---
#| ============================================================ #|
#| OIDC Infrastructure for kgateway                              #|
#| Provides OAuth2/OIDC protection available for HTTPRoutes      #|
#| NOT applied to any routes by default                          #|
#| ============================================================ #|

#| Backend for Keycloak OIDC endpoints #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: Backend
metadata:
  name: keycloak-oidc
spec:
  type: Static
  static:
    hosts:
      - host: "auth.#{ primary_domain }#"
        port: 443
---
#| BackendTLSPolicy for Keycloak OIDC #|
apiVersion: gateway.networking.k8s.io/v1
kind: BackendTLSPolicy
metadata:
  name: keycloak-oidc-tls
spec:
  targetRefs:
    - group: gateway.kgateway.dev
      kind: Backend
      name: keycloak-oidc
  validation:
    hostname: "auth.#{ primary_domain }#"
    wellKnownCACertificates: System
---
#| GatewayExtension for Keycloak OIDC configuration #|
#| Can be referenced by TrafficPolicy for route protection #|
#| REF: https://kgateway.dev/docs/guides/oidc/ #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: GatewayExtension
metadata:
  name: keycloak-oidc
spec:
  oauth2:
    backendRef:
      kind: Backend
      group: gateway.kgateway.dev
      name: keycloak-oidc
    issuerURI: "https://auth.#{ primary_domain }#/realms/k8s-cluster"
    credentials:
      clientID: "kgateway"
      clientSecretRef:
        name: kgateway-oidc-secret
    #| Redirect URI must match client configuration in Keycloak #|
    redirectURI: "https://*.#{ primary_domain }#/oauth2/callback"
    logoutPath: /logout
    forwardAccessToken: true
    scopes:
      - openid
      - profile
      - email
---
#| Secret for OIDC client credentials #|
#| Uses the existing Keycloak client secret or dedicated kgateway secret #|
apiVersion: v1
kind: Secret
metadata:
  name: kgateway-oidc-secret
type: Opaque
stringData:
  client-secret: "#{ keycloak_kgateway_client_secret | default(keycloak_oidc_client_secret) }#"
---
#| ============================================================ #|
#| Example TrafficPolicy for OIDC protection (NOT APPLIED)       #|
#| To protect a route, create a TrafficPolicy targeting it       #|
#| ============================================================ #|
#| To apply OIDC protection to an HTTPRoute, create:             #|
#|                                                               #|
#| apiVersion: gateway.kgateway.dev/v1alpha1                     #|
#| kind: TrafficPolicy                                           #|
#| metadata:                                                     #|
#|   name: my-route-oidc                                         #|
#| spec:                                                         #|
#|   targetRefs:                                                 #|
#|     - group: gateway.networking.k8s.io                        #|
#|       kind: HTTPRoute                                         #|
#|       name: my-route                                          #|
#|   oauth2:                                                     #|
#|     extensionRef:                                             #|
#|       name: keycloak-oidc                                     #|
#| ============================================================ #|
#% endif %#
