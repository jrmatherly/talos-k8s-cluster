#| MCP Gateway SecurityPolicy for JWT Validation #|
#| Validates JWT tokens issued by Keycloak for MCP authorization #|
#% if mcp_gateway_enabled %#
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: mcp-jwt-auth
  namespace: network
  labels:
    gateway-type: mcp
    app.kubernetes.io/part-of: mcp-gateway
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: envoy-mcp
  jwt:
    providers:
      - name: keycloak
        issuer: https://auth.#{ primary_domain }#/realms/#{ keycloak_realm | default('k8s-cluster') }#
        remoteJWKS:
          uri: https://auth.#{ primary_domain }#/realms/#{ keycloak_realm | default('k8s-cluster') }#/protocol/openid-connect/certs
        claimToHeaders:
          - header: x-jwt-sub
            claim: sub
          - header: x-jwt-email
            claim: email
          - header: x-jwt-scope
            claim: scope
          - header: x-jwt-azp
            claim: azp
        audiences:
          - mcp-gateway
---
#| Rate limiting for MCP Gateway to prevent abuse #|
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: BackendTrafficPolicy
metadata:
  name: mcp-ratelimit
  namespace: network
  labels:
    gateway-type: mcp
    app.kubernetes.io/part-of: mcp-gateway
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: envoy-mcp
  rateLimit:
    type: Local
    local:
      rules:
        #| Standard API rate limit per client #|
        - clientSelectors:
            - headers:
                - name: x-jwt-sub
                  type: Distinct
          limit:
            requests: #{ mcp_rate_limit_requests | default(100) }#
            unit: Minute
        #| Fallback rate limit for unauthenticated requests #|
        - limit:
            requests: 10
            unit: Minute
---
#| CORS policy for MCP Gateway #|
#| Allows browser-based MCP clients to access the gateway #|
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: mcp-cors
  namespace: network
  labels:
    gateway-type: mcp
    app.kubernetes.io/part-of: mcp-gateway
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: envoy-mcp
  cors:
    allowOrigins:
#% for domain in cloudflare_domains %#
      - type: Exact
        value: "https://*.#{ domain }#"
#% endfor %#
    allowMethods:
      - GET
      - POST
      - OPTIONS
    allowHeaders:
      - Authorization
      - Content-Type
      - X-Requested-With
      - X-MCP-Session-ID
    exposeHeaders:
      - X-MCP-Session-ID
      - X-Request-ID
    maxAge: 86400s
    allowCredentials: true
#% endif %#
