#| Unified OIDC SecurityPolicy using Keycloak as the identity provider #|
#| All identity providers (Google, Entra, GitHub) are federated through Keycloak #|
#| Requires mcp_gateway_enabled=true for Keycloak deployment #|
#|                                                                               #|
#| Architecture:                                                                 #|
#| - Keycloak UI accessible at auth.<domain> via envoy-auth gateway              #|
#| - Both envoy-internal and envoy-external use auth.<domain> for callbacks      #|
#| - Split DNS routes internal clients to envoy-internal, external via cloudflare#|
#% if oidc_enabled and mcp_gateway_enabled %#
---
#| ============================================================================ #|
#| ENVOY-INTERNAL OIDC CONFIGURATION                                            #|
#| ============================================================================ #|
#| SecurityPolicy for envoy-internal gateway #|
#| Protects all apps on envoy-internal with Keycloak OIDC authentication #|
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: oidc-keycloak-internal
  labels:
    app.kubernetes.io/part-of: auth-system
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: envoy-internal
  oidc:
    provider:
      issuer: https://auth.#{ primary_domain }#/realms/#{ keycloak_realm | default('k8s-cluster') }#
    clientID: envoy-gateway
    clientSecret:
      name: keycloak-oidc-client-secret
    #| Callback URL - same hostname for both gateways, split DNS handles routing #|
    redirectURL: https://auth.#{ primary_domain }#/oauth2/callback
    logoutPath: /logout
    scopes:
      - openid
      - profile
      - email
    refreshToken: true
    forwardAccessToken: true
    cookieDomain: #{ oidc_cookie_domain | default(primary_domain) }#
---
#| HTTPRoute for OIDC callback on envoy-internal #|
#| Envoy Gateway intercepts /oauth2/callback and handles the token exchange #|
#| Split DNS routes internal clients to this gateway for auth.<domain> #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: oidc-callback-internal
  annotations:
    #| Prevent external-dns from creating external records #|
    #| auth.<domain> is handled by split DNS pointing to internal gateway #|
    external-dns.alpha.kubernetes.io/controller: none
spec:
  parentRefs:
    - name: envoy-internal
      namespace: network
      sectionName: https
  hostnames:
    - auth.#{ primary_domain }#
  rules:
    #| Match /oauth2/* paths - OIDC filter intercepts these #|
    - matches:
        - path:
            type: PathPrefix
            value: /oauth2/
      backendRefs:
        #| Placeholder backend - requests never reach this; OIDC filter intercepts #|
        - name: oidc-callback-placeholder
          port: 80
---
#| ============================================================================ #|
#| ENVOY-EXTERNAL OIDC CONFIGURATION                                            #|
#| ============================================================================ #|
#| SecurityPolicy for envoy-external gateway #|
#| Protects all apps on envoy-external with Keycloak OIDC authentication #|
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: oidc-keycloak-external
  labels:
    app.kubernetes.io/part-of: auth-system
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: envoy-external
  oidc:
    provider:
      issuer: https://auth.#{ primary_domain }#/realms/#{ keycloak_realm | default('k8s-cluster') }#
    clientID: envoy-gateway
    clientSecret:
      name: keycloak-oidc-client-secret
    #| Callback URL - same hostname for both gateways, cloudflared routes external #|
    redirectURL: https://auth.#{ primary_domain }#/oauth2/callback
    logoutPath: /logout
    scopes:
      - openid
      - profile
      - email
    refreshToken: true
    forwardAccessToken: true
    cookieDomain: #{ oidc_cookie_domain | default(primary_domain) }#
---
#| HTTPRoute for OIDC callback on envoy-external #|
#| Handles /oauth2/* paths for external OIDC callback #|
#| External clients reach this via cloudflared tunnel #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: oidc-callback-external
  annotations:
    #| External DNS creates record pointing to cloudflared tunnel #|
    external-dns.alpha.kubernetes.io/target: external.#{ primary_domain }#
spec:
  parentRefs:
    - name: envoy-external
      namespace: network
      sectionName: https
  hostnames:
    - auth.#{ primary_domain }#
  rules:
    #| Match /oauth2/* paths - OIDC filter intercepts these #|
    - matches:
        - path:
            type: PathPrefix
            value: /oauth2/
      backendRefs:
        #| Placeholder backend - requests never reach this; OIDC filter intercepts #|
        - name: oidc-callback-placeholder
          port: 80
---
#| ============================================================================ #|
#| SHARED PLACEHOLDER SERVICE                                                    #|
#| ============================================================================ #|
#| Placeholder service for OIDC callback routes #|
#| The OAuth2 filter intercepts callback requests before they reach any backend #|
apiVersion: v1
kind: Service
metadata:
  name: oidc-callback-placeholder
  labels:
    app.kubernetes.io/part-of: auth-system
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: http
      port: 80
      targetPort: 80
#% endif %#
