---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: envoy-gateway
spec:
  chartRef:
    kind: OCIRepository
    name: envoy-gateway
  interval: 1h
  values:
    global:
      imageRegistry: mirror.gcr.io
    config:
      envoyGateway:
        provider:
          type: Kubernetes
          kubernetes:
            deploy:
              type: GatewayNamespace
#% if ai_gateway_enabled and ai_gateway_ratelimit_enabled %#
            # Rate limit deployment configuration for AI Gateway
            rateLimitDeployment:
              patch:
                type: StrategicMerge
                value:
                  spec:
                    template:
                      spec:
                        containers:
                          - name: envoy-ratelimit
                            imagePullPolicy: IfNotPresent
        # Global rate limit backend (Redis)
        rateLimit:
          backend:
            type: Redis
            redis:
              url: redis.#{ ai_gateway_namespace }#.svc.cluster.local:6379
#% endif %#
