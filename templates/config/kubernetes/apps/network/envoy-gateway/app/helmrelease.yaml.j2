---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: envoy-gateway
spec:
  chartRef:
    kind: OCIRepository
    name: envoy-gateway
  interval: 1h
  values:
    global:
      imageRegistry: mirror.gcr.io
    config:
      envoyGateway:
#% if ai_gateway_enabled %#
        # Enable extension APIs for AI Gateway
        # - enableBackend: Required for routing to external backends (Backend CRD)
        # - enableEnvoyPatchPolicy: Required for AI Gateway to inject ext_proc filter
        extensionApis:
          enableBackend: true
          enableEnvoyPatchPolicy: true
        # Extension manager for AI Gateway to hook into xDS translation
        # This allows AI Gateway controller to inject ext_proc filter for request/response transformation
        extensionManager:
          hooks:
            xdsTranslator:
              translation:
                listener:
                  includeAll: true
                route:
                  includeAll: true
                cluster:
                  includeAll: true
                secret:
                  includeAll: true
              post:
                - Translation
                - Cluster
                - Route
          service:
            fqdn:
              hostname: ai-gateway-controller.#{ ai_gateway_namespace }#.svc.cluster.local
              port: 1063
#% endif %#
        provider:
          type: Kubernetes
          kubernetes:
            deploy:
              type: GatewayNamespace
#% if ai_gateway_enabled and ai_gateway_ratelimit_enabled %#
            # Rate limit deployment configuration for AI Gateway
            rateLimitDeployment:
              patch:
                type: StrategicMerge
                value:
                  spec:
                    template:
                      spec:
                        containers:
                          - name: envoy-ratelimit
                            imagePullPolicy: IfNotPresent
        # Global rate limit backend (Redis)
        rateLimit:
          backend:
            type: Redis
            redis:
              url: redis.#{ ai_gateway_namespace }#.svc.cluster.local:6379
#% endif %#
