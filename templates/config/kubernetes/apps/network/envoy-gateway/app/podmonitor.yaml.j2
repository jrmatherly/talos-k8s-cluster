---
# PodMonitor for Envoy proxy instances (data plane metrics)
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: envoy-proxy
spec:
  jobLabel: envoy-proxy
  namespaceSelector:
    matchNames:
      - network
  podMetricsEndpoints:
    - port: metrics
      path: /stats/prometheus
      honorLabels: true
      # Relabel to add gateway name for easier filtering
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_label_gateway_envoyproxy_io_owning_gateway_name]
          targetLabel: gateway
        - sourceLabels: [__meta_kubernetes_pod_label_gateway_envoyproxy_io_owning_gateway_namespace]
          targetLabel: gateway_namespace
  selector:
    matchLabels:
      app.kubernetes.io/component: proxy
      app.kubernetes.io/name: envoy
---
# ServiceMonitor for Envoy Gateway controller (control plane metrics)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: envoy-gateway-controller
spec:
  jobLabel: envoy-gateway
  namespaceSelector:
    matchNames:
      - network
  endpoints:
    - port: metrics
      path: /metrics
      honorLabels: true
  selector:
    matchLabels:
      app.kubernetes.io/instance: envoy-gateway
      app.kubernetes.io/name: gateway-helm
---
# PrometheusRule for AI Gateway alerting
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: envoy-gateway-alerts
  labels:
    release: kube-prometheus-stack
spec:
  groups:
    - name: envoy-gateway.rules
      rules:
        # Alert when AI Gateway has high error rate (5xx responses)
        - alert: EnvoyAIGatewayHighErrorRate
          expr: |
            (
              sum(rate(envoy_cluster_upstream_rq_xx{envoy_response_code_class="5", envoy_cluster_name=~".*ai-system.*"}[5m])) by (envoy_cluster_name)
              /
              sum(rate(envoy_cluster_upstream_rq_total{envoy_cluster_name=~".*ai-system.*"}[5m])) by (envoy_cluster_name)
            ) > 0.1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High error rate on AI Gateway cluster {{ $labels.envoy_cluster_name }}"
            description: "Error rate is {{ $value | humanizePercentage }} for cluster {{ $labels.envoy_cluster_name }}"

        # Alert when upstream connection failures occur
        - alert: EnvoyAIGatewayConnectionFailures
          expr: |
            sum(rate(envoy_cluster_upstream_cx_connect_fail{envoy_cluster_name=~".*ai-system.*"}[5m])) by (envoy_cluster_name) > 0.5
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Connection failures to AI backend {{ $labels.envoy_cluster_name }}"
            description: "{{ $value }} connection failures per second to {{ $labels.envoy_cluster_name }}"

        # Alert when circuit breaker trips (outlier detection)
        - alert: EnvoyAIGatewayCircuitBreakerTripped
          expr: |
            envoy_cluster_outlier_detection_ejections_enforced_total{envoy_cluster_name=~".*ai-system.*"} > 0
          for: 1m
          labels:
            severity: warning
          annotations:
            summary: "Circuit breaker tripped for AI backend {{ $labels.envoy_cluster_name }}"
            description: "Backend {{ $labels.envoy_cluster_name }} has been ejected due to health check failures"

        # Alert when request latency is high (p99 > 30s for AI workloads)
        - alert: EnvoyAIGatewayHighLatency
          expr: |
            histogram_quantile(0.99,
              sum(rate(envoy_cluster_upstream_rq_time_bucket{envoy_cluster_name=~".*ai-system.*"}[5m])) by (le, envoy_cluster_name)
            ) > 30000
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High latency on AI Gateway cluster {{ $labels.envoy_cluster_name }}"
            description: "P99 latency is {{ $value | humanizeDuration }} for cluster {{ $labels.envoy_cluster_name }}"

        # Alert when MCP Gateway has errors
        - alert: EnvoyMCPGatewayErrors
          expr: |
            sum(rate(envoy_http_downstream_rq_xx{envoy_response_code_class="5", envoy_http_conn_manager_prefix=~".*mcp.*"}[5m])) > 0.1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "MCP Gateway returning errors"
            description: "MCP Gateway has {{ $value }} 5xx errors per second"

    - name: envoy-gateway-controller.rules
      rules:
        # Alert when controller is down
        - alert: EnvoyGatewayControllerDown
          expr: |
            up{job="envoy-gateway"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Envoy Gateway controller is down"
            description: "The Envoy Gateway controller has been down for more than 5 minutes"

        # Alert when Envoy proxy pods are not ready
        - alert: EnvoyProxyNotReady
          expr: |
            kube_pod_status_ready{namespace="network", pod=~"envoy-.*-.*", condition="true"} == 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Envoy proxy pod {{ $labels.pod }} is not ready"
            description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has been not ready for 5 minutes"
