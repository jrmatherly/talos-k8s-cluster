#% if kgateway_enabled | default(true) %#
---
#| ============================================================ #|
#| CiliumNetworkPolicy for kgateway controller                  #|
#| Purpose: Allow kgateway controller to communicate with Kubernetes API server #|
#| ============================================================ #|
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: kgateway-kube-api-egress
  namespace: network
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: kgateway
  egress:
    - toEntities:
        - kube-apiserver
      toPorts:
        - ports:
            - port: "6443"
              protocol: TCP
---
#| ============================================================ #|
#| CiliumNetworkPolicy for kgateway proxies                     #|
#| Purpose: Allow kgateway proxies to accept LoadBalancer and backend traffic #|
#| CRITICAL: Must use Cilium native entities for traffic with socket-based LB #|
#| ============================================================ #|
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: kgateway-proxies-world-ingress
  namespace: network
spec:
  endpointSelector:
    matchExpressions:
      - key: gateway.networking.k8s.io/gateway-name
        operator: In
        values: ["external", "internal"]
  ingress:
    #| LoadBalancer traffic from external/internal clients #|
    - fromEntities:
        - world
      toPorts:
        - ports:
            - port: "80"
              protocol: TCP
            - port: "443"
              protocol: TCP
            - port: "8080"
              protocol: TCP
            - port: "8443"
              protocol: TCP
            - port: "10080"
              protocol: TCP
            - port: "10443"
              protocol: TCP
  egress:
    #| Backend traffic to cluster services #|
    - toEntities:
        - cluster
    #| External backends (e.g., OAuth providers, external APIs) #|
    - toEntities:
        - world
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
---
#| ============================================================ #|
#| NetworkPolicy for kgateway controller                        #|
#| Purpose: Restrict traffic to kgateway controller pod         #|
#| ============================================================ #|
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: kgateway-controller
  namespace: network
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: kgateway
  policyTypes:
    - Ingress
    - Egress
  ingress:
    #| Allow xDS connections from kgateway proxy pods #|
    - from:
        - podSelector:
            matchExpressions:
              - key: gateway.networking.k8s.io/gateway-name
                operator: In
                values: ["external", "internal"]
      ports:
        - protocol: TCP
          port: 9977   # xDS
#% if observability_enabled %#
    #| Allow Prometheus scraping #|
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: observability
      ports:
        - protocol: TCP
          port: 9091
#% endif %#
    #| Kubelet probes #|
    - from:
        - ipBlock:
            cidr: #{ node_cidr }#
      ports:
        - protocol: TCP
          port: 8081
  egress:
    # DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
#| ============================================================ #|
#| NetworkPolicy for kgateway proxy pods (external, internal)   #|
#| Purpose: Allow LoadBalancer and backend traffic to proxies   #|
#| ============================================================ #|
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: kgateway-proxies
  namespace: network
spec:
  podSelector:
    matchExpressions:
      - key: gateway.networking.k8s.io/gateway-name
        operator: In
        values: ["external", "internal"]
  policyTypes:
    - Ingress
    - Egress
  ingress:
    #| Allow LoadBalancer traffic #|
    - from:
        - ipBlock:
            cidr: 0.0.0.0/0
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 8443
        - protocol: TCP
          port: 10080
        - protocol: TCP
          port: 10443
    #| Allow from cloudflare-tunnel #|
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: cloudflare-tunnel
      ports:
        - protocol: TCP
          port: 8443
        - protocol: TCP
          port: 10443
#% if observability_enabled %#
    #| Prometheus metrics #|
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: observability
      ports:
        - protocol: TCP
          port: 19001
        - protocol: TCP
          port: 15000
#% endif %#
    #| Kubelet probes #|
    - from:
        - ipBlock:
            cidr: #{ node_cidr }#
      ports:
        - protocol: TCP
          port: 19001
  egress:
    #| DNS #|
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    #| xDS to kgateway controller #|
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: kgateway
      ports:
        - protocol: TCP
          port: 9977
    #| Backend traffic to all namespaces #|
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
    #| External backends #|
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443
#% endif %#
---
#| ============================================================ #|
#| CiliumNetworkPolicy for cloudflare-dns - Kubernetes API access #|
#| Purpose: Allow cloudflare-dns to access Kubernetes API server  #|
#| ============================================================ #|
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: cloudflare-dns-kube-api-egress
  namespace: network
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: external-dns
  egress:
    - toEntities:
        - kube-apiserver
      toPorts:
        - ports:
            - port: "6443"
              protocol: TCP
---
#| ============================================================ #|
#| CiliumNetworkPolicy for k8s-gateway - Kubernetes API access  #|
#| Purpose: Allow k8s-gateway to access Kubernetes API server   #|
#| ============================================================ #|
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: k8s-gateway-kube-api-egress
  namespace: network
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: k8s-gateway
  egress:
    - toEntities:
        - kube-apiserver
      toPorts:
        - ports:
            - port: "6443"
              protocol: TCP
---
#| ============================================================ #|
#| NetworkPolicy for cloudflare-dns (external-dns)                #|
#| Purpose: Allow external-dns to access Kubernetes API server   #|
#| ============================================================ #|
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cloudflare-dns
  namespace: network
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: external-dns
  policyTypes:
    - Ingress
    - Egress
  ingress:
#% if observability_enabled %#
    # Prometheus metrics
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: observability
      ports:
        - protocol: TCP
          port: 7979
#% endif %#
    # Kubelet probes
    - from:
        - ipBlock:
            cidr: #{ node_cidr }#
      ports:
        - protocol: TCP
          port: 7979  # Health/metrics
  egress:
    # DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Note: Kubernetes API access handled by CiliumNetworkPolicy
    # Cloudflare API
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443
---
#| ============================================================ #|
#| CiliumNetworkPolicy for cloudflare-tunnel - Egress to external/world #|
#| Purpose: Allow cloudflare-tunnel to reach LoadBalancer IPs and Cloudflare edge #|
#| CRITICAL: Standard NetworkPolicy ipBlock doesn't work reliably for external IPs with Cilium socket-based LB #|
#| Must use Cilium's native toEntities: world for traffic to LoadBalancer IPs and external services        #|
#| ============================================================ #|
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: cloudflare-tunnel-world-egress
  namespace: network
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: cloudflare-tunnel
  egress:
    #| Allow egress to world (external IPs including LoadBalancer IPs and Cloudflare edge) #|
    #| This is required for Cloudflare Tunnel to reach external services and LoadBalancer IPs #|
    - toEntities:
        - world
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
            - port: "7844"
              protocol: UDP
#% if envoy_gateway_enabled | default(false) %#
---
#| ============================================================ #|
#| CiliumNetworkPolicy for Envoy proxies - Ingress from world (LoadBalancer traffic) #|
#| CRITICAL: Must use Cilium's native fromEntities: world for LoadBalancer service traffic #|
#| ============================================================ #|
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: envoy-proxies-world-ingress
  namespace: network
spec:
  endpointSelector:
    matchLabels:
      gateway.envoyproxy.io/owning-gateway-namespace: network
  ingress:
    #| Allow ingress from world on both service ports (pre-DNAT) and container ports (post-DNAT) #|
    #| Includes both TCP and UDP for HTTP/3 (QUIC) support                                #|
    - fromEntities:
        - world
      toPorts:
        - ports:
            - port: "80"
              protocol: TCP
            - port: "443"
              protocol: TCP
            - port: "443"
              protocol: UDP
            - port: "10080"
              protocol: TCP
            - port: "10443"
              protocol: TCP
            - port: "10443"
              protocol: UDP
#% endif %#
---
#| ============================================================ #|
#| NetworkPolicy for cloudflare-tunnel (DNS and external access) #|
#| ============================================================ #|
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cloudflare-tunnel
  namespace: network
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: cloudflare-tunnel
  policyTypes:
    - Ingress
    - Egress
  ingress:
#% if observability_enabled %#
    #| Prometheus metrics - allow observability namespace to scrape metrics #|
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: observability
      ports:
        - protocol: TCP
          port: 8080
#% endif %#
    #| Kubelet probes - allow node CIDR to probe health checks #|
    - from:
        - ipBlock:
            cidr: #{ node_cidr }#
      ports:
        - protocol: TCP
          port: 8080
  egress:
    #| DNS - allow kube-dns resolution #|
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Pod-to-pod traffic to kgateway external proxy (fallback for non-service traffic)
    - to:
        - podSelector:
            matchLabels:
              gateway.networking.k8s.io/gateway-name: external
      ports:
        - protocol: TCP
          port: 10443   # Container port (HTTPS)
        - protocol: TCP
          port: 8443    # Alternate HTTPS container port
    # kgateway external LoadBalancer IP (tunnel config uses external hostname)
    # Required because Cilium socket-based LB blocks ClusterIP service traffic before policy evaluation
    - to:
        - ipBlock:
            cidr: #{ cloudflare_gateway_addr }#/32
      ports:
        - protocol: TCP
          port: 443
    # Cloudflare edge network (tunnel connection)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443
        - protocol: UDP
          port: 7844  # QUIC tunnel
---
#| ============================================================ #|
#| CiliumNetworkPolicy for k8s-gateway - Ingress from world AND cluster (LoadBalancer DNS traffic) #|
#| CRITICAL: Standard NetworkPolicy ipBlock doesn't work for LoadBalancer IPs with Cilium socket-based LB #|
#| Must use Cilium's native fromEntities for DNS queries to LoadBalancer service                                #|
#| - world: External clients accessing via LoadBalancer IP                                                      #|
#| - cluster: Internal pods (e.g., CoreDNS) accessing via LoadBalancer IP for split-horizon DNS                 #|
#| CRITICAL: Must allow BOTH service port (53) AND container port (1053) due to Cilium socket-based LB          #|
#| ============================================================ #|
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: k8s-gateway-world-ingress
  namespace: network
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: k8s-gateway
  ingress:
    # Allow DNS queries from world (external clients via LoadBalancer)
    # Include both service port (pre-DNAT) and container port (post-DNAT)
    - fromEntities:
        - world
        - cluster
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
            - port: "53"
              protocol: TCP
            - port: "1053"
              protocol: UDP
            - port: "1053"
              protocol: TCP
---
#| ============================================================ #|
#| NetworkPolicy for k8s-gateway (split DNS)                    #|
#| ============================================================ #|
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: k8s-gateway
  namespace: network
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: k8s-gateway
  policyTypes:
    - Ingress
    - Egress
  ingress:
    #| Allow DNS queries from cluster (LoadBalancer) #|
    #| CRITICAL: Include both service port (53) AND container port (1053) for Cilium socket-based LB #|
    - from:
        - ipBlock:
            cidr: 0.0.0.0/0
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 1053
        - protocol: TCP
          port: 1053
#% if observability_enabled %#
    #| Prometheus metrics - allow observability namespace to scrape metrics #|
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: observability
      ports:
        - protocol: TCP
          port: 9153
#% endif %#
    #| Kubelet probes - allow node CIDR to probe health checks #|
    - from:
        - ipBlock:
            cidr: #{ node_cidr }#
      ports:
        - protocol: TCP
          port: 9153
  egress:
    #| DNS (upstream DNS servers) #|
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    #| Note: Kubernetes API access handled by CiliumNetworkPolicy #|
    #| External DNS servers (fallback) #|
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
        - protocol: TCP
          port: 443
