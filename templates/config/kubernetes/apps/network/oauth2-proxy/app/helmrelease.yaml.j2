#| OAuth2-Proxy HelmRelease for GitHub authentication #|
#| Uses external authorization (ext_authz) pattern with Envoy Gateway #|
#% if oidc_enabled and oidc_github_enabled %#
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: oauth2-proxy
spec:
  chartRef:
    kind: OCIRepository
    name: oauth2-proxy
  interval: 1h
  values:
    # ============================================================
    # OAuth2-Proxy Configuration
    # ============================================================
    config:
      clientID: "#{ oidc_github_client_id }#"
      cookieSecret: ""  # Auto-generated if empty
      configFile: |-
        provider = "github"
        email_domains = ["*"]
        cookie_secure = true
        cookie_samesite = "lax"
        cookie_httponly = true
        cookie_domains = [".#{ primary_domain }#"]
        whitelist_domains = [".#{ primary_domain }#"]
        set_xauthrequest = true
        set_authorization_header = true
        pass_access_token = true
        pass_authorization_header = true
        pass_user_headers = true
        skip_provider_button = true
        reverse_proxy = true
        # GitHub organization/team restrictions
        #% if oidc_github_org %#
        github_org = "#{ oidc_github_org }#"
        #% endif %#
        #% if oidc_github_team %#
        github_team = "#{ oidc_github_team }#"
        #% endif %#

    # Client secret from Kubernetes secret
    extraEnv:
      - name: OAUTH2_PROXY_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: oauth2-proxy-secret
            key: client-secret
      - name: OAUTH2_PROXY_COOKIE_SECRET
        valueFrom:
          secretKeyRef:
            name: oauth2-proxy-secret
            key: cookie-secret

    # ============================================================
    # Service Configuration
    # ============================================================
    service:
      type: ClusterIP
      portNumber: 4180

    # ============================================================
    # Resources
    # ============================================================
    resources:
      requests:
        cpu: 10m
        memory: 64Mi
      limits:
        memory: 128Mi

    # ============================================================
    # Replicas for HA
    # ============================================================
    replicaCount: 2

    # ============================================================
    # Pod Disruption Budget
    # ============================================================
    podDisruptionBudget:
      enabled: true
      minAvailable: 1

    # ============================================================
    # Ingress - Disabled (using Envoy Gateway HTTPRoute)
    # ============================================================
    ingress:
      enabled: false

    # ============================================================
    # Metrics
    # ============================================================
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        interval: 60s
#% endif %#
