#% if flux_web_enabled | default(false) %#
#% if kgateway_oauth2_enabled | default(false) and keycloak_enabled %#
---
#| ============================================================ #|
#| TrafficPolicy - Disable gateway-level OAuth2 for Flux Web UI #|
#| Flux Web UI has its own built-in OAuth2 authentication that  #|
#| conflicts with gateway-level OAuth2. This policy disables    #|
#| the gateway-wide external auth (which includes oauth2).      #|
#| Ref: https://kgateway.dev/docs/latest/traffic-management/route-delegation/inheritance/ #|
#| ============================================================ #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: flux-web-no-gateway-oauth2
  namespace: flux-system
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: flux-web
  #| extAuth.disable disables ALL external auth including OAuth2 #|
  #| Route-level policies take precedence over gateway-level     #|
  extAuth:
    disable: {}
#% endif %#
#% endif %#
