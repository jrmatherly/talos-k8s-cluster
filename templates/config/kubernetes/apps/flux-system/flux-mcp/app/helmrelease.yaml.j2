#% if flux_mcp_enabled | default(false) %#
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: flux-mcp
spec:
  #| Use flux-operator ServiceAccount for cluster-wide access #|
  serviceAccountName: flux-operator
  chartRef:
    kind: OCIRepository
    name: flux-mcp
  interval: 30m
  timeout: 10m
  values:
    # ============================================================
    # Server Configuration (top-level per chart schema)
    # ============================================================
    # Transport mode: sse (Server-Sent Events) or http (Streamable HTTP)
    transport: #{ flux_mcp_transport | default('http') }#
    # Read-only mode disables modification operations
    readonly: #{ flux_mcp_read_only | default(true) }#

    # ============================================================
    # NetworkPolicy (built-in chart feature)
    # ============================================================
    networkPolicy:
      ingress:
        namespaces:
          - flux-system
          - agentgateway-system
          - network

    # ============================================================
    # Pod Labels for CiliumNetworkPolicy matching
    # ============================================================
    podLabels:
      app.kubernetes.io/name: flux-mcp
      app.kubernetes.io/component: mcp-server
      # Label for AgentGateway dynamic MCP backend discovery
      agentgateway.dev/mcp: "true"
      # Label for CiliumClusterwideNetworkPolicy tiered policy matching
      network.cilium.io/api-access: "true"

    # ============================================================
    # Service Configuration
    # ============================================================
    service:
      # Labels for AgentGateway dynamic MCP backend discovery
      labels:
        agentgateway.dev/mcp: "true"

    # ============================================================
    # Resource Limits
    # ============================================================
    resources:
      requests:
        cpu: #{ flux_mcp_cpu_request | default('50m') }#
        memory: #{ flux_mcp_memory_request | default('128Mi') }#
      limits:
        cpu: #{ flux_mcp_cpu_limit | default('500m') }#
        memory: #{ flux_mcp_memory_limit | default('256Mi') }#
#% endif %#