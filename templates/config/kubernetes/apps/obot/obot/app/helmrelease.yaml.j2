#% if obot_enabled | default(false) %#
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: obot
spec:
  chart:
    spec:
      chart: ./kubernetes/apps/obot/obot/chart
      sourceRef:
        kind: GitRepository
        name: flux-system
        namespace: flux-system
      reconcileStrategy: Revision
  interval: 1h
  timeout: 15m
  values:
    # ============================================================
    # Image Configuration
    # ============================================================
    image:
      repository: ghcr.io/jrmatherly/obot-entraid
      pullPolicy: IfNotPresent

    # ============================================================
    # Replicas - Set to 1 for RWO storage
    # ============================================================
    replicaCount: #{ obot_replicas | default(1) }#

    # ============================================================
    # Service Configuration
    # ============================================================
    service:
      type: ClusterIP
      port: 8080

    # ============================================================
    # Ingress - Disabled (using Gateway API HTTPRoute instead)
    # ============================================================
    ingress:
      enabled: false

    # ============================================================
    # Configuration - All environment variables in one section
    # ============================================================
    config:
      # Server Hostname (CRITICAL: Required for OAuth callbacks and LLM proxying)
      OBOT_SERVER_HOSTNAME: "https://#{ obot_hostname | default('obot') }#.${SECRET_DOMAIN}"

      # Database Configuration
#% if obot_postgres_host | default('') %#
      OBOT_SERVER_DSN: "postgresql://#{ obot_postgres_user | default('obot') }#:${OBOT_DB_PASSWORD}@#{ obot_postgres_host }#:5432/#{ obot_postgres_db | default('obot') }#?sslmode=require"
#% else %#
      OBOT_SERVER_DSN: "postgresql://#{ obot_postgres_user | default('obot') }#:${OBOT_DB_PASSWORD}@obot-db-rw.obot.svc.cluster.local:5432/#{ obot_postgres_db | default('obot') }#?sslmode=require"
#% endif %#

      # MCP Runtime Configuration
      # Note: OBOT_SERVER_MCPNAMESPACE, OBOT_SERVER_SERVICE_NAME, and OBOT_SERVER_SERVICE_NAMESPACE
      # are automatically set by the chart when OBOT_SERVER_MCPRUNTIME_BACKEND is "kubernetes"
      OBOT_SERVER_MCPRUNTIME_BACKEND: "kubernetes"

      # Authentication
      OBOT_SERVER_ENABLE_AUTHENTICATION: "true"
#% if obot_admin_emails | default('') %#
      OBOT_SERVER_AUTH_ADMIN_EMAILS: "#{ obot_admin_emails }#"
#% endif %#
#% if obot_owner_emails | default('') %#
      OBOT_SERVER_AUTH_OWNER_EMAILS: "#{ obot_owner_emails }#"
#% endif %#
#% if obot_bootstrap_token | default('') %#
      OBOT_BOOTSTRAP_TOKEN: "${OBOT_BOOTSTRAP_TOKEN}"
#% endif %#

      # Entra ID OAuth Configuration
#% if obot_entra_tenant_id | default('') %#
      OBOT_SERVER_AUTH_PROVIDER: "entra-id"
      OBOT_SERVER_AUTH_ENTRA_TENANT_ID: "#{ obot_entra_tenant_id }#"
      OBOT_SERVER_AUTH_ENTRA_CLIENT_ID: "${OBOT_ENTRA_CLIENT_ID}"
      OBOT_SERVER_AUTH_ENTRA_CLIENT_SECRET: "${OBOT_ENTRA_CLIENT_SECRET}"
      OBOT_SERVER_AUTH_REDIRECT_URL: "https://#{ obot_hostname | default('obot') }#.${SECRET_DOMAIN}/oauth2/callback"
      # Token audience validation (security hardening - prevents token confusion attacks)
      OBOT_SERVER_AUTH_AUDIENCE: "${OBOT_ENTRA_CLIENT_ID}"
      OBOT_SERVER_AUTH_REQUIRED_CLAIMS: "email,preferred_username"
#% endif %#

      # Encryption Configuration
#% if obot_encryption_provider | default('custom') == 'custom' %#
      OBOT_SERVER_ENCRYPTION_PROVIDER: "custom"
      OBOT_SERVER_ENCRYPTION_KEY: "${OBOT_ENCRYPTION_KEY}"
#% endif %#

      # AI Gateway Integration
#% if obot_use_ai_gateway | default(true) %#
      OBOT_SERVER_LLM_BASE_URL: "https://llms.${SECRET_DOMAIN}/v1"
#% endif %#

    # ============================================================
    # Storage Configuration
    # ============================================================
    persistence:
      enabled: true
      storageClass: #{ obot_storage_class | default('proxmox-csi') }#
      size: #{ obot_storage_size | default('20Gi') }#
      accessMode: ReadWriteOnce

    # ============================================================
    # MCP Kubernetes Runtime Settings
    # ============================================================
    mcpNamespace:
      name: #{ obot_mcp_namespace | default('obot-mcp') }#
      create: false  # Created via Flux, not Helm

    mcpServerDefaults:
      resources:
        requests:
          cpu: "100m"
          memory: "256Mi"
        limits:
          cpu: "500m"
          memory: "512Mi"
      podSecurityContext:
        runAsNonRoot: true
        runAsUser: 65534
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL

    # ============================================================
    # Resource Limits
    # ============================================================
    resources:
      requests:
        cpu: "#{ obot_cpu_request | default('500m') }#"
        memory: "#{ obot_memory_request | default('1Gi') }#"
      limits:
        cpu: "#{ obot_cpu_limit | default('2000m') }#"
        memory: "#{ obot_memory_limit | default('4Gi') }#"

    # ============================================================
    # Security Context
    # ============================================================
    podSecurityContext:
      fsGroup: 1000

    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      capabilities:
        drop:
          - ALL

    # ============================================================
    # Probes
    # ============================================================
    livenessProbe:
      httpGet:
        path: /api/healthz
        port: 8080
      initialDelaySeconds: 60
      periodSeconds: 15
      failureThreshold: 5
      timeoutSeconds: 10

    readinessProbe:
      httpGet:
        path: /api/healthz
        port: 8080
      initialDelaySeconds: 30
      periodSeconds: 10
      failureThreshold: 3
      timeoutSeconds: 5

    # ============================================================
    # Existing Secret for Sensitive Configuration
    # ============================================================
    existingSecret: obot-config-secret

    # ============================================================
    # Service Account
    # ============================================================
    serviceAccount:
      create: true
      name: obot

    # ============================================================
    # RBAC for MCP Namespace
    # ============================================================
    rbac:
      create: true
#% endif %#
