#% if obot_enabled | default(false) %#
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: obot
spec:
  chartRef:
    kind: OCIRepository
    name: obot
  interval: 1h
  timeout: 15m
  values:
    # ============================================================
    # Image Configuration
    # ============================================================
    image:
      repository: ghcr.io/jrmatherly/obot-entraid
      tag: v#{ obot_version }#

    # ============================================================
    # Replicas - Limited to 1 with RWO storage, multiple with S3
    # ============================================================
    replicaCount: #{ obot_replicas | default(1) }#

    # ============================================================
    # Deployment Strategy
    # - Recreate: Required for RWO PVC (Multi-Attach errors with RollingUpdate)
    # - RollingUpdate: Can be used with S3 workspace storage
    # ============================================================
#% if obot_workspace_provider | default('directory') == 's3' %#
    updateStrategy: RollingUpdate
#% else %#
    updateStrategy: Recreate
#% endif %#

    # ============================================================
    # Service Configuration
    # Note: port 80 is required because MCP server token exchange URLs
    # are generated without explicit ports (defaulting to HTTP port 80)
    # The service routes port 80 -> targetPort 8080 (container port)
    # ============================================================
    service:
      type: ClusterIP
      port: 80

    # ============================================================
    # Ingress - Disabled (using Gateway API HTTPRoute instead)
    # ============================================================
    ingress:
      enabled: false

    # ============================================================
    # Configuration - All environment variables in one section
    # ============================================================
    config:
      # Server Hostname (CRITICAL: Required for OAuth callbacks and LLM proxying)
      OBOT_SERVER_HOSTNAME: "https://#{ obot_hostname | default('obot') }#.${SECRET_DOMAIN}"

      # Database Configuration
#% if obot_postgres_host | default('') %#
      OBOT_SERVER_DSN: "postgresql://#{ obot_postgres_user | default('obot') }#:${OBOT_DB_PASSWORD}@#{ obot_postgres_host }#:5432/#{ obot_postgres_db | default('obot') }#?sslmode=require"
#% else %#
      OBOT_SERVER_DSN: "postgresql://#{ obot_postgres_user | default('obot') }#:${OBOT_DB_PASSWORD}@obot-db-rw.obot.svc.cluster.local:5432/#{ obot_postgres_db | default('obot') }#?sslmode=require"
#% endif %#

      # MCP Runtime Configuration
      # Note: OBOT_SERVER_MCPNAMESPACE, OBOT_SERVER_SERVICE_NAME, and OBOT_SERVER_SERVICE_NAMESPACE
      # are automatically set by the chart when OBOT_SERVER_MCPRUNTIME_BACKEND is "kubernetes"
      OBOT_SERVER_MCPRUNTIME_BACKEND: "kubernetes"

      # Authentication (must be boolean for chart's NOTES.txt template)
      OBOT_SERVER_ENABLE_AUTHENTICATION: true
#% if obot_admin_emails | default('') %#
      OBOT_SERVER_AUTH_ADMIN_EMAILS: "#{ obot_admin_emails }#"
#% endif %#
#% if obot_owner_emails | default('') %#
      OBOT_SERVER_AUTH_OWNER_EMAILS: "#{ obot_owner_emails }#"
#% endif %#
#% if obot_bootstrap_token | default('') %#
      OBOT_BOOTSTRAP_TOKEN: "${OBOT_BOOTSTRAP_TOKEN}"
#% endif %#

      # OAuth Authentication - Choose ONE: Keycloak OR Entra ID
      # Priority: Keycloak > Entra ID (if both configured, Keycloak wins)
#% if obot_keycloak_enabled | default(false) %#
      # Keycloak OAuth Configuration (via local Keycloak instance)
      OBOT_SERVER_AUTH_PROVIDER: "keycloak"
      OBOT_SERVER_AUTH_KEYCLOAK_ISSUER_URL: "https://auth.${SECRET_DOMAIN}/realms/k8s-cluster"
      OBOT_SERVER_AUTH_KEYCLOAK_CLIENT_ID: "#{ obot_keycloak_client_id | default('obot') }#"
      OBOT_SERVER_AUTH_KEYCLOAK_CLIENT_SECRET: "${OBOT_KEYCLOAK_CLIENT_SECRET}"
      OBOT_SERVER_AUTH_REDIRECT_URL: "https://#{ obot_hostname | default('obot') }#.${SECRET_DOMAIN}/oauth2/callback"
      # Token audience validation (security hardening - prevents token confusion attacks)
      OBOT_SERVER_AUTH_AUDIENCE: "#{ obot_keycloak_client_id | default('obot') }#"
      OBOT_SERVER_AUTH_REQUIRED_CLAIMS: "email,preferred_username"
#% elif obot_entra_tenant_id | default('') %#
      # Entra ID OAuth Configuration (direct Microsoft authentication)
      OBOT_SERVER_AUTH_PROVIDER: "entra-id"
      OBOT_SERVER_AUTH_ENTRA_TENANT_ID: "#{ obot_entra_tenant_id }#"
      OBOT_SERVER_AUTH_ENTRA_CLIENT_ID: "${OBOT_ENTRA_CLIENT_ID}"
      OBOT_SERVER_AUTH_ENTRA_CLIENT_SECRET: "${OBOT_ENTRA_CLIENT_SECRET}"
      OBOT_SERVER_AUTH_REDIRECT_URL: "https://#{ obot_hostname | default('obot') }#.${SECRET_DOMAIN}/oauth2/callback"
      # Token audience validation (security hardening - prevents token confusion attacks)
      OBOT_SERVER_AUTH_AUDIENCE: "${OBOT_ENTRA_CLIENT_ID}"
      OBOT_SERVER_AUTH_REQUIRED_CLAIMS: "email,preferred_username"
#% endif %#

      # Encryption Configuration
      # Per docs/obot-docs/configuration/encryption-providers/custom-provider.md:
      # - OBOT_SERVER_ENCRYPTION_PROVIDER must be "custom"
      # - OBOT_SERVER_ENCRYPTION_KEY via Flux substitution from cluster-secrets
      # - OBOT_SERVER_ENCRYPTION_CONFIG_FILE points to the config file created by initContainer
      # Chart's initContainer creates /config/encryption.yaml from the secret key
#% if obot_encryption_key | default('') and obot_encryption_provider | default('custom') == 'custom' %#
      OBOT_SERVER_ENCRYPTION_PROVIDER: "custom"
      OBOT_SERVER_ENCRYPTION_KEY: "${OBOT_SERVER_ENCRYPTION_KEY}"
      OBOT_SERVER_ENCRYPTION_CONFIG_FILE: "/config/encryption.yaml"
#% endif %#

      # AI Gateway Integration
      # Supports two gateway options:
      # - agentgateway (ai-gw): MCP/AI-focused gateway with rate limiting, prompt guards, FinOps metrics
      # - Envoy AI Gateway (llms): Legacy Azure OpenAI routing gateway
#% if obot_use_ai_gateway | default(true) %#
#% if obot_use_agentgateway | default(false) %#
      OBOT_SERVER_LLM_BASE_URL: "https://ai-gw.${SECRET_DOMAIN}/v1"
#% else %#
      OBOT_SERVER_LLM_BASE_URL: "https://llms.${SECRET_DOMAIN}/v1"
#% endif %#
#% endif %#

      # Tool Registries - Unified path containing all auth providers (upstream + custom)
      # The Docker build merges GitHub, Google, EntraID, and Keycloak providers into single index.yaml
      OBOT_SERVER_TOOL_REGISTRIES: "/obot-tools/tools"

      # Disable update check - using forked repo, upstream version checks are not relevant
      OBOT_SERVER_DISABLE_UPDATE_CHECK: "true"

#% if obot_workspace_provider | default('directory') == 's3' %#
      # ============================================================
      # S3 Workspace Provider Configuration
      # Enables multi-replica scaling by using S3-compatible storage (MinIO)
      # REF: https://docs.obot.ai/configuration/workspace-provider/
      # ============================================================
      OBOT_WORKSPACE_PROVIDER_TYPE: "s3"
      WORKSPACE_PROVIDER_S3_BUCKET: "#{ obot_s3_bucket }#"
      WORKSPACE_PROVIDER_S3_BASE_ENDPOINT: "#{ obot_s3_endpoint }#"
      AWS_ACCESS_KEY_ID: "${OBOT_S3_ACCESS_KEY}"
      AWS_SECRET_ACCESS_KEY: "${OBOT_S3_SECRET_KEY}"
      AWS_REGION: "#{ obot_s3_region | default('us-east-1') }#"
#% if obot_s3_use_path_style | default(false) %#
      # Use path-style URLs for S3-compatible storage (MinIO without wildcard DNS)
      # Format: https://my-s3-endpoint.domain.com/bucket instead of https://bucket.s3.domain.com
      WORKSPACE_PROVIDER_S3_USE_PATH_STYLE: "true"
#% endif %#
#% endif %#

    # ============================================================
    # Storage Configuration
    # Note: PVC persistence is disabled when using S3 workspace provider
    # ============================================================
#% if obot_workspace_provider | default('directory') == 's3' %#
    persistence:
      enabled: false
#% else %#
    persistence:
      enabled: true
      storageClass: #{ obot_storage_class | default('proxmox-csi') }#
      size: #{ obot_storage_size | default('20Gi') }#
      accessMode: ReadWriteOnce
#% endif %#

    # ============================================================
    # MCP Kubernetes Runtime Settings
    # ============================================================
    mcpNamespace:
      name: #{ obot_mcp_namespace | default('obot-mcp') }#
      create: false  # Created via Flux, not Helm

    mcpServerDefaults:
      resources:
        requests:
          cpu: "100m"
          memory: "256Mi"
        limits:
          cpu: "500m"
          memory: "512Mi"
      podSecurityContext:
        runAsNonRoot: true
        runAsUser: 65534
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL

    # ============================================================
    # Resource Limits
    # ============================================================
    resources:
      requests:
        cpu: "#{ obot_cpu_request | default('500m') }#"
        memory: "#{ obot_memory_request | default('1Gi') }#"
      limits:
        cpu: "#{ obot_cpu_limit | default('2000m') }#"
        memory: "#{ obot_memory_limit | default('4Gi') }#"

    # ============================================================
    # Security Context
    # ============================================================
    podSecurityContext:
      fsGroup: 1000

    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      capabilities:
        drop:
          - ALL

    # ============================================================
    # Probes
    # ============================================================
    livenessProbe:
      httpGet:
        path: /api/healthz
        port: 8080
      initialDelaySeconds: 60
      periodSeconds: 15
      failureThreshold: 5
      timeoutSeconds: 10

    readinessProbe:
      httpGet:
        path: /api/healthz
        port: 8080
      initialDelaySeconds: 30
      periodSeconds: 10
      failureThreshold: 3
      timeoutSeconds: 5

    # ============================================================
    # Service Account
    # ============================================================
    serviceAccount:
      create: true
      name: obot

    # ============================================================
    # RBAC for MCP Namespace
    # ============================================================
    rbac:
      create: true

    # ============================================================
    # Network Policy Labels for CCNP tiered policies
    # obot needs K8s API access for MCP server lifecycle management
    # ============================================================
    podLabels:
      network.cilium.io/api-access: "true"
#% endif %#
