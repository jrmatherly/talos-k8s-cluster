#% if kubernetes_event_exporter_enabled | default(victoria_logs_enabled) %#
---
#| Kubernetes Event Exporter - captures ephemeral K8s events #|
#| Forwards to VictoriaLogs via Loki-compatible API #|
#| REF: https://itnext.io/kubernetes-monitoring-a-complete-solution-part-10-kubernetes-event-logging-to-victorialogs-2ddc086d7859 #|
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kubernetes-event-exporter
spec:
  chart:
    spec:
      chart: kubernetes-event-exporter
      version: "3.6.3"
      sourceRef:
        kind: HelmRepository
        name: bitnami
  interval: 1h
  values:
    #| Network policy labels for CCNP tiered policies (watches K8s events) #|
    podLabels:
      network.cilium.io/api-access: "true"
    #| Event exporter configuration #|
    config:
      #| Leader election for HA #|
      leaderElection: {}
      #| Logging configuration #|
      logLevel: info
      logFormat: json
      #| Prometheus metrics prefix #|
      metricsNamePrefix: event_exporter_
      #| Receivers - where to send events #|
      receivers:
        - name: "victorialogs"
          #| VictoriaLogs Loki-compatible ingestion endpoint #|
          loki:
            url: "http://victoria-logs-server.observability.svc.cluster.local:9428/insert/loki/api/v1/push"
            #| Add stream labels for filtering in VictoriaLogs #|
            streamLabels:
              source_type: kubernetes-event
      #| Routes - define which events go where #|
      route:
        routes:
          - match:
              - receiver: "victorialogs"
    #| Resource limits #|
    resources:
      requests:
        cpu: "50m"
        memory: "64Mi"
      limits:
        cpu: "200m"
        memory: "256Mi"
#% endif %#
