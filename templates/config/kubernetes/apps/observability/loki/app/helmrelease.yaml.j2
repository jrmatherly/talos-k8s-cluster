#% if observability_enabled %#
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
spec:
  chartRef:
    kind: OCIRepository
    name: loki
  interval: 1h
  timeout: 15m
  values:
    #% if loki_storage_type | default('filesystem') == 's3' %#
    # ============================================================
    # Deployment Mode: Simple Scalable (requires object storage)
    # ============================================================
    deploymentMode: SimpleScalable

    # ============================================================
    # Loki Configuration
    # ============================================================
    loki:
      auth_enabled: false

      # Schema configuration for log storage
      schemaConfig:
        configs:
          - from: "2024-04-01"
            store: tsdb
            object_store: s3
            schema: v13
            index:
              prefix: loki_index_
              period: 24h

      # Ingester configuration
      ingester:
        chunk_encoding: snappy

      # Tracing integration (for correlation with Tempo)
      tracing:
        enabled: true

      # Querier configuration
      querier:
        max_concurrent: 4

      # Query scheduler
      query_scheduler:
        max_outstanding_requests_per_tenant: 4096

      # Limits configuration
      limits_config:
        retention_period: #{ loki_retention | default('168h') }#
        ingestion_rate_mb: 16
        ingestion_burst_size_mb: 32
        max_query_parallelism: 32
        max_query_series: 10000
        split_queries_by_interval: 15m

      # S3 Storage configuration
      storage:
        type: s3
        s3:
          endpoint: #{ loki_s3_endpoint | default('minio.observability.svc.cluster.local:9000') }#
          bucketnames: #{ loki_bucket_name | default('loki') }#
          access_key_id: #{ loki_s3_access_key | default('') }#
          secret_access_key: #{ loki_s3_secret_key | default('') }#
          insecure: #{ loki_s3_insecure | default(true) | string | lower }#
          s3ForcePathStyle: true

    # ============================================================
    # Simple Scalable Components
    # ============================================================
    # Read path (query-frontend, querier)
    read:
      replicas: #{ loki_read_replicas | default(2) }#
      persistence:
        enableStatefulSetAutoDeletePVC: true
        size: #{ loki_read_storage_size | default('10Gi') }#
        storageClass: #{ prometheus_storage_class | default('proxmox-csi') }#

    # Write path (distributor, ingester)
    write:
      replicas: #{ loki_write_replicas | default(2) }#
      persistence:
        enableStatefulSetAutoDeletePVC: true
        size: #{ loki_write_storage_size | default('10Gi') }#
        storageClass: #{ prometheus_storage_class | default('proxmox-csi') }#

    # Backend (compactor, index-gateway, ruler)
    backend:
      replicas: #{ loki_backend_replicas | default(2) }#
      persistence:
        enableStatefulSetAutoDeletePVC: true
        size: #{ loki_backend_storage_size | default('10Gi') }#
        storageClass: #{ prometheus_storage_class | default('proxmox-csi') }#

    # Disable singleBinary in SimpleScalable mode
    singleBinary:
      replicas: 0

    # Caches for SimpleScalable mode
    chunksCache:
      enabled: true
      allocatedMemory: 1024

    resultsCache:
      enabled: true
      allocatedMemory: 512
    #% else %#
    # ============================================================
    # Deployment Mode: SingleBinary (Monolithic - for filesystem storage)
    # ============================================================
    deploymentMode: SingleBinary

    # ============================================================
    # Loki Configuration
    # ============================================================
    loki:
      auth_enabled: false
      commonConfig:
        replication_factor: 1

      # Schema configuration for log storage
      schemaConfig:
        configs:
          - from: "2024-04-01"
            store: tsdb
            object_store: filesystem
            schema: v13
            index:
              prefix: loki_index_
              period: 24h

      # Ingester configuration
      ingester:
        chunk_encoding: snappy

      # Tracing integration (for correlation with Tempo)
      tracing:
        enabled: true

      # Querier configuration
      querier:
        max_concurrent: 4

      # Limits configuration
      limits_config:
        retention_period: #{ loki_retention | default('168h') }#
        ingestion_rate_mb: 16
        ingestion_burst_size_mb: 32
        max_query_parallelism: 32
        max_query_series: 10000
        split_queries_by_interval: 15m

      # Filesystem storage
      storage:
        type: filesystem

    # ============================================================
    # SingleBinary Configuration
    # ============================================================
    singleBinary:
      replicas: #{ loki_replicas | default(1) }#
      persistence:
        enabled: true
        size: #{ loki_storage_size | default('10Gi') }#
        storageClass: #{ prometheus_storage_class | default('proxmox-csi') }#
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          memory: 1Gi

    # Disable scalable components in SingleBinary mode
    read:
      replicas: 0
    write:
      replicas: 0
    backend:
      replicas: 0

    # Disable caches not needed in SingleBinary mode
    chunksCache:
      enabled: false
    resultsCache:
      enabled: false
    #% endif %#

    # ============================================================
    # Gateway (nginx)
    # ============================================================
    gateway:
      enabled: true
      replicas: 1
      service:
        type: ClusterIP

    # ============================================================
    # Monitoring
    # ============================================================
    monitoring:
      dashboards:
        enabled: true
        labels:
          grafana_dashboard: "1"
      rules:
        enabled: true
      serviceMonitor:
        enabled: true
        labels: {}

    # ============================================================
    # Sidecar (for service discovery)
    # ============================================================
    sidecar:
      rules:
        enabled: false

    # ============================================================
    # Log Collection with Alloy (replaces Promtail)
    # ============================================================
    lokiCanary:
      enabled: false

    # Disable helm test when lokiCanary is disabled
    # REF: https://github.com/grafana/loki/issues/9849
    test:
      enabled: false
#% endif %#
