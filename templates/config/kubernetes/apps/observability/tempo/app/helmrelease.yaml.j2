#% if observability_enabled %#
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: tempo
spec:
  chartRef:
    kind: OCIRepository
    name: tempo
  interval: 1h
  timeout: 15m
  values:
    # ============================================================
    # Tempo Configuration
    # ============================================================
    tempo:
      reportingEnabled: false

      # Retention configuration
      retention: #{ tempo_retention | default('168h') }#

      # Receiver configuration - enable OTLP, Jaeger, Zipkin
      receivers:
        otlp:
          protocols:
            grpc:
              endpoint: "0.0.0.0:4317"
            http:
              endpoint: "0.0.0.0:4318"
        jaeger:
          protocols:
            thrift_http:
              endpoint: "0.0.0.0:14268"
            grpc:
              endpoint: "0.0.0.0:14250"
            thrift_binary:
              endpoint: "0.0.0.0:6832"
            thrift_compact:
              endpoint: "0.0.0.0:6831"
        zipkin:
          endpoint: "0.0.0.0:9411"

      # Storage configuration
      storage:
        trace:
          backend: #{ tempo_storage_type | default('local') }#
          #% if tempo_storage_type | default('local') == 's3' %#
          s3:
            bucket: #{ tempo_bucket_name | default('tempo') }#
            endpoint: #{ tempo_s3_endpoint | default('minio.observability.svc.cluster.local:9000') }#
            access_key: #{ tempo_s3_access_key | default('') }#
            secret_key: #{ tempo_s3_secret_key | default('') }#
            insecure: #{ tempo_s3_insecure | default(true) | string | lower }#
          #% else %#
          local:
            path: /var/tempo/traces
          #% endif %#
          wal:
            path: /var/tempo/wal

      # Metrics generator for RED metrics
      metricsGenerator:
        enabled: true
        remoteWriteUrl: "http://prometheus-prometheus.observability.svc.cluster.local:9090/api/v1/write"

      # Global overrides
      global_overrides:
        per_tenant_override_config: /runtime-config/overrides.yaml
        metrics_generator_processors:
          - service-graphs
          - span-metrics

    # ============================================================
    # Service Configuration
    # ============================================================
    service:
      type: ClusterIP

    # ============================================================
    # Persistence
    # ============================================================
    persistence:
      enabled: true
      storageClassName: #{ prometheus_storage_class | default('proxmox-csi') }#
      size: #{ tempo_storage_size | default('20Gi') }#

    # ============================================================
    # Resources
    # ============================================================
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 1Gi

    # ============================================================
    # Monitoring
    # ============================================================
    serviceMonitor:
      enabled: true
      labels: {}

    # ============================================================
    # Tempo Query (Jaeger UI compatible)
    # ============================================================
    tempoQuery:
      enabled: true
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          memory: 128Mi
#% endif %#
