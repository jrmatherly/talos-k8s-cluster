#% if observability_enabled and thanos_enabled %#
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: thanos
spec:
  chartRef:
    kind: OCIRepository
    name: thanos
  interval: 1h
  timeout: 15m
  values:
    # ============================================================
    # Global Configuration
    # ============================================================
    image:
      registry: quay.io
      repository: thanos/thanos
      tag: v0.37.2

    # Object storage configuration (shared across components)
    objstoreConfig:
      type: #{ thanos_objstore_type | default('s3') }#
      config:
        bucket: #{ thanos_bucket_name | default('thanos') }#
        endpoint: #{ thanos_s3_endpoint | default('minio.observability.svc.cluster.local:9000') }#
        access_key: #{ thanos_s3_access_key | default('') }#
        secret_key: #{ thanos_s3_secret_key | default('') }#
        insecure: #{ thanos_s3_insecure | default(true) }#

    # ============================================================
    # Query Component
    # ============================================================
    query:
      enabled: true
      replicaCount: #{ thanos_query_replicas | default(2) }#
      replicaLabel:
        - __replica__
      dnsDiscovery:
        sidecarsService: prometheus-thanos-discovery
        sidecarsNamespace: observability
      stores:
        # Connect to Prometheus sidecars
        - dnssrv+_grpc._tcp.prometheus-thanos-discovery.observability.svc.cluster.local
        # Connect to Store Gateway
        - dnssrv+_grpc._tcp.thanos-storegateway.observability.svc.cluster.local
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          memory: 512Mi

    # ============================================================
    # Query Frontend (caching and query splitting)
    # ============================================================
    queryFrontend:
      enabled: true
      replicaCount: #{ thanos_query_frontend_replicas | default(2) }#
      config: |
        type: IN-MEMORY
        config:
          max_size: 512MB
          max_size_items: 1000
          validity: 24h
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          memory: 256Mi

    # ============================================================
    # Store Gateway (queries object storage)
    # ============================================================
    storegateway:
      enabled: true
      replicaCount: #{ thanos_store_replicas | default(2) }#
      persistence:
        enabled: true
        storageClass: #{ prometheus_storage_class | default('proxmox-csi') }#
        size: #{ thanos_store_storage_size | default('10Gi') }#
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          memory: 1Gi

    # ============================================================
    # Compactor (downsamples and compacts blocks)
    # ============================================================
    compactor:
      enabled: true
      retentionResolutionRaw: #{ thanos_retention_raw | default('30d') }#
      retentionResolution5m: #{ thanos_retention_5m | default('60d') }#
      retentionResolution1h: #{ thanos_retention_1h | default('180d') }#
      persistence:
        enabled: true
        storageClass: #{ prometheus_storage_class | default('proxmox-csi') }#
        size: #{ thanos_compactor_storage_size | default('20Gi') }#
      resources:
        requests:
          cpu: 50m
          memory: 256Mi
        limits:
          memory: 1Gi

    # ============================================================
    # Ruler (evaluates recording/alerting rules against Thanos)
    # ============================================================
    ruler:
      enabled: false  # Use Prometheus ruler by default

    # ============================================================
    # Bucket Web (UI for object storage browsing)
    # ============================================================
    bucketweb:
      enabled: true
      replicaCount: 1
      resources:
        requests:
          cpu: 10m
          memory: 32Mi
        limits:
          memory: 64Mi

    # ============================================================
    # Receive (for remote write - optional, disabled by default)
    # ============================================================
    receive:
      enabled: false  # Use sidecar approach instead

    # ============================================================
    # Monitoring
    # ============================================================
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        labels: {}
#% endif %#
