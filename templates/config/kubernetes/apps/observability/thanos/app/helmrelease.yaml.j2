#% if observability_enabled and thanos_enabled %#
---
# stevehipwell/thanos chart - https://github.com/stevehipwell/helm-charts/tree/main/charts/thanos
# Uses upstream Thanos images from quay.io/thanos/thanos
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: thanos
spec:
  chartRef:
    kind: OCIRepository
    name: thanos
  interval: 1h
  timeout: 15m
  values:
    # ============================================================
    # Object Store Configuration
    # ============================================================
    objstoreConfig:
      create: false
      existingSecret: thanos-objstore-secret
      key: objstore.yml

    # ============================================================
    # Query Component
    # ============================================================
    query:
      enabled: true
      replicaCount: #{ thanos_query_replicas | default(2) }#
      # Connect to Prometheus sidecars and Store Gateway
      extraArgs:
        - --endpoint=dnssrv+_grpc._tcp.prometheus-thanos-discovery.observability.svc.cluster.local
        - --endpoint=dnssrv+_grpc._tcp.thanos-store-gateway-grpc.observability.svc.cluster.local
        - --query.replica-label=__replica__
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          memory: 512Mi
      serviceMonitor:
        enabled: true

    # ============================================================
    # Query Frontend (caching and query splitting)
    # ============================================================
    queryFrontend:
      enabled: true
      replicaCount: #{ thanos_query_frontend_replicas | default(2) }#
      extraArgs:
        - --query-frontend.compress-responses
        - --query-range.split-interval=24h
        - --query-range.max-retries-per-request=5
        - |
          --query-range.response-cache-config=
          type: IN-MEMORY
          config:
            max_size: 512MB
            max_size_items: 1000
            validity: 24h
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          memory: 256Mi
      serviceMonitor:
        enabled: true

    # ============================================================
    # Store Gateway (queries object storage)
    # ============================================================
    storeGateway:
      enabled: true
      replicaCount: #{ thanos_store_replicas | default(2) }#
      persistence:
        enabled: true
        storageClass: #{ prometheus_storage_class | default('proxmox-csi') }#
        size: #{ thanos_store_storage_size | default('10Gi') }#
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          memory: 1Gi
      serviceMonitor:
        enabled: true

    # ============================================================
    # Compactor (downsamples and compacts blocks)
    # ============================================================
    compact:
      enabled: true
      extraArgs:
        - --retention.resolution-raw=#{ thanos_retention_raw | default('30d') }#
        - --retention.resolution-5m=#{ thanos_retention_5m | default('60d') }#
        - --retention.resolution-1h=#{ thanos_retention_1h | default('180d') }#
        - --compact.concurrency=1
        - --downsample.concurrency=1
        - --deduplication.replica-label=__replica__
      persistence:
        enabled: true
        storageClass: #{ prometheus_storage_class | default('proxmox-csi') }#
        size: #{ thanos_compactor_storage_size | default('20Gi') }#
      resources:
        requests:
          cpu: 50m
          memory: 256Mi
        limits:
          memory: 1Gi
      serviceMonitor:
        enabled: true

    # ============================================================
    # Ruler (disabled - use Prometheus ruler)
    # ============================================================
    ruler:
      enabled: false

    # ============================================================
    # Receiver (disabled - use sidecar approach)
    # ============================================================
    receive:
      enabled: false
#% endif %#
