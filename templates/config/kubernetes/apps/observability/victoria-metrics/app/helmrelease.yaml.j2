#% if victoria_metrics_enabled %#
---
#| VictoriaMetrics K8s Stack - replaces kube-prometheus-stack #|
#| REF: https://docs.victoriametrics.com/guides/k8s-monitoring/ #|
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: victoria-metrics
spec:
  chartRef:
    kind: OCIRepository
    name: victoria-metrics-k8s-stack
  interval: 1h
  values:
    #| Shorten resource names to avoid 63-char limit #|
    fullnameOverride: vmstack
    #| Disable components we don't need #|
    argocdReleaseOverride: ""

    #| VMSingle - single-node metrics storage (replaces Prometheus) #|
    vmsingle:
      enabled: true
      spec:
        retentionPeriod: "#{ vm_retention_days }#d"
        storage:
          storageClassName: "#{ vm_storage_class }#"
          resources:
            requests:
              storage: "#{ vm_storage_size }#"
        resources:
          requests:
            cpu: "#{ vm_cpu_request }#"
            memory: "#{ vm_memory_request }#"
          limits:
            cpu: "#{ vm_cpu_limit }#"
            memory: "#{ vm_memory_limit }#"
        extraArgs:
          #| MetricsQL is superset of PromQL - existing dashboards work #|
          search.logSlowQueryDuration: "5s"
          #| Bounded memory mode - 70% leaves headroom for queries and OS cache #|
          #| REF: https://docs.victoriametrics.com/victoriametrics/faq/ #|
          memory.allowedPercent: "70"
          #| Deduplication for high-availability scraping scenarios #|
          #| Removes duplicate samples when multiple VMAgents scrape the same target #|
          dedup.minScrapeInterval: "30s"

    #| VMAgent - metrics scraper (replaces Prometheus scraping) #|
    vmagent:
      enabled: true
      spec:
        scrapeInterval: "30s"
        #| Network policy labels for CCNP tiered policies #|
        podMetadata:
          labels:
            #| K8s API access for service discovery #|
            network.cilium.io/api-access: "true"
            #| Metrics scraping access to all cluster endpoints #|
            network.cilium.io/metrics-scraper: "true"
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        extraArgs:
          #| Enable Prometheus-compatible remote write #|
          promscrape.streamParse: "true"
          #| Drop original __name__, job, instance labels from scraped metrics #|
          #| Reduces memory usage and prevents label conflicts #|
          promscrape.dropOriginalLabels: "true"

    #| VMAlert - alerting (replaces Prometheus Alertmanager rules) #|
    vmalert:
      enabled: true
      spec:
        resources:
          requests:
            cpu: "50m"
            memory: "128Mi"
          limits:
            cpu: "200m"
            memory: "256Mi"

    #| Alertmanager - keep for alerting notifications #|
    alertmanager:
      enabled: true
      spec:
        storage:
          volumeClaimTemplate:
            spec:
              storageClassName: "#{ vm_storage_class }#"
              resources:
                requests:
                  storage: "#{ alertmanager_storage_size }#"
        resources:
          requests:
            cpu: "50m"
            memory: "64Mi"
          limits:
            cpu: "100m"
            memory: "128Mi"

    #| Grafana datasources - use chart's native sections for VictoriaMetrics/Alertmanager #|
    #| Extra datasources (VictoriaLogs, Tempo) added after the chart's defaults #|
    defaultDatasources:
      #| Chart's VictoriaMetrics datasource - use prometheus type for dashboard compatibility #|
      #| VictoriaMetrics is fully Prometheus-compatible; dashboards query for type=prometheus #|
      victoriametrics:
        perReplica: false
        datasources:
          - name: VictoriaMetrics
            type: prometheus
            uid: victoriametrics
            access: proxy
            isDefault: true
            jsonData:
              queryTimeout: "120s"
      #| Chart's Alertmanager datasource - customize with our settings #|
      alertmanager:
        perReplica: false
        datasources:
          - name: Alertmanager
            type: alertmanager
            uid: alertmanager
            url: http://vmalertmanager-vmstack.observability.svc.cluster.local:9093
            access: proxy
            jsonData:
              implementation: prometheus
              handleGrafanaManagedAlerts: true
      #| Extra datasources for VictoriaLogs and Tempo #|
      extra:
#% if victoria_logs_enabled %#
        - name: VictoriaLogs
          type: victoriametrics-logs-datasource
          uid: victorialogs
          url: http://victoria-logs.observability.svc.cluster.local:9428
          access: proxy
          isDefault: false
          jsonData:
            maxLines: 1000
#% endif %#
#% if tempo_enabled %#
        - name: Tempo
          type: tempo
          uid: tempo
          url: http://tempo.observability.svc.cluster.local:3200
          access: proxy
          isDefault: false
          jsonData:
            tracesToLogsV2:
              datasourceUid: victorialogs
              spanStartTimeShift: "-1h"
              spanEndTimeShift: "1h"
              filterByTraceID: true
              filterBySpanID: true
            tracesToMetrics:
              datasourceUid: victoriametrics
              spanStartTimeShift: "-1h"
              spanEndTimeShift: "1h"
            serviceMap:
              datasourceUid: victoriametrics
            nodeGraph:
              enabled: true
            search:
              hide: false
            lokiSearch:
              datasourceUid: victorialogs
#% endif %#

    #| Grafana - visualization (use existing or deploy new) #|
    grafana:
      enabled: true
      adminPassword: "#{ grafana_admin_password }#"
      #| Disable sidecar to use static dashboard definitions below #|
      sidecar:
        dashboards:
          enabled: false
      persistence:
        enabled: true
        storageClassName: "#{ vm_storage_class }#"
        size: "#{ grafana_storage_size }#"
      #| Install VictoriaMetrics plugins #|
      plugins:
        - victoriametrics-metrics-datasource
#% if victoria_logs_enabled %#
        - victoriametrics-logs-datasource
#% endif %#
      #| Grafana dashboards organized in folders #|
      dashboardProviders:
        dashboardproviders.yaml:
          apiVersion: 1
          providers:
            - name: "kubernetes"
              orgId: 1
              folder: "Kubernetes"
              type: file
              disableDeletion: false
              editable: true
              options:
                path: /var/lib/grafana/dashboards/kubernetes
            - name: "cilium"
              orgId: 1
              folder: "Cilium"
              type: file
              disableDeletion: false
              editable: true
              options:
                path: /var/lib/grafana/dashboards/cilium
            - name: "victoriametrics"
              orgId: 1
              folder: "VictoriaMetrics"
              type: file
              disableDeletion: false
              editable: true
              options:
                path: /var/lib/grafana/dashboards/victoriametrics
#% if victoria_logs_enabled %#
            - name: "victorialogs"
              orgId: 1
              folder: "VictoriaLogs"
              type: file
              disableDeletion: false
              editable: true
              options:
                path: /var/lib/grafana/dashboards/victorialogs
#% endif %#
#% if proxmox_dashboards_enabled %#
            - name: "proxmox"
              orgId: 1
              folder: "Proxmox"
              type: file
              disableDeletion: false
              editable: true
              options:
                path: /var/lib/grafana/dashboards/proxmox
#% endif %#
#% if unifi_enabled %#
            - name: "unifi"
              orgId: 1
              folder: "UniFi"
              type: file
              disableDeletion: false
              editable: true
              options:
                path: /var/lib/grafana/dashboards/unifi
#% endif %#
      dashboards:
        kubernetes:
          #| Core Kubernetes dashboards #|
          kubernetes-api-server:
            gnetId: 15761
            revision: 19
            datasource: VictoriaMetrics
          kubernetes-coredns:
            gnetId: 15762
            revision: 18
            datasource: VictoriaMetrics
          kubernetes-global:
            gnetId: 15757
            revision: 42
            datasource: VictoriaMetrics
          kubernetes-namespaces:
            gnetId: 15758
            revision: 42
            datasource: VictoriaMetrics
          kubernetes-nodes:
            gnetId: 15759
            revision: 32
            datasource: VictoriaMetrics
          kubernetes-pods:
            gnetId: 15760
            revision: 32
            datasource: VictoriaMetrics
        cilium:
          #| Cilium CNI dashboards #|
          cilium-agent:
            gnetId: 16611
            revision: 1
            datasource: VictoriaMetrics
          cilium-operator:
            gnetId: 16612
            revision: 1
            datasource: VictoriaMetrics
          hubble:
            gnetId: 16613
            revision: 1
            datasource: VictoriaMetrics
        victoriametrics:
          #| VictoriaMetrics internal dashboards #|
          vmagent:
            gnetId: 12683
            revision: 23
            datasource: VictoriaMetrics
          vmalert:
            gnetId: 14950
            revision: 12
            datasource: VictoriaMetrics
          vmsingle:
            gnetId: 10229
            revision: 38
            datasource: VictoriaMetrics
          vmoperator:
            gnetId: 17869
            revision: 4
            datasource: VictoriaMetrics
#% if victoria_logs_enabled %#
        victorialogs:
          #| VictoriaLogs dashboards #|
          victorialogs-single:
            gnetId: 22084
            revision: 5
            datasource: VictoriaMetrics
#% endif %#
#% if proxmox_dashboards_enabled %#
        proxmox:
          #| Proxmox VE dashboards - metrics via InfluxDB protocol to VictoriaMetrics #|
          #| REF: https://grafana.com/grafana/dashboards/16060 #|
          proxmox-metrics:
            gnetId: 16060
            revision: 1
            datasource: VictoriaMetrics
          #| REF: https://grafana.com/grafana/dashboards/13307 #|
          proxmox-ve:
            gnetId: 13307
            revision: 14
            datasource: VictoriaMetrics
#% endif %#
#% if unifi_enabled %#
        unifi:
          #| UniFi Network dashboards - metrics via UnPoller Prometheus exporter #|
          #| REF: https://unpoller.com/docs/install/grafana/ #|
          unifi-usw:
            #| USW Insights - UniFi Switches #|
            gnetId: 11312
            revision: 9
            datasource: VictoriaMetrics
          unifi-usg:
            #| USG Insights - UniFi Gateway/UDM #|
            gnetId: 11313
            revision: 9
            datasource: VictoriaMetrics
          unifi-uap:
            #| UAP Insights - UniFi Access Points #|
            gnetId: 11314
            revision: 10
            datasource: VictoriaMetrics
          unifi-clients:
            #| Client Insights - Connected clients #|
            gnetId: 11315
            revision: 9
            datasource: VictoriaMetrics
#% endif %#

    #| ServiceMonitor/PodMonitor auto-discovery #|
    #| VictoriaMetrics operator auto-converts Prometheus CRDs #|
    crds:
      enabled: true

    #| Node exporter for host metrics #|
    prometheus-node-exporter:
      enabled: true

    #| kube-state-metrics for K8s object metrics #|
    kube-state-metrics:
      enabled: true
      #| Network policy labels for CCNP tiered policies (watches K8s resources) #|
      podLabels:
        network.cilium.io/api-access: "true"
#% endif %#