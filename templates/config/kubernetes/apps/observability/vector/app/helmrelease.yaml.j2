#% if vector_enabled | default(victoria_logs_enabled) %#
---
#| Vector Agent - log collector DaemonSet sending to VictoriaLogs #|
#| REF: https://vector.dev/docs/ #|
#| REF: https://docs.victoriametrics.com/victorialogs/data-ingestion/vector/ #|
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: vector
spec:
  chart:
    spec:
      chart: vector
      version: "0.46.0"
      sourceRef:
        kind: HelmRepository
        name: vector
  interval: 1h
  values:
    role: Agent
#% if talos_system_logs_enabled %#
    #| Enable host network for receiving Talos syslog via UDP #|
    hostNetwork: true
    dnsPolicy: ClusterFirstWithHostNet
#% endif %#
    #| Network policy labels for CCNP tiered policies (kubernetes_logs source) #|
    podLabels:
      network.cilium.io/api-access: "true"
    #| DaemonSet to collect logs from all nodes #|
    resources:
      requests:
        cpu: "#{ vector_cpu_request }#"
        memory: "#{ vector_memory_request }#"
      limits:
        cpu: "#{ vector_cpu_limit }#"
        memory: "#{ vector_memory_limit }#"
#% if talos_system_logs_enabled %#
    #| Container ports for Talos syslog (UDP) #|
    containerPorts:
      - name: talos-kernel
        containerPort: 6050
        protocol: UDP
      - name: talos-service
        containerPort: 6051
        protocol: UDP
#% endif %#
    #| Vector configuration #|
    customConfig:
      data_dir: /vector-data-dir
      api:
        enabled: true
        address: 0.0.0.0:8686
        playground: false
      sources:
        #| Kubernetes logs from container runtime #|
        kubernetes_logs:
          type: kubernetes_logs
          auto_partial_merge: true
          #| Exclude Vector's own logs to prevent recursion #|
          exclude_paths_glob_patterns:
            - "**/vector*/**"
#% if talos_system_logs_enabled %#
        #| Talos kernel logs via UDP socket #|
        #| Requires extraKernelArgs in Talos schematic: talos.logging.kernel=udp://vector.observability.svc.cluster.local:6050 #|
        talos_kernel_logs:
          type: socket
          address: 0.0.0.0:6050
          mode: udp
          max_length: 102400
          decoding:
            codec: bytes
        #| Talos service logs via UDP socket #|
        #| Configured via machine.logging.destinations in Talos config #|
        talos_service_logs:
          type: socket
          address: 0.0.0.0:6051
          mode: udp
          max_length: 102400
          decoding:
            codec: json
#% endif %#
#% if api_server_audit_logs_enabled %#
        #| Kubernetes API server audit logs #|
        #| Talos exposes audit logs at /var/log/audit/kube/*.log #|
        kubernetes_audit_logs:
          type: file
          include:
            - /var/log/audit/kube/*.log
          read_from: beginning
          fingerprint:
            strategy: device_and_inode
#% endif %#
      transforms:
        #| Parse Kubernetes metadata #|
        kubernetes_transform:
          type: remap
          inputs:
            - kubernetes_logs
          source: |
            # Extract Kubernetes metadata for VictoriaLogs labels
            .namespace = .kubernetes.pod_namespace
            .pod = .kubernetes.pod_name
            .container = .kubernetes.container_name
            .node = .kubernetes.pod_node_name
            .source_type = "kubernetes"
            # Keep original message
            if exists(.message) {
              .log = .message
            }
            # Add stream type (stdout/stderr)
            .stream = .stream
#% if talos_system_logs_enabled %#
        #| Parse Talos kernel logs #|
        talos_kernel_transform:
          type: remap
          inputs:
            - talos_kernel_logs
          source: |
            .source_type = "talos_kernel"
            .facility = "kern"
            .log = string!(.message)
            .node = get_env_var!("VECTOR_SELF_NODE_NAME")
        #| Parse Talos service logs #|
        talos_service_transform:
          type: remap
          inputs:
            - talos_service_logs
          source: |
            .source_type = "talos_service"
            .facility = "talos"
            if exists(.msg) {
              .log = .msg
            } else if exists(.message) {
              .log = .message
            }
            .node = get_env_var!("VECTOR_SELF_NODE_NAME")
            .service = .talos_service
#% endif %#
#% if api_server_audit_logs_enabled %#
        #| Parse Kubernetes audit logs #|
        kubernetes_audit_transform:
          type: remap
          inputs:
            - kubernetes_audit_logs
          source: |
            parsed = parse_json(.message) ?? {}
            . = parsed
            .source_type = "kubernetes_audit"
            .log = encode_json(.)
            .node = get_env_var!("VECTOR_SELF_NODE_NAME")
#% endif %#
        #| Filter out noisy logs #|
        log_filter:
          type: filter
          inputs:
            - kubernetes_transform
#% if talos_system_logs_enabled %#
            - talos_kernel_transform
            - talos_service_transform
#% endif %#
#% if api_server_audit_logs_enabled %#
            - kubernetes_audit_transform
#% endif %#
          condition:
            type: vrl
            source: |
              # Drop health check logs from kubernetes
              !match(string(.log) ?? "", r'(health|ready|alive|GET /healthz)')
      sinks:
        #| Send to VictoriaLogs via Elasticsearch bulk API #|
        victorialogs:
          type: elasticsearch
          inputs:
            - log_filter
          endpoints:
            - http://victoria-logs-server.observability.svc.cluster.local:9428/insert/elasticsearch/
          api_version: v8
          mode: bulk
          compression: gzip
          healthcheck:
            enabled: false
          query:
            _msg_field: log
            _time_field: timestamp
            _stream_fields: source_type,namespace,pod,container,node,stream,facility,service
          request:
            headers:
              AccountID: "0"
              ProjectID: "0"
          bulk:
            index: "logs"
    #| Service account and RBAC #|
    serviceAccount:
      create: true
    #| Pod security context #|
    podSecurityContext:
      runAsNonRoot: false
      runAsUser: 0
#% if api_server_audit_logs_enabled %#
    #| Mount host audit logs directory #|
    extraVolumes:
      - name: var-log-audit
        hostPath:
          path: /var/log/audit
          type: DirectoryOrCreate
    extraVolumeMounts:
      - name: var-log-audit
        mountPath: /var/log/audit
        readOnly: true
#% endif %#
#% if talos_system_logs_enabled %#
    #| Node name environment variable for log enrichment #|
    env:
      - name: VECTOR_SELF_NODE_NAME
        valueFrom:
          fieldRef:
            fieldPath: spec.nodeName
#% endif %#
#% endif %#
