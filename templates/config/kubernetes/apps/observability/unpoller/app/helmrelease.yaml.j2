#% if unifi_enabled %#
---
#| UnPoller - UniFi Controller Metrics Exporter #|
#| REF: https://unpoller.com/ #|
#| REF: https://github.com/unpoller/helm-chart #|
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: unpoller
spec:
  chart:
    spec:
      chart: unpoller
      version: "2.11.2-Chart6"
      sourceRef:
        kind: HelmRepository
        name: unpoller
  interval: 1h
  #| Post-render patch to inject envFrom since the chart doesn't support it natively #|
  #| REF: https://fluxcd.io/flux/components/helm/helmreleases/#post-renderers #|
  postRenderers:
    - kustomize:
        patches:
          - target:
              kind: Deployment
              name: unpoller
            patch: |
              - op: add
                path: /spec/template/spec/containers/0/envFrom
                value:
                  - secretRef:
                      name: cluster-secrets
  values:
    #| UnPoller configuration in TOML format #|
    #| Credentials provided via environment variables (UP_UNIFI_DEFAULT_*) from cluster-secrets #|
    #| The postRenderers above inject envFrom into the deployment #|
    upConfig: |
      [poller]
        debug = false
        quiet = false

      [prometheus]
        disable = false
        http_listen = "0.0.0.0:9130"
        report_errors = false

      [unifi.defaults]
        sites = ["all"]
        save_ids = true
        save_dpi = true
        save_sites = true
        hash_pii = false
        verify_ssl = #{ unifi_verify_ssl | lower }#

      [influxdb]
        disable = true

      [loki]
        disable = true

    #| Pod Monitor for VMAgent scraping #|
    podMonitor:
      enabled: true
      labels:
        app.kubernetes.io/name: unpoller
      interval: 30s
      scrapeTimeout: 10s

    #| Resource limits #|
    resources:
      requests:
        cpu: "50m"
        memory: "64Mi"
      limits:
        cpu: "200m"
        memory: "256Mi"

    #| Disable Grafana Operator CRDs (we configure dashboards in victoria-metrics) #|
    dashboards:
      create: false
      grafana:
        create: false
#% endif %#
