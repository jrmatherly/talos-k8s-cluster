#% if agentgateway_enabled | default(true) %#
---
#| ============================================================ #|
#| AgentgatewayPolicy - JWT Authentication Enforcement           #|
#| MUST target Gateway to enforce authentication on all routes   #|
#| Ref: https://kgateway.dev/docs/agentgateway/main/mcp/mcp-access/ #|
#| ============================================================ #|
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: mcp-jwt-auth
spec:
  targetRefs:
    #| Target Gateway (not HTTPRoute) for auth enforcement #|
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: ai-gateway
  traffic:
    jwtAuthentication:
      #| Strict mode rejects requests without valid JWT #|
      mode: Strict
      providers:
        - issuer: "https://auth.#{ primary_domain }#/realms/k8s-cluster"
          audiences:
            - "https://mcp-gw.#{ primary_domain }#/mcp"
            - "https://ai-gw.#{ primary_domain }#/mcp"
          jwks:
            #| Fetch JWKS from Keycloak service #|
            remote:
              backendRef:
                name: keycloak-http
                namespace: keycloak
                port: 8080
              jwksPath: "realms/k8s-cluster/protocol/openid-connect/certs"
              cacheDuration: 5m
---
#| ============================================================ #|
#| AgentgatewayPolicy - MCP OAuth Discovery Metadata             #|
#| Provides .well-known/oauth-protected-resource for MCP clients #|
#| Ref: https://modelcontextprotocol.io/specification/2025-11-25/basic/authorization #|
#| ============================================================ #|
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: mcp-oauth-metadata
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: mcp-tools-route
  backend:
    mcp:
      authentication:
        issuer: "https://auth.#{ primary_domain }#/realms/k8s-cluster"
        audiences:
          - "https://mcp-gw.#{ primary_domain }#/mcp"
          - "https://ai-gw.#{ primary_domain }#/mcp"
        provider: Keycloak
        jwks:
          backendRef:
            name: keycloak-http
            namespace: keycloak
            port: 8080
          jwksPath: "realms/k8s-cluster/protocol/openid-connect/certs"
        resourceMetadata:
          default:
            resource: "https://mcp-gw.#{ primary_domain }#/mcp"
            authorizationServers:
              - "https://auth.#{ primary_domain }#/realms/k8s-cluster"
            scopesSupported:
              #% for scope in agentgateway_scopes | default(['openid', 'profile', 'email', 'mcp:tools', 'offline_access']) %#
              - "#{ scope }#"
              #% endfor %#
            bearerMethodsSupported:
              - header
---
#| ============================================================ #|
#| AgentgatewayPolicy - CORS Configuration                       #|
#| Required for browser-based MCP clients (VS Code, web apps)    #|
#| ============================================================ #|
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: mcp-cors
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: mcp-tools-route
  traffic:
    cors:
      allowOrigins:
        - "https://mcp-gw.#{ primary_domain }#"
        - "https://ai-gw.#{ primary_domain }#"
        - "https://*.#{ primary_domain }#"
        - "http://localhost"
        - "http://localhost:3000"
        - "http://localhost:5173"
        - "http://127.0.0.1"
        - "http://127.0.0.1:3000"
        - "http://127.0.0.1:5173"
      allowMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowHeaders:
        - Authorization
        - Content-Type
        - X-Request-ID
        - MCP-Protocol-Version
      exposeHeaders:
        - WWW-Authenticate
        - X-Request-ID
      allowCredentials: true
      maxAge: 86400
---
#| ============================================================ #|
#| HTTPRoute for MCP Tool Servers                                #|
#| Routes /mcp/* through AgentgatewayBackend for MCP OAuth       #|
#| This enables RFC 9728 Protected Resource Metadata:            #|
#| - .well-known/oauth-protected-resource endpoint               #|
#| - WWW-Authenticate header with resource_metadata parameter    #|
#| ============================================================ #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: mcp-tools-route
spec:
  parentRefs:
    - name: ai-gateway
      namespace: agentgateway-system
      sectionName: https
  hostnames:
    - "mcp-gw.#{ primary_domain }#"
    - "ai-gw.#{ primary_domain }#"
  rules:
    #| MCP Tool routes - routed through AgentgatewayBackend for OAuth #|
    #% if obot_enabled | default(false) %#
    - matches:
        - path:
            type: PathPrefix
            value: /mcp/obot
      backendRefs:
        #| Route through AgentgatewayBackend for MCP OAuth authentication #|
        - name: obot-mcp
          group: agentgateway.dev
          kind: AgentgatewayBackend
    #% endif %#
    #% if kagent_enabled | default(false) %#
    - matches:
        - path:
            type: PathPrefix
            value: /mcp/kagent
      backendRefs:
        #| Route through AgentgatewayBackend for MCP OAuth authentication #|
        - name: kagent-mcp
          group: agentgateway.dev
          kind: AgentgatewayBackend
    #% endif %#
    #% if flux_mcp_enabled | default(false) %#
    - matches:
        - path:
            type: PathPrefix
            value: /mcp/flux
      filters:
        #| Rewrite /mcp/flux to /mcp - Flux MCP server expects /mcp endpoint #|
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: /mcp
      backendRefs:
        #| Route through AgentgatewayBackend for MCP OAuth authentication #|
        - name: flux-mcp
          group: agentgateway.dev
          kind: AgentgatewayBackend
    #% endif %#
#% endif %#
