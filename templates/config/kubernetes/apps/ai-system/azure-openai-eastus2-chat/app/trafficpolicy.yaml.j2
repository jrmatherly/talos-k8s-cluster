#% if agentgateway_addr is defined and azure_openai_eastus2_api_key is defined and azure_openai_eastus2_chat_deployment_name is defined %#
#% if agentgateway_rate_limit_enabled | default(true) %#
---
#| TrafficPolicy for rate limiting, timeouts, and retries (Kgateway v2.2+) #|
#| NOTE: Prompt guards moved to AgentgatewayPolicy in v2.2 - use spec.backend.ai.promptGuard #|
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: azure-openai-eastus2-chat-policy
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: azure-openai-eastus2-chat

  #| Rate Limiting: 4,500 RPM (Azure GPT-5 tier limits) #|
  rateLimit:
    local:
      tokenBucket:
        maxTokens: 75
        tokensPerFill: 75
        fillInterval: 1s

  #| Timeout: 120s for chat completions #|
  timeouts:
    request: 120s

  #| Retry Policy #|
  retry:
    attempts: 3
    backoffBaseInterval: 1s
    retryOn:
      - 5xx
      - unavailable
      - reset
#% endif %#
#% endif %#
