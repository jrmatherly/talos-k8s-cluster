#% if agentgateway_enabled | default(true) %#
---
#| ============================================================ #|
#| MCP Backend for routing to MCP servers                        #|
#| Uses label selector to dynamically discover MCP server pods   #|
#| Requires Services with appProtocol: kgateway.dev/mcp          #|
#| ============================================================ #|
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: mcp-backend
spec:
  mcp:
    targets:
      - name: mcp-servers
        selector:
          services:
            matchLabels:
              agentgateway.dev/mcp: "true"
---
#| ============================================================ #|
#| HTTPRoute for MCP traffic on HTTPS listener                   #|
#| Routes mcp-gw.<domain> to MCP backend with OAuth authentication #|
#| ============================================================ #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: mcp-route
spec:
  parentRefs:
    - name: agentgateway
      namespace: ai-system
      sectionName: https
  hostnames:
    - "mcp-gw.#{ primary_domain }#"
  rules:
    - backendRefs:
        - group: agentgateway.dev
          kind: AgentgatewayBackend
          name: mcp-backend
---
#| ============================================================ #|
#| HTTPRoute for agentgateway admin UI                           #|
#| Routes /ui, /config, /config_dump path prefixes to admin      #|
#| ============================================================ #|
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: agentgateway-ui
spec:
  parentRefs:
    - name: agentgateway
      namespace: ai-system
      sectionName: https
  hostnames:
    - "mcp-gw.#{ primary_domain }#"
    - "ai-gw.#{ primary_domain }#"
  rules:
    #| Route /ui paths to admin UI service #|
    - matches:
        - path:
            type: PathPrefix
            value: /ui
      backendRefs:
        - name: agentgateway-admin
          port: 15000
    #| Route /config paths to admin UI service #|
    - matches:
        - path:
            type: PathPrefix
            value: /config
      backendRefs:
        - name: agentgateway-admin
          port: 15000
    #| Route /config_dump path to admin UI service #|
    - matches:
        - path:
            type: PathPrefix
            value: /config_dump
      backendRefs:
        - name: agentgateway-admin
          port: 15000
#% if keycloak_enabled %#
---
#| ============================================================ #|
#| AgentgatewayPolicy: MCP OAuth Authentication                  #|
#| MCP backend authentication using Keycloak                     #|
#| RFC 9728, RFC 8707 compliance                                 #|
#| NOTE: Uses K8s Service reference (not kgateway Backend)       #|
#| ============================================================ #|
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: mcp-oauth-authentication
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: mcp-route
  backend:
    mcp:
      authentication:
        issuer: "https://auth.#{ primary_domain }#/realms/k8s-cluster"
        audiences:
          - "https://mcp-gw.#{ primary_domain }#/mcp"
        provider: Keycloak
        jwks:
          #| Full JWKS URI - backendRef not yet implemented in agentgateway #|
          uri: "https://auth.#{ primary_domain }#/realms/k8s-cluster/protocol/openid-connect/certs"
          cacheDuration: "5m"
        #| RFC 9728 OAuth Protected Resource Metadata #|
        resourceMetadata:
          resource: "https://mcp-gw.#{ primary_domain }#/mcp"
          scopesSupported:
            - openid
            - profile
            - email
            - mcp:tools
            - offline_access
          bearerMethodsSupported:
            - header
---
#| ============================================================ #|
#| AgentgatewayPolicy: MCP Route Traffic Settings                #|
#| Rate limiting and timeout configuration for MCP traffic       #|
#| NOTE: Replaces kgateway TrafficPolicy (not compatible)        #|
#| ============================================================ #|
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: mcp-route-traffic
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: mcp-route
  traffic:
    #| Very long timeout for MCP sessions (SSE streams) - 8 hours #|
    #| Note: "0s" is invalid, minimum is 1ms #|
    timeouts:
      request: "8h"
    #| Rate limiting: 100 requests per minute with burst #|
    rateLimit:
      local:
        - requests: 100
          unit: Minutes
          burst: 50
#% endif %#
---
#| ============================================================ #|
#| AgentgatewayPolicy: CORS for MCP                              #|
#| Enables browser-based MCP clients                             #|
#| ============================================================ #|
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: mcp-cors
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: mcp-route
  traffic:
    cors:
      allowOrigins:
        - "https://mcp-gw.#{ primary_domain }#"
        - "https://ai-gw.#{ primary_domain }#"
        - "https://*.#{ primary_domain }#"
        - "http://localhost"
        - "http://localhost:3000"
        - "http://localhost:5173"
        - "http://localhost:8080"
        - "http://127.0.0.1"
        - "http://127.0.0.1:3000"
        - "http://127.0.0.1:5173"
        - "http://127.0.0.1:8080"
      allowMethods:
        - GET
        - POST
        - OPTIONS
      allowHeaders:
        - Authorization
        - Content-Type
        - X-Request-ID
      exposeHeaders:
        - X-Request-ID
        - WWW-Authenticate
      allowCredentials: true
      maxAge: 86400
#% endif %#
