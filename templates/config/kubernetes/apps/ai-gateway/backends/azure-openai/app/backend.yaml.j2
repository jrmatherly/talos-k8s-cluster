#% if ai_gateway_enabled and ai_gateway_azure_deployments %#
#% for deployment in ai_gateway_azure_deployments %#
#% set schema_name = deployment.schema_name | default('AzureOpenAI') %#
---
# AIServiceBackend for Azure deployment: #{ deployment.name }#
apiVersion: aigateway.envoyproxy.io/v1alpha1
kind: AIServiceBackend
metadata:
  name: azure-#{ deployment.name }#
spec:
  schema:
    name: #{ schema_name }#
#% if schema_name == 'AzureOpenAI' %#
    version: "2025-01-01-preview"
#% elif schema_name == 'Cohere' %#
    version: "v2"
#% elif schema_name == 'Anthropic' %#
    version: "v1"
#% else %#
    version: "v1"
#% endif %#
  backendRef:
    name: azure-#{ deployment.name }#
    kind: Backend
    group: gateway.envoyproxy.io
---
# Backend endpoint for Azure: #{ deployment.name }#
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: Backend
metadata:
  name: azure-#{ deployment.name }#
spec:
  endpoints:
    - fqdn:
        hostname: #{ deployment.host }#
        port: 443
---
# BackendTLSPolicy for TLS validation to Azure endpoint: #{ deployment.name }#
apiVersion: gateway.networking.k8s.io/v1alpha3
kind: BackendTLSPolicy
metadata:
  name: azure-#{ deployment.name }#-tls
spec:
  targetRefs:
    - group: gateway.envoyproxy.io
      kind: Backend
      name: azure-#{ deployment.name }#
  validation:
    wellKnownCACertificates: System
    hostname: #{ deployment.host }#
---
# BackendSecurityPolicy for Azure API key authentication: #{ deployment.name }#
# Note: AzureAPIKey injects into 'api-key' header (Azure requirement)
#       APIKey would inject into 'Authorization' header (wrong for Azure)
apiVersion: aigateway.envoyproxy.io/v1alpha1
kind: BackendSecurityPolicy
metadata:
  name: azure-#{ deployment.name }#-auth
spec:
  targetRefs:
    - group: aigateway.envoyproxy.io
      kind: AIServiceBackend
      name: azure-#{ deployment.name }#
#% if schema_name == 'AzureOpenAI' %#
  type: AzureAPIKey
  azureAPIKey:
    secretRef:
      name: azure-#{ deployment.name }#-secret
      namespace: #{ ai_gateway_namespace }#
#% else %#
  # Non-Azure schemas (Cohere, Anthropic via Azure) use standard APIKey
  type: APIKey
  apiKey:
    secretRef:
      name: azure-#{ deployment.name }#-secret
      namespace: #{ ai_gateway_namespace }#
#% endif %#
#% endfor %#
#% endif %#
