#% if minio_enabled | default(false) %#
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: minio
spec:
  interval: 1h
  timeout: 15m
  chart:
    spec:
      chart: minio
      version: "#{ minio_chart_version | default('5.4.0') }#"
      sourceRef:
        kind: HelmRepository
        name: minio
  values:
    # ============================================================
    # Mode Configuration
    # - standalone: Single server, simple setup (default)
    # - distributed: 4+ servers for HA (requires replicas >= 4)
    # ============================================================
    mode: #{ minio_mode | default('standalone') }#
    replicas: #{ minio_replicas | default(1) }#

    # ============================================================
    # Credentials - Use existing secret (SOPS encrypted)
    # ============================================================
    existingSecret: minio-credentials

    # ============================================================
    # Persistence Configuration
    # ============================================================
    persistence:
      enabled: true
#% if minio_storage_class | default('') %#
      storageClass: "#{ minio_storage_class }#"
#% endif %#
      size: #{ minio_storage_size | default('50Gi') }#
      accessMode: ReadWriteOnce

    # ============================================================
    # Service Configuration
    # ============================================================
    service:
      type: ClusterIP
      port: 9000
      # Console port
      consolePort: 9001

    # ============================================================
    # Console (Web UI) Configuration
    # ============================================================
    consoleService:
      type: ClusterIP
      port: 9001

    # ============================================================
    # Resource Configuration
    # ============================================================
    resources:
      requests:
        memory: #{ minio_memory_request | default('512Mi') }#
        cpu: #{ minio_cpu_request | default('100m') }#
      limits:
        memory: #{ minio_memory_limit | default('2Gi') }#

    # ============================================================
    # Security Context
    # ============================================================
    securityContext:
      enabled: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      fsGroupChangePolicy: OnRootMismatch

    # ============================================================
    # Buckets to create on startup
    # ============================================================
    buckets:
#% for bucket in minio_buckets | default([]) %#
      - name: #{ bucket.name }#
        policy: #{ bucket.policy | default('none') }#
        purge: false
#% endfor %#

    # ============================================================
    # Policies to create on startup
    # ============================================================
    policies: []

    # ============================================================
    # Users to create on startup
    # Users are created via post-install job
    # ============================================================
    users:
#% for user in minio_users | default([]) %#
      - accessKey: #{ user.access_key }#
        secretKey: #{ user.secret_key }#
        policy: #{ user.policy | default('readwrite') }#
#% endfor %#

    # ============================================================
    # Metrics Configuration
    # ============================================================
#% if observability_enabled | default(false) %#
    metrics:
      serviceMonitor:
        enabled: true
        additionalLabels:
          release: kube-prometheus-stack
#% endif %#

    # ============================================================
    # Ingress - Disabled (using Gateway API HTTPRoute instead)
    # ============================================================
    ingress:
      enabled: false
    consoleIngress:
      enabled: false
#% endif %#
