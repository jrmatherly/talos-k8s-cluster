#% if apisix_enabled %#
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: apisix
  namespace: apisix-system
spec:
  interval: 1h
  chart:
    spec:
      chart: apisix
      version: "2.12.x"
      sourceRef:
        kind: HelmRepository
        name: apisix
        namespace: apisix-system
  values:
    # Deployment settings (root level per chart structure)
    replicaCount: 3

    # Pod anti-affinity for HA
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/name: apisix
              topologyKey: kubernetes.io/hostname

    # Resources
    resources:
      requests:
        memory: "256Mi"
        cpu: "200m"
      limits:
        memory: "1Gi"
        cpu: "1000m"

    # APISIX configuration
    apisix:
      # DNS resolver for external domains (Azure OpenAI, etc.)
      # Uses cluster DNS (kube-dns) with Cloudflare as fallback
      dns_resolver:
        - "10.43.0.10"    # kube-dns ClusterIP
        - "1.1.1.1"       # Cloudflare DNS (fallback)
        - "8.8.8.8"       # Google DNS (fallback)
      dns_resolver_valid: 30
      resolver_timeout: 5

      # Enable required plugins
      plugins:
        - ai-proxy           # LLM gateway for Azure OpenAI (single backend)
        - ai-proxy-multi     # LLM gateway with load balancing/failover
        - openid-connect
        - proxy-rewrite
        - redirect
        - limit-req
        - limit-conn
        - limit-count
        - prometheus
        - http-logger
        - cors
        - response-rewrite
        - request-validation
        - uri-blocker
        - traffic-split

      # Admin API configuration (under apisix section)
      admin:
        allow:
          # Allow access from pod network (Envoy Gateway proxy)
          ipList:
            - "127.0.0.1/24"
            - "10.0.0.0/8"
            - "172.16.0.0/12"
            - "192.168.0.0/16"
        # Use existing secret for admin credentials
        credentials:
          secretName: apisix-credentials

    # Disable embedded etcd chart (using external StatefulSet)
    etcd:
      enabled: false
      prefix: "/apisix"
      timeout: 30

    # External etcd connection settings (no auth - etcd runs without RBAC)
    externalEtcd:
      host:
        - "http://etcd-0.etcd-headless.apisix-system.svc.cluster.local:2379"
        - "http://etcd-1.etcd-headless.apisix-system.svc.cluster.local:2379"
        - "http://etcd-2.etcd-headless.apisix-system.svc.cluster.local:2379"
      user: ""

    # Gateway service (per chart: service.type, not gateway.type)
    service:
      type: LoadBalancer
      annotations:
        io.cilium/lb-ipam-ips: "#{ apisix_gateway_addr }#"
      http:
        enabled: true
        servicePort: 80
        containerPort: 9080
      tls:
        enabled: true
        servicePort: 443
        containerPort: 9443

    # Admin API service (internal only)
    admin:
      enabled: true
      type: ClusterIP
      port: 9180

    # Disable ingress controller (using declarative config)
    ingressController:
      enabled: false

    # Service Monitor for Prometheus
    serviceMonitor:
      enabled: true
      namespace: apisix-system
      interval: 30s
#% endif %#
