#% if apisix_enabled %#
---
# APISIX API Gateway HelmRelease
# Ref: https://docs.api7.ai/apisix/how-to-guide/ai-gateway/proxy-azure-openai-requests
# Ref: https://github.com/apache/apisix-helm-chart
#
# NOTE: Uses fullCustomConfig to work around Helm chart bug where dns_resolver
# is always commented out in the configmap template.
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: apisix
  namespace: apisix-system
spec:
  interval: 1h
  chart:
    spec:
      chart: apisix
      version: "2.12.x"
      sourceRef:
        kind: HelmRepository
        name: apisix
        namespace: apisix-system
  values:
    # Deployment settings
    replicaCount: 3

    # Pod anti-affinity for HA - spread across nodes
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/name: apisix
              topologyKey: kubernetes.io/hostname

    # Resources - sized for AI Gateway workloads
    resources:
      requests:
        memory: "512Mi"
        cpu: "250m"
      limits:
        memory: "2Gi"
        cpu: "2000m"

    # Full custom config to enable dns_resolver (Helm chart bug workaround)
    # Ref: https://github.com/apache/apisix-helm-chart/blob/master/charts/apisix/templates/configmap.yaml
    apisix:
      fullCustomConfig:
        enabled: true
        config:
          # Core APISIX settings
          apisix:
            node_listen:
              - 9080
            enable_heartbeat: true
            enable_admin: true
            enable_admin_cors: true
            enable_debug: false
            enable_control: true
            control:
              ip: "0.0.0.0"
              port: 9090
            enable_dev_mode: false
            enable_reuseport: true
            enable_ipv6: true
            enable_http2: true
            enable_server_tokens: true
            # Router config - radixtree_host_uri for multi-tenant routing
            router:
              http: radixtree_host_uri
              ssl: radixtree_sni
            proxy_mode: http
            # DNS resolver - CRITICAL for external domains (Azure OpenAI, etc.)
            dns_resolver:
              - "10.43.0.10"    # kube-dns ClusterIP
              - "1.1.1.1"       # Cloudflare DNS (fallback)
              - "8.8.8.8"       # Google DNS (fallback)
            dns_resolver_valid: 30
            resolver_timeout: 5
            # SSL configuration
            ssl:
              enable: false
              listen:
                - port: 9443
                  enable_http3: false
              ssl_protocols: "TLSv1.2 TLSv1.3"
            # Admin API security - IP allowlist
            admin_key_required: true
            allow_admin:
              - "127.0.0.1/24"
              - "10.0.0.0/8"
              - "172.16.0.0/12"
              - "192.168.0.0/16"

          # NGINX configuration
          nginx_config:
            error_log: "/dev/stderr"
            error_log_level: "warn"
            worker_processes: "auto"
            enable_cpu_affinity: true
            worker_rlimit_nofile: 20480
            event:
              worker_connections: 10620
            http:
              enable_access_log: true
              access_log: "/dev/stdout"
              access_log_format: '$remote_addr - $remote_user [$time_local] $http_host \"$request\" $status $body_bytes_sent $request_time \"$http_referer\" \"$http_user_agent\" $upstream_addr $upstream_status $upstream_response_time'
              keepalive_timeout: "60s"
              client_header_timeout: 60s
              client_body_timeout: 60s
              send_timeout: 10s
              underscores_in_headers: "on"
              real_ip_header: "X-Real-IP"
              real_ip_from:
                - "0.0.0.0/0"
              # Larger buffers for LLM payloads
              client_max_body_size: "50m"
              proxy_buffer_size: "64k"
              proxy_buffers: "8 64k"

          # Enabled plugins - comprehensive list for AI Gateway
          # Ref: https://apisix.apache.org/docs/apisix/next/plugins/ai-proxy/
          plugins:
            # AI Gateway plugins
            - ai-proxy           # Azure OpenAI single backend
            - ai-proxy-multi     # Multi-backend LLM routing with failover
            # Authentication plugins
            - openid-connect     # Azure AD / WorkOS SSO
            - key-auth           # API key authentication
            - jwt-auth           # JWT validation
            - basic-auth         # Basic auth (for testing)
            # Traffic control plugins
            - limit-req          # Request rate limiting
            - limit-conn         # Connection limiting
            - limit-count        # Request count limiting (quotas)
            - traffic-split      # A/B testing, canary deployments
            # Transformation plugins
            - proxy-rewrite      # URI/header rewriting
            - response-rewrite   # Response modification
            - redirect           # HTTP redirects
            # Security plugins
            - cors               # CORS headers
            - uri-blocker        # Block specific URIs
            - request-validation # Request schema validation
            - ip-restriction     # IP allowlist/blocklist
            - consumer-restriction # Consumer-based access control
            # Observability plugins
            - prometheus         # Metrics export
            - http-logger        # HTTP request logging
            - file-logger        # File-based logging
            # Utility plugins
            - real-ip            # Extract real client IP
            - request-id         # Add request ID header
            - serverless-pre-function  # Lua pre-processing
            - serverless-post-function # Lua post-processing

          # Deployment configuration - CRITICAL: etcd must be under deployment
          deployment:
            role: traditional
            role_traditional:
              config_provider: etcd
            admin:
              allow_admin:
                - "127.0.0.1/24"
                - "10.0.0.0/8"
                - "172.16.0.0/12"
                - "192.168.0.0/16"
              admin_listen:
                ip: "0.0.0.0"
                port: 9180
              admin_key:
                - name: "admin"
                  key: "$${{APISIX_ADMIN_KEY}}"
                  role: admin
                - name: "viewer"
                  key: "$${{APISIX_VIEWER_KEY}}"
                  role: viewer
            etcd:
              host:
                - "http://etcd-0.etcd-headless.apisix-system.svc.cluster.local:2379"
                - "http://etcd-1.etcd-headless.apisix-system.svc.cluster.local:2379"
                - "http://etcd-2.etcd-headless.apisix-system.svc.cluster.local:2379"
              prefix: "/apisix"
              timeout: 30

      # Admin API credentials from secret
      admin:
        allow:
          ipList:
            - "127.0.0.1/24"
            - "10.0.0.0/8"
            - "172.16.0.0/12"
            - "192.168.0.0/16"
        credentials:
          secretName: apisix-credentials

    # Disable embedded etcd (using external StatefulSet for HA)
    etcd:
      enabled: false

    # External etcd connection
    externalEtcd:
      host:
        - "http://etcd-0.etcd-headless.apisix-system.svc.cluster.local:2379"
        - "http://etcd-1.etcd-headless.apisix-system.svc.cluster.local:2379"
        - "http://etcd-2.etcd-headless.apisix-system.svc.cluster.local:2379"
      user: ""

    # Gateway LoadBalancer service
    service:
      type: LoadBalancer
      annotations:
        io.cilium/lb-ipam-ips: "#{ apisix_gateway_addr }#"
      http:
        enabled: true
        servicePort: 80
        containerPort: 9080
      tls:
        enabled: true
        servicePort: 443
        containerPort: 9443

    # Admin API service (ClusterIP - internal only)
    admin:
      enabled: true
      type: ClusterIP
      port: 9180

    # Disable Ingress Controller (using Admin API for declarative config)
    ingressController:
      enabled: false

    # Prometheus ServiceMonitor
    serviceMonitor:
      enabled: true
      namespace: apisix-system
      interval: 30s
      labels:
        release: kube-prometheus-stack
#% endif %#
