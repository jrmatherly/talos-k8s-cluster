#| Keycloak Realm Configuration Secret (SOPS-encrypted) #|
#| Defines the k8s-cluster realm with MCP client and identity federation #|
#| Contains sensitive IdP client secrets - encrypted at rest #|
#% if mcp_gateway_enabled %#
---
apiVersion: v1
kind: Secret
metadata:
  name: keycloak-realm-config
  labels:
    app: keycloak
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/component: configuration
    app.kubernetes.io/part-of: mcp-gateway
type: Opaque
stringData:
  realm.json: |
    {
      "realm": "#{ keycloak_realm | default('k8s-cluster') }#",
      "enabled": true,
      "sslRequired": "external",
      "registrationAllowed": false,
      "resetPasswordAllowed": true,
      "rememberMe": true,
      "accessTokenLifespan": 3600,
      "ssoSessionIdleTimeout": 1800,
      "ssoSessionMaxLifespan": 36000,
      "offlineSessionIdleTimeout": 2592000,
      "clients": [
        {
          "clientId": "mcp-gateway",
          "name": "MCP Authorization Gateway",
          "enabled": true,
          "publicClient": false,
          "serviceAccountsEnabled": true,
          "authorizationServicesEnabled": true,
          "standardFlowEnabled": true,
          "directAccessGrantsEnabled": false,
          "attributes": {
            "oauth2.token.exchange.grant.enabled": "true",
            "use.resource.indicators": "true"
          }
        },
        {
          "clientId": "envoy-gateway",
          "name": "Envoy Gateway OIDC Client",
          "description": "OIDC client for Envoy Gateway SecurityPolicy authentication",
          "enabled": true,
          "publicClient": false,
          "secret": "#{ keycloak_oidc_client_secret | default(keycloak_admin_password) }#",
          "standardFlowEnabled": true,
          "directAccessGrantsEnabled": false,
          "serviceAccountsEnabled": false,
          "redirectUris": [
            "https://auth.#{ primary_domain }#/oauth2/callback"
          ],
          "webOrigins": [
            "https://*.#{ primary_domain }#"
          ],
          "attributes": {
            "pkce.code.challenge.method": "S256",
            "post.logout.redirect.uris": "https://*.#{ primary_domain }#/*"
          }
        }
      ],
      "identityProviders": [
#% if oidc_entra_enabled %#
        {
          "alias": "microsoft",
          "providerId": "oidc",
          "enabled": true,
          "trustEmail": true,
          "config": {
            "issuer": "https://login.microsoftonline.com/#{ oidc_entra_tenant_id }#/v2.0",
            "authorizationUrl": "https://login.microsoftonline.com/#{ oidc_entra_tenant_id }#/oauth2/v2.0/authorize",
            "tokenUrl": "https://login.microsoftonline.com/#{ oidc_entra_tenant_id }#/oauth2/v2.0/token",
            "clientId": "#{ oidc_entra_client_id }#",
            "clientSecret": "#{ oidc_entra_client_secret }#",
            "clientAuthMethod": "client_secret_post",
            "defaultScope": "openid profile email"
          }
        }#% if oidc_google_enabled or oidc_github_enabled %#,#% endif %#
#% endif %#
#% if oidc_google_enabled %#
        {
          "alias": "google",
          "providerId": "google",
          "enabled": true,
          "trustEmail": true,
          "config": {
            "clientId": "#{ oidc_google_client_id }#",
            "clientSecret": "#{ oidc_google_client_secret }#",
            "defaultScope": "openid profile email"
          }
        }#% if oidc_github_enabled %#,#% endif %#
#% endif %#
#% if oidc_github_enabled %#
        {
          "alias": "github",
          "providerId": "github",
          "enabled": true,
          "trustEmail": true,
          "config": {
            "clientId": "#{ oidc_github_client_id }#",
            "clientSecret": "#{ oidc_github_client_secret }#",
            "defaultScope": "user:email read:org"
          }
        }
#% endif %#
      ]
    }
#% endif %#
