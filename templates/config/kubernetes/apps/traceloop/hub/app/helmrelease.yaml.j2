#% if traceloop_enabled and traceloop_hub_enabled %#
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: traceloop-hub
spec:
  interval: 1h
  chart:
    spec:
      chart: helm
      sourceRef:
        kind: GitRepository
        name: traceloop-hub
      interval: 1h
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    replicaCount: #{ traceloop_hub_replicas | default(2) }#

    # Enterprise Edition - disabled (using OSS mode)
    ee:
      enabled: false

    image:
      repository: docker.io/traceloop/hub
      tag: "0.7.1"
      pullPolicy: IfNotPresent

    service:
      type: ClusterIP
      port: 3100

    resources:
      limits:
        cpu: #{ traceloop_hub_cpu_limit | default('500m') }#
        memory: #{ traceloop_hub_memory_limit | default('512Mi') }#
      requests:
        cpu: #{ traceloop_hub_cpu_request | default('100m') }#
        memory: #{ traceloop_hub_memory_request | default('256Mi') }#

    probes:
      liveness:
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 3
      readiness:
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 3

    # Hub configuration - passed through Helm values
    config:
      providers:
        #% if azure_openai_us_east_api_key and azure_openai_us_east_resource_name %#
        - key: azure-openai-us-east
          type: azure
          api_key: OPENAI_API_KEY_PLACEHOLDER
          resource_name: #{ azure_openai_us_east_resource_name }#
          api_version: "2024-10-21"
        #% endif %#
        #% if azure_openai_us_east2_api_key and azure_openai_us_east2_resource_name %#
        - key: azure-openai-us-east2
          type: azure
          api_key: AZUREAPIKEY2_API_KEY_PLACEHOLDER
          resource_name: #{ azure_openai_us_east2_resource_name }#
          api_version: "2024-10-21"
        #% endif %#
      models:
        #% if azure_openai_us_east_api_key and azure_openai_us_east_resource_name %#
        # Azure OpenAI US East Models
        - key: gpt-4.1
          type: gpt-4.1
          provider: azure-openai-us-east
          deployment: gpt-4.1
        - key: gpt-4.1-nano
          type: gpt-4.1-nano
          provider: azure-openai-us-east
          deployment: gpt-4.1-nano
        - key: gpt-4o-mini
          type: gpt-4o-mini
          provider: azure-openai-us-east
          deployment: gpt-4o-mini
        - key: o3
          type: o3
          provider: azure-openai-us-east
          deployment: o3
        - key: o4-mini
          type: o4-mini
          provider: azure-openai-us-east
          deployment: o4-mini
        - key: text-embedding-3-small
          type: text-embedding-3-small
          provider: azure-openai-us-east
          deployment: text-embedding-3-small
        - key: text-embedding-ada-002
          type: text-embedding-ada-002
          provider: azure-openai-us-east
          deployment: text-embedding-ada-002
        #% endif %#
        #% if azure_openai_us_east2_api_key and azure_openai_us_east2_resource_name %#
        # Azure OpenAI US East2 Models - Chat (120s timeout)
        - key: gpt-5
          type: gpt-5
          provider: azure-openai-us-east2
          deployment: gpt-5
        - key: gpt-5-nano
          type: gpt-5-nano
          provider: azure-openai-us-east2
          deployment: gpt-5-nano
        # Chat with thinking (300s timeout)
        - key: gpt-5-chat
          type: gpt-5-chat
          provider: azure-openai-us-east2
          deployment: gpt-5-chat
        - key: gpt-5.1-chat
          type: gpt-5.1-chat
          provider: azure-openai-us-east2
          deployment: gpt-5.1-chat
        # Chat April preview (120s timeout)
        - key: gpt-5-mini
          type: gpt-5-mini
          provider: azure-openai-us-east2
          deployment: gpt-5-mini
        - key: gpt-5.1
          type: gpt-5.1
          provider: azure-openai-us-east2
          deployment: gpt-5.1
        # Codex models (180s timeout)
        - key: gpt-5.1-codex
          type: gpt-5.1-codex
          provider: azure-openai-us-east2
          deployment: gpt-5.1-codex
        - key: gpt-5.1-codex-mini
          type: gpt-5.1-codex-mini
          provider: azure-openai-us-east2
          deployment: gpt-5.1-codex-mini
        # Audio models (180s timeout)
        - key: gpt-audio
          type: gpt-audio
          provider: azure-openai-us-east2
          deployment: gpt-audio
        - key: gpt-audio-mini
          type: gpt-audio-mini
          provider: azure-openai-us-east2
          deployment: gpt-audio-mini
        # Embedding models (60s timeout)
        - key: text-embedding-3-large
          type: text-embedding-3-large
          provider: azure-openai-us-east2
          deployment: text-embedding-3-large
        #% endif %#
      pipelines:
        - name: default
          type: chat
          plugins:
            - logging:
                level: info
            - model-router:
                models:
                  #% if azure_openai_us_east_api_key and azure_openai_us_east_resource_name %#
                  # US East - Chat models
                  - gpt-4.1
                  - gpt-4.1-nano
                  - gpt-4o-mini
                  # US East - Reasoning models
                  - o3
                  - o4-mini
                  #% endif %#
                  #% if azure_openai_us_east2_api_key and azure_openai_us_east2_resource_name %#
                  # US East2 - Chat models
                  - gpt-5
                  - gpt-5-nano
                  # US East2 - Chat with thinking
                  - gpt-5-chat
                  - gpt-5.1-chat
                  # US East2 - Chat April preview
                  - gpt-5-mini
                  - gpt-5.1
                  # US East2 - Codex models
                  - gpt-5.1-codex
                  - gpt-5.1-codex-mini
                  # US East2 - Audio models
                  - gpt-audio
                  - gpt-audio-mini
                  #% endif %#
        - name: embeddings
          type: embeddings
          plugins:
            - model-router:
                models:
                  #% if azure_openai_us_east_api_key and azure_openai_us_east_resource_name %#
                  - text-embedding-3-small
                  - text-embedding-ada-002
                  #% endif %#
                  #% if azure_openai_us_east2_api_key and azure_openai_us_east2_resource_name %#
                  - text-embedding-3-large
                  #% endif %#

    # Secret management - use existing secret for API keys
    # NOTE: openaiApiKey is required by the Helm chart init container (not optional)
    # When using Azure-only, we point it to the Azure US East key as a workaround
    secrets:
      existingSecretName: traceloop-hub-api-keys
      keyMapping:
        #% if traceloop_openai_api_key is defined and traceloop_openai_api_key %#
        openaiApiKey: "OPENAI_API_KEY"
        #% elif azure_openai_us_east_api_key %#
        # Workaround: Helm chart requires openaiApiKey - use Azure key as placeholder
        openaiApiKey: "AZURE_OPENAI_US_EAST_API_KEY"
        #% elif azure_openai_us_east2_api_key %#
        openaiApiKey: "AZURE_OPENAI_US_EAST2_API_KEY"
        #% endif %#
        #% if azure_openai_us_east_api_key %#
        azureApiKey: "AZURE_OPENAI_US_EAST_API_KEY"
        #% endif %#
        #% if azure_openai_us_east2_api_key %#
        azureApiKey2: "AZURE_OPENAI_US_EAST2_API_KEY"
        #% endif %#
        #% if traceloop_anthropic_api_key is defined and traceloop_anthropic_api_key %#
        anthropicApiKey: "ANTHROPIC_API_KEY"
        #% endif %#

    # Management API (PostgreSQL-backed) - disabled for Phase 1
    management:
      enabled: false

    nodeSelector: {}
    tolerations: []
    affinity: {}
#% endif %#
