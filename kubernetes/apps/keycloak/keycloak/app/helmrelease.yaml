---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: keycloak
spec:
  chart:
    spec:
      chart: keycloak
      version: "18.10.0"
      sourceRef:
        kind: HelmRepository
        name: codecentric
  interval: 1h
  timeout: 15m
  values:
    # ============================================================
    # Image Configuration - Use official Keycloak image
    # ============================================================
    image:
      repository: quay.io/keycloak/keycloak
      tag: "26.4.7"

    # ============================================================
    # Replicas for HA
    # ============================================================
    replicas: 2

    # ============================================================
    # Command - Run in production mode
    # ============================================================
    command:
      - "/opt/keycloak/bin/kc.sh"
      - "start"
      - "--http-enabled=true"

    # ============================================================
    # PostgreSQL Database - Disabled (using external CloudNativePG)
    # ============================================================
    postgresql:
      enabled: false

    # ============================================================
    # Database Configuration via Environment Variables
    # ============================================================
    extraEnv: |
      - name: KC_DB
        value: postgres
      - name: KC_DB_URL_HOST
        value: keycloak-db-rw.keycloak.svc.cluster.local
      - name: KC_DB_URL_PORT
        value: "5432"
      - name: KC_DB_URL_DATABASE
        value: keycloak
      - name: KC_DB_USERNAME
        value: keycloak
      - name: KC_DB_PASSWORD
        valueFrom:
          secretKeyRef:
            name: keycloak-db-secret
            key: password
      - name: KEYCLOAK_ADMIN
        value: admin
      - name: KEYCLOAK_ADMIN_PASSWORD
        valueFrom:
          secretKeyRef:
            name: keycloak-secret
            key: admin-password
      - name: KC_HOSTNAME
        value: "https://auth.${SECRET_DOMAIN}"
      - name: KC_HOSTNAME_ADMIN
        value: "https://auth.${SECRET_DOMAIN}"
      - name: KC_PROXY_HEADERS
        value: "xforwarded"
      - name: KC_HTTP_ENABLED
        value: "true"
      - name: KC_SPI_STICKY_SESSION_ENCODER_INFINISPAN_SHOULD_ATTACH_ROUTE
        value: "false"
      - name: KC_HEALTH_ENABLED
        value: "true"
      - name: KC_METRICS_ENABLED
        value: "true"
      # Clustering - DNS_PING for Kubernetes
      - name: JAVA_OPTS_APPEND
        value: "-Djgroups.dns.query=keycloak-headless.keycloak.svc.cluster.local"

    # ============================================================
    # Service Configuration
    # ============================================================
    service:
      type: ClusterIP
      httpPort: 8080
      httpsPort: 8443
      # Note: Keycloak 26 management port is 9000, but chart defaults to 9990
      httpManagementPort: 9000

    # ============================================================
    # Resource Limits
    # ============================================================
    resources:
      requests:
        cpu: "250m"
        memory: "512Mi"
      limits:
        cpu: "1000m"
        memory: "1Gi"

    # ============================================================
    # Startup/Liveness/Readiness Probes (Keycloak 26 management port 9000)
    # ============================================================
    startupProbe: |
      httpGet:
        path: /health/started
        port: 9000
      initialDelaySeconds: 30
      timeoutSeconds: 5
      periodSeconds: 10
      failureThreshold: 30

    livenessProbe: |
      httpGet:
        path: /health/live
        port: 9000
      initialDelaySeconds: 0
      timeoutSeconds: 5
      periodSeconds: 10
      failureThreshold: 3

    readinessProbe: |
      httpGet:
        path: /health/ready
        port: 9000
      initialDelaySeconds: 10
      timeoutSeconds: 5
      periodSeconds: 10
      failureThreshold: 3

    # ============================================================
    # Metrics for Prometheus - ServiceMonitor
    # ============================================================
    serviceMonitor:
      enabled: true
      namespace: keycloak
      labels:
        release: kube-prometheus-stack
      path: /metrics
      port: http

    # ============================================================
    # Security Context
    # ============================================================
    securityContext:
      fsGroup: 1000

    podSecurityContext:
      runAsUser: 1000
      runAsNonRoot: true

    # ============================================================
    # Network Policy Labels for CCNP tiered policies
    # ============================================================
    podLabels:
      network.cilium.io/api-access: "true"
