---
# ConfigMap containing the k8s-cluster realm configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-realm-config
data:
  k8s-cluster-realm.json: |
    {
      "realm": "k8s-cluster",
      "enabled": true,
      "displayName": "Kubernetes Cluster",
      "displayNameHtml": "<strong>Kubernetes Cluster</strong>",
      "sslRequired": "external",
      "registrationAllowed": false,
      "loginWithEmailAllowed": true,
      "duplicateEmailsAllowed": false,
      "resetPasswordAllowed": true,
      "editUsernameAllowed": false,
      "bruteForceProtected": true,
      "permanentLockout": false,
      "maxFailureWaitSeconds": 900,
      "minimumQuickLoginWaitSeconds": 60,
      "waitIncrementSeconds": 60,
      "quickLoginCheckMilliSeconds": 1000,
      "maxDeltaTimeSeconds": 43200,
      "failureFactor": 5,
      "defaultSignatureAlgorithm": "RS256",
      "accessTokenLifespan": 300,
      "accessTokenLifespanForImplicitFlow": 900,
      "ssoSessionIdleTimeout": 1800,
      "ssoSessionMaxLifespan": 36000,
      "offlineSessionIdleTimeout": 2592000,
      "accessCodeLifespan": 60,
      "accessCodeLifespanUserAction": 300,
      "accessCodeLifespanLogin": 1800,
      "actionTokenGeneratedByAdminLifespan": 43200,
      "actionTokenGeneratedByUserLifespan": 300,
      "clients": [
        {
          "clientId": "account",
          "name": "Account Management",
          "enabled": true,
          "publicClient": true,
          "standardFlowEnabled": true,
          "directAccessGrantsEnabled": false,
          "redirectUris": [
            "https://auth.matherly.net/realms/k8s-cluster/account/*"
          ],
          "webOrigins": ["*"],
          "attributes": {}
        },
        {
          "clientId": "account-console",
          "name": "Account Console",
          "enabled": true,
          "publicClient": true,
          "standardFlowEnabled": true,
          "directAccessGrantsEnabled": false,
          "redirectUris": [
            "https://auth.matherly.net/realms/k8s-cluster/account/*"
          ],
          "webOrigins": ["*"],
          "attributes": {
            "pkce.code.challenge.method": "S256"
          }
        },
        {
          "clientId": "kgateway",
          "name": "kgateway OIDC Client",
          "description": "OIDC client for kgateway SecurityPolicy authentication",
          "enabled": true,
          "clientAuthenticatorType": "client-secret",
          "secret": "YKFIU9KVXEc6kKYciTVPmWkSnYKQjqQu",
          "redirectUris": [
            "https://sso.matherly.net/oauth2/redirect"
          ],
          "webOrigins": [
            "https://*.matherly.net"
          ],
          "protocol": "openid-connect",
          "publicClient": false,
          "bearerOnly": false,
          "consentRequired": false,
          "standardFlowEnabled": true,
          "implicitFlowEnabled": false,
          "directAccessGrantsEnabled": false,
          "serviceAccountsEnabled": false,
          "authorizationServicesEnabled": false,
          "fullScopeAllowed": true,
          "defaultClientScopes": [
            "web-origins",
            "profile",
            "roles",
            "email"
          ],
          "optionalClientScopes": [
            "address",
            "phone",
            "offline_access"
          ],
          "attributes": {
            "pkce.code.challenge.method": "S256",
            "post.logout.redirect.uris": "https://*.matherly.net/*"
          }
        },
        {
          "clientId": "agentgateway-mcp",
          "name": "agentgateway MCP OAuth Client",
          "description": "OAuth client for agentgateway MCP authentication proxy - MCP 2025-11-25 compliant",
          "enabled": true,
          "clientAuthenticatorType": "client-secret",
          "secret": "ieZAAJ8H0joNsCKWwsYHXOQ5sNSkjoUP",
          "redirectUris": [
            "https://mcp-gw.matherly.net/*",
            "https://ai-gw.matherly.net/*",
            "http://localhost:*",
            "http://127.0.0.1:*"
          ],
          "webOrigins": [
            "https://mcp-gw.matherly.net",
            "https://ai-gw.matherly.net",
            "https://*.matherly.net",
            "http://localhost",
            "http://127.0.0.1"
          ],
          "protocol": "openid-connect",
          "publicClient": false,
          "bearerOnly": false,
          "consentRequired": false,
          "standardFlowEnabled": true,
          "implicitFlowEnabled": false,
          "directAccessGrantsEnabled": false,
          "serviceAccountsEnabled": true,
          "authorizationServicesEnabled": false,
          "fullScopeAllowed": true,
          "defaultClientScopes": [
            "web-origins",
            "profile",
            "roles",
            "email",
            "offline_access",
            "mcp:tools"
          ],
          "optionalClientScopes": [
            "address",
            "phone"
          ],
          "protocolMappers": [
            {
              "name": "mcp-resource-audience",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-audience-mapper",
              "consentRequired": false,
              "config": {
                "included.client.audience": "",
                "included.custom.audience": "https://mcp-gw.matherly.net/mcp",
                "id.token.claim": "true",
                "access.token.claim": "true"
              }
            }
          ],
          "attributes": {
            "pkce.code.challenge.method": "S256",
            "post.logout.redirect.uris": "https://mcp-gw.matherly.net/*++https://ai-gw.matherly.net/*",
            "oauth2.device.authorization.grant.enabled": "true",
            "backchannel.logout.session.required": "true",
            "display.on.consent.screen": "false"
          }
        },
        {
          "clientId": "obot",
          "name": "obot AI Agent Platform",
          "description": "OIDC client for obot AI agent platform authentication",
          "enabled": true,
          "clientAuthenticatorType": "client-secret",
          "secret": "x8KqR7mN3pJ5vW9cL2fB6hY4tE1sA0gZ",
          "redirectUris": [
            "https://obot.matherly.net/oauth2/callback",
            "https://obot.matherly.net/*"
          ],
          "webOrigins": [
            "https://obot.matherly.net",
            "https://*.matherly.net"
          ],
          "protocol": "openid-connect",
          "publicClient": false,
          "bearerOnly": false,
          "consentRequired": false,
          "standardFlowEnabled": true,
          "implicitFlowEnabled": false,
          "directAccessGrantsEnabled": false,
          "serviceAccountsEnabled": false,
          "authorizationServicesEnabled": false,
          "fullScopeAllowed": true,
          "defaultClientScopes": [
            "web-origins",
            "profile",
            "roles",
            "email",
            "offline_access"
          ],
          "optionalClientScopes": [
            "address",
            "phone"
          ],
          "protocolMappers": [
            {
              "name": "obot-audience",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-audience-mapper",
              "consentRequired": false,
              "config": {
                "included.client.audience": "obot",
                "id.token.claim": "true",
                "access.token.claim": "true"
              }
            },
            {
              "name": "email-verified",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-attribute-mapper",
              "consentRequired": false,
              "config": {
                "user.attribute": "emailVerified",
                "claim.name": "email_verified",
                "jsonType.label": "boolean",
                "id.token.claim": "true",
                "access.token.claim": "true",
                "userinfo.token.claim": "true"
              }
            },
            {
              "name": "picture",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-attribute-mapper",
              "consentRequired": false,
              "config": {
                "user.attribute": "picture",
                "claim.name": "picture",
                "jsonType.label": "String",
                "id.token.claim": "true",
                "access.token.claim": "true",
                "userinfo.token.claim": "true"
              }
            },
            {
              "name": "full-name",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-full-name-mapper",
              "consentRequired": false,
              "config": {
                "id.token.claim": "true",
                "access.token.claim": "true",
                "userinfo.token.claim": "true"
              }
            }
          ],
          "attributes": {
            "pkce.code.challenge.method": "S256",
            "post.logout.redirect.uris": "https://obot.matherly.net/*",
            "backchannel.logout.session.required": "true",
            "display.on.consent.screen": "false"
          }
        }      ],
      "roles": {
        "realm": [
          {
            "name": "admin",
            "description": "Cluster administrator with full access",
            "composite": false
          },
          {
            "name": "developer",
            "description": "Developer with limited cluster access",
            "composite": false
          },
          {
            "name": "viewer",
            "description": "Read-only access to cluster resources",
            "composite": false
          }
        ]
      },
      "groups": [
        {
          "name": "cluster-admins",
          "path": "/cluster-admins",
          "realmRoles": ["admin"]
        },
        {
          "name": "developers",
          "path": "/developers",
          "realmRoles": ["developer"]
        },
        {
          "name": "viewers",
          "path": "/viewers",
          "realmRoles": ["viewer"]
        }
      ],
      "scopeMappings": [],
      "clientScopeMappings": {},
      "clientScopes": [
        {
          "name": "mcp:tools",
          "description": "MCP Tool Server Access - Enables RFC 8707 audience restriction for MCP clients",
          "protocol": "openid-connect",
          "attributes": {
            "include.in.token.scope": "true",
            "display.on.consent.screen": "true",
            "consent.screen.text": "Access to MCP tool servers"
          },
          "protocolMappers": [
            {
              "name": "mcp-resource-audience",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-audience-mapper",
              "consentRequired": false,
              "config": {
                "included.client.audience": "",
                "included.custom.audience": "https://mcp-gw.matherly.net/mcp",
                "id.token.claim": "true",
                "access.token.claim": "true"
              }
            }
          ]
        }
      ],
      "identityProviders": [
        {
          "alias": "entra-id",
          "displayName": "Microsoft Entra ID",
          "providerId": "oidc",
          "enabled": true,
          "trustEmail": true,
          "storeToken": false,
          "addReadTokenRoleOnCreate": false,
          "linkOnly": false,
          "firstBrokerLoginFlowAlias": "first broker login",
          "config": {
            "useJwksUrl": "true",
            "syncMode": "FORCE",
            "clientAuthMethod": "client_secret_post",
            "clientId": "5a39e93b-5781-4305-b6c5-848ec1369957",
            "clientSecret": "$$(env:ENTRA_ID_CLIENT_SECRET)",
            "defaultScope": "openid profile email",
            "authorizationUrl": "https://login.microsoftonline.com/f505346f-75cf-458b-baeb-10708d41967d/oauth2/v2.0/authorize",
            "tokenUrl": "https://login.microsoftonline.com/f505346f-75cf-458b-baeb-10708d41967d/oauth2/v2.0/token",
            "logoutUrl": "https://login.microsoftonline.com/f505346f-75cf-458b-baeb-10708d41967d/oauth2/v2.0/logout",
            "jwksUrl": "https://login.microsoftonline.com/f505346f-75cf-458b-baeb-10708d41967d/discovery/v2.0/keys",
            "userInfoUrl": "https://graph.microsoft.com/oidc/userinfo",
            "issuer": "https://login.microsoftonline.com/f505346f-75cf-458b-baeb-10708d41967d/v2.0",
            "validateSignature": "true",
            "pkceEnabled": "true",
            "pkceMethod": "S256"
          }
        },        {
          "alias": "google",
          "displayName": "Google",
          "providerId": "google",
          "enabled": true,
          "trustEmail": true,
          "storeToken": false,
          "addReadTokenRoleOnCreate": false,
          "linkOnly": false,
          "firstBrokerLoginFlowAlias": "first broker login",
          "config": {
            "clientId": "976645342576-h0l683golj85f3jse02oe48dhkeq33nf.apps.googleusercontent.com",
            "clientSecret": "$$(env:GOOGLE_CLIENT_SECRET)",
            "defaultScope": "openid profile email",
            "syncMode": "FORCE"
          }
        }      ],
      "identityProviderMappers": [
        {
          "name": "entra-id-email",
          "identityProviderAlias": "entra-id",
          "identityProviderMapper": "oidc-user-attribute-idp-mapper",
          "config": {
            "syncMode": "INHERIT",
            "claim": "email",
            "user.attribute": "email"
          }
        },
        {
          "name": "entra-id-first-name",
          "identityProviderAlias": "entra-id",
          "identityProviderMapper": "oidc-user-attribute-idp-mapper",
          "config": {
            "syncMode": "INHERIT",
            "claim": "given_name",
            "user.attribute": "firstName"
          }
        },
        {
          "name": "entra-id-last-name",
          "identityProviderAlias": "entra-id",
          "identityProviderMapper": "oidc-user-attribute-idp-mapper",
          "config": {
            "syncMode": "INHERIT",
            "claim": "family_name",
            "user.attribute": "lastName"
          }
        },
        {
          "name": "entra-id-username",
          "identityProviderAlias": "entra-id",
          "identityProviderMapper": "oidc-username-idp-mapper",
          "config": {
            "syncMode": "INHERIT",
            "template": "$${CLAIM.preferred_username}"
          }
        },
        {
          "name": "entra-id-manage-account-role",
          "identityProviderAlias": "entra-id",
          "identityProviderMapper": "oidc-hardcoded-role-idp-mapper",
          "config": {
            "syncMode": "FORCE",
            "role": "account.manage-account"
          }
        },
        {
          "name": "entra-id-view-profile-role",
          "identityProviderAlias": "entra-id",
          "identityProviderMapper": "oidc-hardcoded-role-idp-mapper",
          "config": {
            "syncMode": "FORCE",
            "role": "account.view-profile"
          }
        },        {
          "name": "google-email",
          "identityProviderAlias": "google",
          "identityProviderMapper": "oidc-user-attribute-idp-mapper",
          "config": {
            "syncMode": "INHERIT",
            "claim": "email",
            "user.attribute": "email"
          }
        },
        {
          "name": "google-first-name",
          "identityProviderAlias": "google",
          "identityProviderMapper": "oidc-user-attribute-idp-mapper",
          "config": {
            "syncMode": "INHERIT",
            "claim": "given_name",
            "user.attribute": "firstName"
          }
        },
        {
          "name": "google-last-name",
          "identityProviderAlias": "google",
          "identityProviderMapper": "oidc-user-attribute-idp-mapper",
          "config": {
            "syncMode": "INHERIT",
            "claim": "family_name",
            "user.attribute": "lastName"
          }
        },
        {
          "name": "google-picture",
          "identityProviderAlias": "google",
          "identityProviderMapper": "oidc-user-attribute-idp-mapper",
          "config": {
            "syncMode": "INHERIT",
            "claim": "picture",
            "user.attribute": "picture"
          }
        },
        {
          "name": "google-manage-account-role",
          "identityProviderAlias": "google",
          "identityProviderMapper": "oidc-hardcoded-role-idp-mapper",
          "config": {
            "syncMode": "FORCE",
            "role": "account.manage-account"
          }
        },
        {
          "name": "google-view-profile-role",
          "identityProviderAlias": "google",
          "identityProviderMapper": "oidc-hardcoded-role-idp-mapper",
          "config": {
            "syncMode": "FORCE",
            "role": "account.view-profile"
          }
        }      ]
    }
---
# Job to import the realm configuration using keycloak-config-cli
apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-realm-import-v25
  annotations:
    # Re-create job with new name when config changes (jobs are immutable)
    config-version: "24"
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/component: realm-import
    spec:
      restartPolicy: OnFailure
      containers:
        - name: keycloak-config-cli
          image: quay.io/adorsys/keycloak-config-cli:latest-26
          env:
            - name: KEYCLOAK_URL
              value: "http://keycloak-http.keycloak.svc.cluster.local:8080"
            - name: KEYCLOAK_USER
              value: "admin"
            - name: KEYCLOAK_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-secret
                  key: admin-password
            - name: KEYCLOAK_AVAILABILITYCHECK_ENABLED
              value: "true"
            - name: KEYCLOAK_AVAILABILITYCHECK_TIMEOUT
              value: "120s"
            - name: IMPORT_VARSUBSTITUTION_ENABLED
              value: "true"
            - name: ENTRA_ID_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: keycloak-secret
                  key: entra-id-client-secret
            - name: GOOGLE_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: keycloak-secret
                  key: google-client-secret
            - name: IMPORT_MANAGED_CLIENT
              value: "no-delete"
            - name: IMPORT_MANAGED_GROUP
              value: "full"
            - name: IMPORT_MANAGED_ROLE
              value: "full"
            - name: IMPORT_MANAGED_IDENTITY_PROVIDER_MAPPER
              value: "full"
            - name: IMPORT_FILES_LOCATIONS
              value: "/config/*"
          volumeMounts:
            - name: realm-config
              mountPath: /config
              readOnly: true
      volumes:
        - name: realm-config
          configMap:
            name: keycloak-realm-config
