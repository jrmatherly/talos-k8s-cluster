---
# CloudNativePG Cluster for Keycloak
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: keycloak-db
spec:
  instances: 3

  # ============================================================
  # Storage Configuration
  # ============================================================
  storage:
    size: 10Gi
    storageClass: proxmox-csi

  # ============================================================
  # PostgreSQL Configuration
  # ============================================================
  postgresql:
    parameters:
      max_connections: "100"
      shared_buffers: "256MB"
      effective_cache_size: "512MB"
      maintenance_work_mem: "64MB"
      checkpoint_completion_target: "0.9"
      wal_buffers: "16MB"
      default_statistics_target: "100"
      random_page_cost: "1.1"
      effective_io_concurrency: "200"

  # ============================================================
  # Bootstrap Configuration
  # ============================================================
  bootstrap:
    initdb:
      database: keycloak
      owner: keycloak
      secret:
        name: keycloak-db-secret

  # ============================================================
  # Backup Configuration (optional - can be enabled later)
  # ============================================================
  # backup:
  #   barmanObjectStore:
  #     destinationPath: "s3://keycloak-backups/"
  #     endpointURL: "https://s3.example.com"
  #     s3Credentials:
  #       accessKeyId:
  #         name: keycloak-s3-credentials
  #         key: ACCESS_KEY_ID
  #       secretAccessKey:
  #         name: keycloak-s3-credentials
  #         key: SECRET_ACCESS_KEY

  # ============================================================
  # Monitoring
  # ============================================================
  monitoring:
    enablePodMonitor: true

  # ============================================================
  # Resources
  # ============================================================
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"

  # ============================================================
  # Node Affinity (if required)
  # ============================================================
  # affinity:
  #   podAntiAffinity:
  #     requiredDuringSchedulingIgnoredDuringExecution:
  #       - labelSelector:
  #           matchExpressions:
  #             - key: cnpg.io/cluster
  #               operator: In
  #               values:
  #                 - keycloak-db
  #         topologyKey: kubernetes.io/hostname
