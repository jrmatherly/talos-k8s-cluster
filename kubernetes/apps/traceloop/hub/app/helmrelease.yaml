---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: traceloop-hub
spec:
  interval: 1h
  chart:
    spec:
      chart: helm
      sourceRef:
        kind: GitRepository
        name: traceloop-hub
      interval: 1h
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    replicaCount: 2

    # Enterprise Edition - disabled (using OSS mode)
    ee:
      enabled: false

    image:
      repository: docker.io/traceloop/hub
      pullPolicy: IfNotPresent

    service:
      type: ClusterIP
      port: 3100

    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi

    probes:
      liveness:
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 3
      readiness:
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 3

    # Hub configuration - passed through Helm values
    config:
      providers:
        - key: azure-openai-us-east
          type: azure
          api_key: OPENAI_API_KEY_PLACEHOLDER
          resource_name: aaronsai
          api_version: "2024-10-21"
        - key: azure-openai-us-east2
          type: azure
          api_key: AZUREAPIKEY2_API_KEY_PLACEHOLDER
          resource_name: ets-east-us2
          api_version: "2024-10-21"
      models:
        # Azure OpenAI US East Models
        - key: gpt-4.1
          type: gpt-4.1
          provider: azure-openai-us-east
          deployment: gpt-4.1
        - key: gpt-4.1-nano
          type: gpt-4.1-nano
          provider: azure-openai-us-east
          deployment: gpt-4.1-nano
        - key: gpt-4o-mini
          type: gpt-4o-mini
          provider: azure-openai-us-east
          deployment: gpt-4o-mini
        - key: o3
          type: o3
          provider: azure-openai-us-east
          deployment: o3
        - key: o4-mini
          type: o4-mini
          provider: azure-openai-us-east
          deployment: o4-mini
        - key: text-embedding-3-small
          type: text-embedding-3-small
          provider: azure-openai-us-east
          deployment: text-embedding-3-small
        # Azure OpenAI US East2 Models
        - key: gpt-5
          type: gpt-5
          provider: azure-openai-us-east2
          deployment: gpt-5
        - key: gpt-5-nano
          type: gpt-5-nano
          provider: azure-openai-us-east2
          deployment: gpt-5-nano
        - key: gpt-5.1-codex
          type: gpt-5.1-codex
          provider: azure-openai-us-east2
          deployment: gpt-5.1-codex
        - key: text-embedding-3-large
          type: text-embedding-3-large
          provider: azure-openai-us-east2
          deployment: text-embedding-3-large
      pipelines:
        - name: default
          type: chat
          plugins:
            - logging:
                level: info
            - model-router:
                models:
                  - gpt-4.1
                  - gpt-4.1-nano
                  - gpt-4o-mini
                  - gpt-5
                  - gpt-5-nano
        - name: embeddings
          type: embeddings
          plugins:
            - model-router:
                models:
                  - text-embedding-3-small
                  - text-embedding-3-large

    # Secret management - use existing secret for API keys
    # NOTE: openaiApiKey is required by the Helm chart init container (not optional)
    # When using Azure-only, we point it to the Azure US East key as a workaround
    secrets:
      existingSecretName: traceloop-hub-api-keys
      keyMapping:
        # Workaround: Helm chart requires openaiApiKey - use Azure key as placeholder
        openaiApiKey: "AZURE_OPENAI_US_EAST_API_KEY"
        azureApiKey: "AZURE_OPENAI_US_EAST_API_KEY"
        azureApiKey2: "AZURE_OPENAI_US_EAST2_API_KEY"

    # Management API (PostgreSQL-backed) - disabled for Phase 1
    management:
      enabled: false

    nodeSelector: {}
    tolerations: []
    affinity: {}
