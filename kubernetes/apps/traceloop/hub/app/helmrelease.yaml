---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: traceloop-hub
spec:
  interval: 1h
  chart:
    spec:
      chart: helm
      sourceRef:
        kind: GitRepository
        name: traceloop-hub
      interval: 1h
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    replicaCount: 2

    image:
      repository: docker.io/traceloop/hub
      pullPolicy: IfNotPresent

    service:
      type: ClusterIP
      port: 3100

    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi

    probes:
      liveness:
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 3
      readiness:
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 3

    # Use ConfigMap for hub configuration
    env:
      - name: CONFIG_FILE_PATH
        value: /etc/hub/config.yaml

    # Mount the ConfigMap as a volume
    extraVolumes:
      - name: hub-config
        configMap:
          name: traceloop-hub-config

    extraVolumeMounts:
      - name: hub-config
        mountPath: /etc/hub
        readOnly: true

    # Secret management - use existing secret for API keys
    secrets:
      existingSecretName: traceloop-hub-api-keys
      keyMapping:
        azureApiKey: "AZURE_OPENAI_US_EAST_API_KEY"
        azureApiKey2: "AZURE_OPENAI_US_EAST2_API_KEY"

    # Management API (PostgreSQL-backed) - disabled for Phase 1
    management:
      enabled: false

    nodeSelector: {}
    tolerations: []
    affinity: {}
