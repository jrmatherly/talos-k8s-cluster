---
# AIGatewayRoute for Azure AI model routing
# Note: In v0.4.0, when group is specified in backendRefs, only InferencePool is supported.
#       For AIServiceBackend, omit group and kind fields - they default correctly.
apiVersion: aigateway.envoyproxy.io/v1alpha1
kind: AIGatewayRoute
metadata:
  name: azure-ai
spec:
  parentRefs:
    - name: ai-gateway
      kind: Gateway
      group: gateway.networking.k8s.io
  # Token usage tracking for rate limiting
  # These metadata keys are used by BackendTrafficPolicy to enforce token-based limits
  llmRequestCosts:
    - metadataKey: llm_input_token
      type: InputToken
    - metadataKey: llm_output_token
      type: OutputToken
    - metadataKey: llm_total_token
      type: TotalToken
  rules:
    # Route for model: gpt-4.1 via deployment: primary
    - matches:
        - headers:
            - type: Exact
              name: x-ai-eg-model
              value: gpt-4.1
      backendRefs:
        - name: azure-primary
    # Route for model: gpt-4.1-nano via deployment: primary
    - matches:
        - headers:
            - type: Exact
              name: x-ai-eg-model
              value: gpt-4.1-nano
      backendRefs:
        - name: azure-primary
    # Route for model: gpt-4o-mini via deployment: primary
    - matches:
        - headers:
            - type: Exact
              name: x-ai-eg-model
              value: gpt-4o-mini
      backendRefs:
        - name: azure-primary
    # Route for model: o3 via deployment: primary
    - matches:
        - headers:
            - type: Exact
              name: x-ai-eg-model
              value: o3
      backendRefs:
        - name: azure-primary
    # Route for model: o4-mini via deployment: primary
    - matches:
        - headers:
            - type: Exact
              name: x-ai-eg-model
              value: o4-mini
      backendRefs:
        - name: azure-primary
    # Route for model: text-embedding-3-small via deployment: primary
    - matches:
        - headers:
            - type: Exact
              name: x-ai-eg-model
              value: text-embedding-3-small
      backendRefs:
        - name: azure-primary
    # Route for model: text-embedding-ada-002 via deployment: primary
    - matches:
        - headers:
            - type: Exact
              name: x-ai-eg-model
              value: text-embedding-ada-002
      backendRefs:
        - name: azure-primary
    # Route for model: gpt-5-nano via deployment: secondary
    - matches:
        - headers:
            - type: Exact
              name: x-ai-eg-model
              value: gpt-5-nano
      backendRefs:
        - name: azure-secondary
    # Route for model: gpt-5-mini via deployment: secondary
    - matches:
        - headers:
            - type: Exact
              name: x-ai-eg-model
              value: gpt-5-mini
      backendRefs:
        - name: azure-secondary
    # Route for model: cohere-rerank-v3.5 via deployment: cohere
    - matches:
        - headers:
            - type: Exact
              name: x-ai-eg-model
              value: cohere-rerank-v3.5
      backendRefs:
        - name: azure-cohere
