---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: vector
spec:
  chart:
    spec:
      chart: vector
      version: "0.46.0"
      sourceRef:
        kind: HelmRepository
        name: vector
  interval: 1h
  values:
    role: Agent
    podHostNetwork: true
    dnsPolicy: ClusterFirstWithHostNet
    podLabels:
      network.cilium.io/api-access: "true"
    resources:
      requests:
        cpu: "50m"
        memory: "128Mi"
      limits:
        cpu: "200m"
        memory: "512Mi"
    containerPorts:
      - name: talos-kernel
        containerPort: 6050
        protocol: UDP
      - name: talos-service
        containerPort: 6051
        protocol: UDP
    customConfig:
      data_dir: /vector-data-dir
      api:
        enabled: true
        address: 0.0.0.0:8686
        playground: false
      sources:
        kubernetes_logs:
          type: kubernetes_logs
          auto_partial_merge: true
          exclude_paths_glob_patterns:
            - "**/vector*/**"
        talos_kernel_logs:
          type: socket
          address: 0.0.0.0:6050
          mode: udp
          max_length: 102400
          decoding:
            codec: json
        talos_service_logs:
          type: socket
          address: 0.0.0.0:6051
          mode: udp
          max_length: 102400
          decoding:
            codec: json
        kubernetes_audit_logs:
          type: file
          include:
            - /var/log/audit/kube/*.log
          read_from: beginning
          fingerprint:
            strategy: device_and_inode
      transforms:
        kubernetes_transform:
          type: remap
          inputs:
            - kubernetes_logs
          source: |
            # Extract Kubernetes metadata for VictoriaLogs labels
            .namespace = .kubernetes.pod_namespace
            .pod = .kubernetes.pod_name
            .container = .kubernetes.container_name
            .node = .kubernetes.pod_node_name
            .source_type = "kubernetes"
            # Keep original message
            if exists(.message) {
              .log = .message
            }
            # Add stream type (stdout/stderr)
            .stream = .stream
        talos_kernel_transform:
          type: remap
          inputs:
            - talos_kernel_logs
          source: |
            .source_type = "talos_kernel"
            # Extract structured fields from JSON (use if/else for null handling)
            .facility = if exists(.facility) { .facility } else { "kern" }
            .priority = if exists(.priority) { .priority } else { "info" }
            .log = if exists(.msg) { .msg } else if exists(.message) { .message } else { "" }
            .node = get_env_var!("VECTOR_SELF_NODE_NAME")
            # Use Talos timestamp if available for better accuracy
            if exists(."talos-time") {
              .timestamp = ."talos-time"
            }
        talos_service_transform:
          type: remap
          inputs:
            - talos_service_logs
          source: |
            .source_type = "talos_service"
            .facility = "talos"
            if exists(.msg) {
              .log = .msg
            } else if exists(.message) {
              .log = .message
            }
            .node = get_env_var!("VECTOR_SELF_NODE_NAME")
            .service = .talos_service
        kubernetes_audit_transform:
          type: remap
          inputs:
            - kubernetes_audit_logs
          source: |
            parsed = parse_json(.message) ?? {}
            . = parsed
            .source_type = "kubernetes_audit"
            .log = encode_json(.)
            .node = get_env_var!("VECTOR_SELF_NODE_NAME")
        log_filter:
          type: filter
          inputs:
            - kubernetes_transform
            - talos_kernel_transform
            - talos_service_transform
            - kubernetes_audit_transform
          condition:
            type: vrl
            source: |
              # Drop health check logs from kubernetes
              !match(string(.log) ?? "", r'(health|ready|alive|GET /healthz)')
      sinks:
        victorialogs:
          type: elasticsearch
          inputs:
            - log_filter
          endpoints:
            - http://victoria-logs-server.observability.svc.cluster.local:9428/insert/elasticsearch/
          api_version: v8
          mode: bulk
          compression: gzip
          healthcheck:
            enabled: false
          query:
            _msg_field: log
            _time_field: timestamp
            _stream_fields: source_type,namespace,pod,container,node,stream,facility,service,priority
          request:
            headers:
              AccountID: "0"
              ProjectID: "0"
          bulk:
            index: "logs"
    serviceAccount:
      create: true
    podSecurityContext:
      runAsNonRoot: false
      runAsUser: 0
    extraVolumes:
      - name: var-log-audit
        hostPath:
          path: /var/log/audit
          type: DirectoryOrCreate
    extraVolumeMounts:
      - name: var-log-audit
        mountPath: /var/log/audit
        readOnly: true
    env:
      - name: VECTOR_SELF_NODE_NAME
        valueFrom:
          fieldRef:
            fieldPath: spec.nodeName
