---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: alloy
spec:
  chartRef:
    kind: OCIRepository
    name: alloy
  interval: 1h
  timeout: 15m
  values:
    # ============================================================
    # Alloy Configuration
    # ============================================================
    alloy:
      configMap:
        create: true
        content: |
          // ============================================================
          // Discovery - Kubernetes pods
          // ============================================================
          discovery.kubernetes "pods" {
            role = "pod"
          }

          discovery.kubernetes "nodes" {
            role = "node"
          }

          // ============================================================
          // Log Collection - Kubernetes pods
          // ============================================================
          discovery.relabel "pod_logs" {
            targets = discovery.kubernetes.pods.targets

            // Drop pods without container name
            rule {
              source_labels = ["__meta_kubernetes_pod_container_name"]
              regex         = ""
              action        = "drop"
            }

            // Keep only running pods
            rule {
              source_labels = ["__meta_kubernetes_pod_phase"]
              regex         = "Pending|Succeeded|Failed|Completed"
              action        = "drop"
            }

            // Set labels
            rule {
              source_labels = ["__meta_kubernetes_namespace"]
              target_label  = "namespace"
            }

            rule {
              source_labels = ["__meta_kubernetes_pod_name"]
              target_label  = "pod"
            }

            rule {
              source_labels = ["__meta_kubernetes_pod_container_name"]
              target_label  = "container"
            }

            rule {
              source_labels = ["__meta_kubernetes_pod_node_name"]
              target_label  = "node"
            }

            rule {
              source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
              target_label  = "app"
            }

            // Set path to log file
            rule {
              source_labels = ["__meta_kubernetes_pod_uid", "__meta_kubernetes_pod_container_name"]
              separator     = "/"
              target_label  = "__path__"
              replacement   = "/var/log/pods/*$1/*.log"
            }
          }

          // Collect logs from discovered pods
          loki.source.kubernetes "pod_logs" {
            targets    = discovery.relabel.pod_logs.output
            forward_to = [loki.process.pod_logs.receiver]
          }

          // Process logs (parse JSON, add labels)
          loki.process "pod_logs" {
            forward_to = [loki.write.default.receiver]

            // Try to parse JSON logs
            stage.json {
              expressions = {
                level   = "level",
                msg     = "msg",
                ts      = "ts",
                traceId = "traceId",
              }
            }

            // Extract trace ID for correlation with Tempo
            stage.regex {
              expression = `"traceId"\s*:\s*"(?P<traceId>[a-f0-9]+)"`
            }

            // Set level label if found
            stage.labels {
              values = {
                level   = "",
                traceId = "",
              }
            }
          }

          // ============================================================
          // Kubernetes Events
          // ============================================================
          loki.source.kubernetes_events "cluster_events" {
            namespaces = []
            forward_to = [loki.write.default.receiver]
          }

          // ============================================================
          // Write to Loki
          // ============================================================
          loki.write "default" {
            endpoint {
              url = "http://loki-gateway.observability.svc.cluster.local:80/loki/api/v1/push"
            }
          }

          // ============================================================
          // OTLP Receiver for traces
          // ============================================================
          otelcol.receiver.otlp "default" {
            grpc {
              endpoint = "0.0.0.0:4317"
            }

            http {
              endpoint = "0.0.0.0:4318"
            }

            output {
              traces = [otelcol.processor.batch.default.input]
            }
          }

          // Batch processor for efficiency
          otelcol.processor.batch "default" {
            output {
              traces = [otelcol.exporter.otlp.tempo.input]
            }
          }

          // Export traces to Tempo
          otelcol.exporter.otlp "tempo" {
            client {
              endpoint = "tempo.observability.svc.cluster.local:4317"
              tls {
                insecure = true
              }
            }
          }

    # ============================================================
    # Controller Settings (DaemonSet for log collection)
    # ============================================================
    controller:
      type: daemonset

    # ============================================================
    # Service for OTLP ingestion
    # ============================================================
    service:
      enabled: true
      type: ClusterIP

    # ============================================================
    # ServiceMonitor
    # ============================================================
    serviceMonitor:
      enabled: true

    # ============================================================
    # Resources
    # ============================================================
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        memory: 512Mi

    # ============================================================
    # Tolerations (run on all nodes)
    # ============================================================
    tolerations:
      - operator: Exists

    # ============================================================
    # Mount paths for log collection
    # ============================================================
    extraVolumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers

    extraVolumeMounts:
      - name: varlog
        mountPath: /var/log
        readOnly: true
      - name: varlibdockercontainers
        mountPath: /var/lib/docker/containers
        readOnly: true
