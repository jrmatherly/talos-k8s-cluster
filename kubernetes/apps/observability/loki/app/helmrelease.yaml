---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
spec:
  chartRef:
    kind: OCIRepository
    name: loki
  interval: 1h
  timeout: 15m
  values:
    # ============================================================
    # Deployment Mode: SingleBinary (Monolithic - for filesystem storage)
    # ============================================================
    deploymentMode: SingleBinary

    # ============================================================
    # Loki Configuration
    # ============================================================
    loki:
      auth_enabled: false
      commonConfig:
        replication_factor: 1

      # Schema configuration for log storage
      schemaConfig:
        configs:
          - from: "2024-04-01"
            store: tsdb
            object_store: filesystem
            schema: v13
            index:
              prefix: loki_index_
              period: 24h

      # Ingester configuration
      ingester:
        chunk_encoding: snappy

      # Tracing integration (for correlation with Tempo)
      tracing:
        enabled: true

      # Querier configuration
      querier:
        max_concurrent: 4

      # Limits configuration
      limits_config:
        retention_period: 168h
        ingestion_rate_mb: 16
        ingestion_burst_size_mb: 32
        max_query_parallelism: 32
        max_query_series: 10000
        split_queries_by_interval: 15m

      # Filesystem storage
      storage:
        type: filesystem

    # ============================================================
    # SingleBinary Configuration
    # ============================================================
    singleBinary:
      replicas: 1
      persistence:
        enabled: true
        size: 10Gi
        storageClass: proxmox-csi
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          memory: 1Gi

    # Disable scalable components in SingleBinary mode
    read:
      replicas: 0
    write:
      replicas: 0
    backend:
      replicas: 0

    # Disable caches not needed in SingleBinary mode
    chunksCache:
      enabled: false
    resultsCache:
      enabled: false

    # ============================================================
    # Gateway (nginx)
    # ============================================================
    gateway:
      enabled: true
      replicas: 1
      service:
        type: ClusterIP

    # ============================================================
    # Monitoring
    # ============================================================
    monitoring:
      dashboards:
        enabled: true
        labels:
          grafana_dashboard: "1"
      rules:
        enabled: true
      serviceMonitor:
        enabled: true
        labels: {}

    # ============================================================
    # Sidecar (for service discovery)
    # ============================================================
    sidecar:
      rules:
        enabled: false

    # ============================================================
    # Log Collection with Alloy (replaces Promtail)
    # ============================================================
    lokiCanary:
      enabled: false

    # Disable helm test when lokiCanary is disabled
    # REF: https://github.com/grafana/loki/issues/9849
    test:
      enabled: false
