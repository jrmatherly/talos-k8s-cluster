---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cognee
spec:
  chartRef:
    kind: OCIRepository
    name: app-template
  interval: 1h
  timeout: 15m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
      remediateLastFailure: true

  values:
    # ==========================================================================
    # Default Pod Options
    # ==========================================================================
    defaultPodOptions:
      securityContext:
        runAsNonRoot: false
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile:
          type: RuntimeDefault
      labels:
        app.kubernetes.io/name: cognee
      terminationGracePeriodSeconds: 60

    # ==========================================================================
    # Controllers
    # ==========================================================================
    controllers:
      cognee:
        type: deployment
        replicas: 1
        pod:
          labels:
            app.kubernetes.io/component: api
        strategy: RollingUpdate
        rollingUpdate:
          unavailable: 0
          surge: 1

        # Init container to fix Cognee Alembic migration bugs on fresh install
        # Cognee's migrations assume SQLAlchemy create_all() ran first, but entrypoint.sh
        # runs migrations before the app starts. We pre-create the required schema:
        # 1. pipelinerunstatus enum - before ADD VALUE migration runs
        # 2. acls table with dataset_id - so permission_system_rework migration skips
        # 3. data table with full schema - so loader_separation migration succeeds
        initContainers:
          init-db-schema:
            image:
              repository: postgres
              tag: "16-alpine"
            env:
              - name: PGHOST
                value: "cognee-db-rw.ai-system.svc.cluster.local"
              - name: PGPORT
                value: "5432"
              - name: PGDATABASE
                value: "cognee"
              - name: PGUSER
                value: "cognee"
              - name: PGPASSWORD
                valueFrom:
                  secretKeyRef:
                    name: cognee-api-secrets
                    key: DB_PASSWORD
            command:
              - /bin/sh
              - -c
              - |
                echo "Initializing Cognee database schema prerequisites..."
                psql -c "
                DO \$\$
                BEGIN
                  -- Create pipelinerunstatus enum if not exists
                  -- Fixes: migration tries ADD VALUE before CREATE TYPE
                  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'pipelinerunstatus') THEN
                    CREATE TYPE pipelinerunstatus AS ENUM (
                      'QUEUED',
                      'RUNNING',
                      'COMPLETED',
                      'FAILED',
                      'CANCELLED',
                      'DATASET_PROCESSING_INITIATED',
                      'DATASET_PROCESSING_STARTED',
                      'DATASET_PROCESSING_COMPLETED',
                      'DATASET_PROCESSING_ERROR'
                    );
                    RAISE NOTICE 'Created pipelinerunstatus enum type';
                  ELSE
                    RAISE NOTICE 'pipelinerunstatus enum type already exists';
                  END IF;

                  -- Create acls table with dataset_id column if not exists
                  -- Fixes: permission_system_rework migration expects acls table
                  -- When dataset_id exists, migration skips the rework (assumes already done)
                  IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'acls') THEN
                    CREATE TABLE acls (
                      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                      created_at TIMESTAMPTZ DEFAULT NOW(),
                      updated_at TIMESTAMPTZ DEFAULT NOW(),
                      principal_id UUID,
                      permission_id UUID,
                      dataset_id UUID
                    );
                    RAISE NOTICE 'Created acls table with dataset_id column';
                  ELSE
                    RAISE NOTICE 'acls table already exists';
                  END IF;

                  -- Create data table with FULL schema if not exists
                  -- Cognee migrations assume SQLAlchemy create_all() ran first
                  -- We pre-create the complete table so migrations succeed
                  IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'data') THEN
                    CREATE TABLE data (
                      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                      name VARCHAR,
                      extension VARCHAR,
                      mime_type VARCHAR,
                      original_extension VARCHAR,
                      original_mime_type VARCHAR,
                      loader_engine VARCHAR,
                      raw_data_location VARCHAR,
                      original_data_location VARCHAR,
                      owner_id UUID,
                      tenant_id UUID,
                      content_hash VARCHAR,
                      raw_content_hash VARCHAR,
                      external_metadata JSON,
                      node_set JSON,
                      pipeline_status JSON,
                      token_count INTEGER,
                      data_size INTEGER,
                      created_at TIMESTAMPTZ DEFAULT NOW(),
                      updated_at TIMESTAMPTZ DEFAULT NOW()
                    );
                    CREATE INDEX ix_data_owner_id ON data(owner_id);
                    CREATE INDEX ix_data_tenant_id ON data(tenant_id);
                    RAISE NOTICE 'Created data table with full schema';
                  ELSE
                    RAISE NOTICE 'data table already exists';
                  END IF;

                  -- Create tenants table if not exists
                  -- Fixes: multi_tenant_support migration needs tenants table for FK
                  IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'tenants') THEN
                    CREATE TABLE tenants (
                      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                      name VARCHAR NOT NULL,
                      created_at TIMESTAMPTZ DEFAULT NOW(),
                      updated_at TIMESTAMPTZ DEFAULT NOW()
                    );
                    RAISE NOTICE 'Created tenants table';
                  ELSE
                    RAISE NOTICE 'tenants table already exists';
                  END IF;

                  -- Create users table if not exists
                  -- Fixes: multi_tenant_support migration needs users table with tenant_id column
                  -- Migration c946955da633 does: SELECT users.id, users.tenant_id FROM users WHERE users.tenant_id IS NOT NULL
                  IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'users') THEN
                    CREATE TABLE users (
                      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                      external_id VARCHAR,
                      email VARCHAR,
                      tenant_id UUID,
                      created_at TIMESTAMPTZ DEFAULT NOW(),
                      updated_at TIMESTAMPTZ DEFAULT NOW()
                    );
                    CREATE INDEX ix_users_tenant_id ON users(tenant_id);
                    RAISE NOTICE 'Created users table with tenant_id column';
                  ELSE
                    -- Add tenant_id column if missing (for existing tables)
                    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'users' AND column_name = 'tenant_id') THEN
                      ALTER TABLE users ADD COLUMN tenant_id UUID;
                      CREATE INDEX IF NOT EXISTS ix_users_tenant_id ON users(tenant_id);
                      RAISE NOTICE 'Added tenant_id column to existing users table';
                    ELSE
                      RAISE NOTICE 'users table already has tenant_id column';
                    END IF;
                  END IF;

                  -- Create datasets table if not exists
                  -- Fixes: multi_tenant_support migration checks datasets.tenant_id column
                  -- Migration c946955da633 does: _get_column(insp, "datasets", "tenant_id")
                  IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'datasets') THEN
                    CREATE TABLE datasets (
                      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                      name VARCHAR NOT NULL,
                      description VARCHAR,
                      owner_id UUID,
                      tenant_id UUID,
                      created_at TIMESTAMPTZ DEFAULT NOW(),
                      updated_at TIMESTAMPTZ DEFAULT NOW()
                    );
                    CREATE INDEX ix_datasets_owner_id ON datasets(owner_id);
                    CREATE INDEX ix_datasets_tenant_id ON datasets(tenant_id);
                    RAISE NOTICE 'Created datasets table with tenant_id column';
                  ELSE
                    -- Add tenant_id column if missing (for existing tables)
                    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'datasets' AND column_name = 'tenant_id') THEN
                      ALTER TABLE datasets ADD COLUMN tenant_id UUID;
                      CREATE INDEX IF NOT EXISTS ix_datasets_tenant_id ON datasets(tenant_id);
                      RAISE NOTICE 'Added tenant_id column to existing datasets table';
                    ELSE
                      RAISE NOTICE 'datasets table already has tenant_id column';
                    END IF;
                  END IF;
                END\$\$;
                " && echo "Database schema prerequisites initialized successfully"
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop: ["ALL"]
              runAsNonRoot: true
              runAsUser: 70
              seccompProfile:
                type: RuntimeDefault

        containers:
          app:
            image:
              repository: ghcr.io/jrmatherly/cognee
              tag: "0.5.0"
              pullPolicy: Always

            env:
              # =================================================================
              # Core Server Settings
              # =================================================================
              TZ: "America/New_York"
              ENVIRONMENT: "production"
              DEBUG: "false"
              HOST: "0.0.0.0"
              PYTHONPATH: "."
              LOG_LEVEL: "INFO"

              # =================================================================
              # Relational Database Configuration (PostgreSQL)
              # Used for core data, ACLs, and application state
              # =================================================================
              DB_PROVIDER: "postgres"
              DB_HOST: "cognee-db-rw.ai-system.svc.cluster.local"
              DB_PORT: "5432"
              DB_NAME: "cognee"
              DB_USERNAME: "cognee"

              # =================================================================
              # Migration Database Configuration
              # Same as relational DB for consistent migration tracking
              # =================================================================
              MIGRATION_DB_PROVIDER: "postgres"
              MIGRATION_DB_HOST: "cognee-db-rw.ai-system.svc.cluster.local"
              MIGRATION_DB_PORT: "5432"
              MIGRATION_DB_NAME: "cognee"
              MIGRATION_DB_USERNAME: "cognee"

              # =================================================================
              # Vector Database Configuration (pgvector)
              # Used for vector embeddings storage and similarity search
              # =================================================================
              VECTOR_DB_PROVIDER: "pgvector"
              VECTOR_DB_URL:
                valueFrom:
                  secretKeyRef:
                    name: cognee-api-secrets
                    key: COGNEE_DB_DSN
              VECTOR_DATASET_DATABASE_HANDLER: "pgvector"

              # =================================================================
              # Graph Database Configuration (Neo4j)
              # Used for knowledge graph storage and traversal
              # =================================================================
              GRAPH_DATABASE_PROVIDER: "neo4j"
              GRAPH_DATABASE_URL: "bolt://neo4j.storage.svc.cluster.local:7687"
              GRAPH_DATABASE_NAME: "neo4j"
              GRAPH_DATABASE_USERNAME: "neo4j"
              GRAPH_DATABASE_PORT: "7687"
              GRAPH_DATASET_DATABASE_HANDLER: "neo4j"

              # =================================================================
              # LLM Configuration
              # Uses LiteLLM proxy for multi-provider routing
              # =================================================================
              LLM_PROVIDER: "openai"
              LLM_ENDPOINT: "https://llms.${SECRET_DOMAIN}/v1"
              LLM_MODEL: "gpt-5-mini"
              LLM_TEMPERATURE: "0.0"
              LLM_MAX_COMPLETION_TOKENS: "16384"
              LLM_STREAMING: "false"
              STRUCTURED_OUTPUT_FRAMEWORK: "instructor"

              # =================================================================
              # Embedding Configuration
              # Also uses LiteLLM proxy for embedding models
              # =================================================================
              EMBEDDING_PROVIDER: "openai"
              EMBEDDING_ENDPOINT: "https://llms.${SECRET_DOMAIN}/v1"
              EMBEDDING_MODEL: "text-embedding-3-large"
              EMBEDDING_DIMENSIONS: "3072"
              EMBEDDING_BATCH_SIZE: "36"
              EMBEDDING_MAX_COMPLETION_TOKENS: "8191"

              # =================================================================
              # Storage Configuration
              # Local filesystem for data/document storage
              # =================================================================
              STORAGE_BACKEND: "local"
              DATA_ROOT_DIRECTORY: "/data"
              SYSTEM_ROOT_DIRECTORY: "/data/system"

              # =================================================================
              # Security & Access Control Settings
              # =================================================================
              REQUIRE_AUTHENTICATION: "false"
              ENABLE_BACKEND_ACCESS_CONTROL: "false"
              ACCEPT_LOCAL_FILE_PATH: "true"
              ALLOW_HTTP_REQUESTS: "true"
              ALLOW_CYPHER_QUERY: "true"

            envFrom:
              - secretRef:
                  name: cognee-api-secrets

            resources:
              requests:
                cpu: "100m"
                memory: "512Mi"
              limits:
                cpu: "2000m"
                memory: "4Gi"

            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop: ["ALL"]
              seccompProfile:
                type: RuntimeDefault

            probes:
              startup:
                enabled: true
                spec:
                  httpGet:
                    path: /health
                    port: http
                  initialDelaySeconds: 30
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 30
              liveness:
                enabled: true
                spec:
                  httpGet:
                    path: /health
                    port: http
                  periodSeconds: 30
                  timeoutSeconds: 10
                  failureThreshold: 3
              readiness:
                enabled: true
                spec:
                  httpGet:
                    path: /health
                    port: http
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3

      # ========================================================================
      # Frontend Controller
      # ========================================================================
      frontend:
        type: deployment
        replicas: 1
        strategy: RollingUpdate
        rollingUpdate:
          unavailable: 0
          surge: 1

        pod:
          labels:
            app.kubernetes.io/component: frontend
          securityContext:
            runAsUser: 10001
            runAsGroup: 10001
            fsGroup: 10001
            runAsNonRoot: true

        containers:
          app:
            image:
              repository: ghcr.io/jrmatherly/cognee-frontend
              tag: "latest"
              pullPolicy: Always

            env:
              # Backend API URL (internal service)
              NEXT_PUBLIC_BACKEND_API_URL: "http://cognee-cognee.ai-system.svc.cluster.local:8000"
              # Frontend base URL (external hostname)
              APP_BASE_URL: "https://cognee.matherly.net"

            resources:
              requests:
                cpu: "100m"
                memory: "256Mi"
              limits:
                cpu: "500m"
                memory: "512Mi"

            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop: ["ALL"]
              runAsNonRoot: true
              runAsUser: 10001
              runAsGroup: 10001
              seccompProfile:
                type: RuntimeDefault

            probes:
              startup:
                enabled: true
                spec:
                  httpGet:
                    path: /api/health
                    port: http
                  initialDelaySeconds: 5
                  periodSeconds: 3
                  timeoutSeconds: 3
                  failureThreshold: 20
              liveness:
                enabled: true
                spec:
                  httpGet:
                    path: /api/health
                    port: http
                  periodSeconds: 30
                  timeoutSeconds: 5
                  failureThreshold: 3
              readiness:
                enabled: true
                spec:
                  httpGet:
                    path: /api/health
                    port: http
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3

    # ==========================================================================
    # Service Configuration
    # ==========================================================================
    service:
      cognee:
        controller: cognee
        ports:
          http:
            port: 8000
            targetPort: 8000
            protocol: HTTP
      frontend:
        controller: frontend
        ports:
          http:
            port: 3000
            targetPort: 3000
            protocol: HTTP

    # ==========================================================================
    # Persistence - Data storage for Cognee
    # ==========================================================================
    persistence:
      data:
        enabled: true
        type: emptyDir
        sizeLimit: 10Gi
        globalMounts:
          - path: /data

