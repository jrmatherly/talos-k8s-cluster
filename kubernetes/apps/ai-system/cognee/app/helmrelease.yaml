---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cognee
spec:
  chartRef:
    kind: OCIRepository
    name: app-template
  interval: 1h
  timeout: 15m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
      remediateLastFailure: true

  values:
    # ==========================================================================
    # Default Pod Options
    # ==========================================================================
    defaultPodOptions:
      securityContext:
        runAsNonRoot: false
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile:
          type: RuntimeDefault
      labels:
        app.kubernetes.io/name: cognee
        app.kubernetes.io/component: api
      terminationGracePeriodSeconds: 60

    # ==========================================================================
    # Controllers
    # ==========================================================================
    controllers:
      cognee:
        type: deployment
        replicas: 1
        strategy: RollingUpdate
        rollingUpdate:
          unavailable: 0
          surge: 1

        # Init container to fix Cognee Alembic migration bugs on fresh install
        # 1. Creates pipelinerunstatus enum before ADD VALUE migration runs
        # 2. Creates acls table with dataset_id so permission_system_rework migration skips
        initContainers:
          init-db-schema:
            image:
              repository: postgres
              tag: "16-alpine"
            env:
              - name: PGHOST
                value: "cognee-db-rw.ai-system.svc.cluster.local"
              - name: PGPORT
                value: "5432"
              - name: PGDATABASE
                value: "cognee"
              - name: PGUSER
                value: "cognee"
              - name: PGPASSWORD
                valueFrom:
                  secretKeyRef:
                    name: cognee-api-secrets
                    key: DB_PASSWORD
            command:
              - /bin/sh
              - -c
              - |
                echo "Initializing Cognee database schema prerequisites..."
                psql -c "
                DO \$\$
                BEGIN
                  -- Create pipelinerunstatus enum if not exists
                  -- Fixes: migration tries ADD VALUE before CREATE TYPE
                  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'pipelinerunstatus') THEN
                    CREATE TYPE pipelinerunstatus AS ENUM (
                      'QUEUED',
                      'RUNNING',
                      'COMPLETED',
                      'FAILED',
                      'CANCELLED',
                      'DATASET_PROCESSING_INITIATED',
                      'DATASET_PROCESSING_STARTED',
                      'DATASET_PROCESSING_COMPLETED',
                      'DATASET_PROCESSING_ERROR'
                    );
                    RAISE NOTICE 'Created pipelinerunstatus enum type';
                  ELSE
                    RAISE NOTICE 'pipelinerunstatus enum type already exists';
                  END IF;

                  -- Create acls table with dataset_id column if not exists
                  -- Fixes: permission_system_rework migration expects acls table
                  -- When dataset_id exists, migration skips the rework (assumes already done)
                  IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'acls') THEN
                    CREATE TABLE acls (
                      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                      created_at TIMESTAMPTZ DEFAULT NOW(),
                      updated_at TIMESTAMPTZ DEFAULT NOW(),
                      principal_id UUID,
                      permission_id UUID,
                      dataset_id UUID
                    );
                    RAISE NOTICE 'Created acls table with dataset_id column';
                  ELSE
                    RAISE NOTICE 'acls table already exists';
                  END IF;
                END\$\$;
                " && echo "Database schema prerequisites initialized successfully"
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop: ["ALL"]
              runAsNonRoot: true
              runAsUser: 70
              seccompProfile:
                type: RuntimeDefault

        containers:
          app:
            image:
              repository: cognee/cognee
              tag: "main"
              pullPolicy: IfNotPresent

            env:
              # =================================================================
              # Core Server Settings
              # =================================================================
              TZ: "America/New_York"
              ENVIRONMENT: "production"
              DEBUG: "false"
              HOST: "0.0.0.0"
              PYTHONPATH: "."
              LOG_LEVEL: "INFO"

              # =================================================================
              # Relational Database Configuration (PostgreSQL)
              # Used for core data, ACLs, and application state
              # =================================================================
              DB_PROVIDER: "postgres"
              DB_HOST: "cognee-db-rw.ai-system.svc.cluster.local"
              DB_PORT: "5432"
              DB_NAME: "cognee"
              DB_USERNAME: "cognee"

              # =================================================================
              # Migration Database Configuration
              # Same as relational DB for consistent migration tracking
              # =================================================================
              MIGRATION_DB_PROVIDER: "postgres"
              MIGRATION_DB_HOST: "cognee-db-rw.ai-system.svc.cluster.local"
              MIGRATION_DB_PORT: "5432"
              MIGRATION_DB_NAME: "cognee"
              MIGRATION_DB_USERNAME: "cognee"

              # =================================================================
              # Vector Database Configuration (pgvector)
              # Used for vector embeddings storage and similarity search
              # =================================================================
              VECTOR_DB_PROVIDER: "pgvector"
              VECTOR_DB_URL:
                valueFrom:
                  secretKeyRef:
                    name: cognee-api-secrets
                    key: COGNEE_DB_DSN
              VECTOR_DATASET_DATABASE_HANDLER: "pgvector"

              # =================================================================
              # Graph Database Configuration (Neo4j)
              # Used for knowledge graph storage and traversal
              # =================================================================
              GRAPH_DATABASE_PROVIDER: "neo4j"
              GRAPH_DATABASE_URL: "bolt://neo4j.storage.svc.cluster.local:7687"
              GRAPH_DATABASE_NAME: "neo4j"
              GRAPH_DATABASE_USERNAME: "neo4j"
              GRAPH_DATABASE_PORT: "7687"
              GRAPH_DATASET_DATABASE_HANDLER: "neo4j"

              # =================================================================
              # LLM Configuration
              # Uses LiteLLM proxy for multi-provider routing
              # =================================================================
              LLM_PROVIDER: "openai"
              LLM_ENDPOINT: "https://litellm.matherly.net/v1"
              LLM_MODEL: "gpt-4o-mini"
              LLM_TEMPERATURE: "0.0"
              LLM_MAX_COMPLETION_TOKENS: "16384"
              LLM_STREAMING: "false"
              STRUCTURED_OUTPUT_FRAMEWORK: "instructor"

              # =================================================================
              # Embedding Configuration
              # Also uses LiteLLM proxy for embedding models
              # =================================================================
              EMBEDDING_PROVIDER: "openai"
              EMBEDDING_ENDPOINT: "https://litellm.matherly.net/v1"
              EMBEDDING_MODEL: "text-embedding-3-large"
              EMBEDDING_DIMENSIONS: "3072"
              EMBEDDING_BATCH_SIZE: "36"
              EMBEDDING_MAX_COMPLETION_TOKENS: "8191"

              # =================================================================
              # Storage Configuration
              # Local filesystem for data/document storage
              # =================================================================
              STORAGE_BACKEND: "local"
              DATA_ROOT_DIRECTORY: "/data"
              SYSTEM_ROOT_DIRECTORY: "/data/system"

              # =================================================================
              # Security & Access Control Settings
              # =================================================================
              REQUIRE_AUTHENTICATION: "false"
              ENABLE_BACKEND_ACCESS_CONTROL: "false"
              ACCEPT_LOCAL_FILE_PATH: "true"
              ALLOW_HTTP_REQUESTS: "true"
              ALLOW_CYPHER_QUERY: "true"

            envFrom:
              - secretRef:
                  name: cognee-api-secrets

            resources:
              requests:
                cpu: "100m"
                memory: "512Mi"
              limits:
                cpu: "2000m"
                memory: "4Gi"

            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop: ["ALL"]
              seccompProfile:
                type: RuntimeDefault

            probes:
              startup:
                enabled: true
                spec:
                  httpGet:
                    path: /health
                    port: http
                  initialDelaySeconds: 30
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 30
              liveness:
                enabled: true
                spec:
                  httpGet:
                    path: /health
                    port: http
                  periodSeconds: 30
                  timeoutSeconds: 10
                  failureThreshold: 3
              readiness:
                enabled: true
                spec:
                  httpGet:
                    path: /health
                    port: http
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3

    # ==========================================================================
    # Service Configuration
    # ==========================================================================
    service:
      cognee:
        controller: cognee
        ports:
          http:
            port: 8000
            targetPort: 8000
            protocol: HTTP

    # ==========================================================================
    # Persistence - Data storage for Cognee
    # ==========================================================================
    persistence:
      data:
        enabled: true
        type: emptyDir
        sizeLimit: 10Gi
        globalMounts:
          - path: /data

