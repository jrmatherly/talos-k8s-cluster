---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cognee
spec:
  chartRef:
    kind: OCIRepository
    name: app-template
  interval: 1h
  timeout: 15m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
      remediateLastFailure: true

  values:
    # ==========================================================================
    # Default Pod Options
    # ==========================================================================
    defaultPodOptions:
      securityContext:
        runAsNonRoot: false
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile:
          type: RuntimeDefault
      labels:
        app.kubernetes.io/name: cognee
      terminationGracePeriodSeconds: 60

    # ==========================================================================
    # Controllers
    # ==========================================================================
    controllers:
      cognee:
        type: deployment
        replicas: 1
        pod:
          labels:
            app.kubernetes.io/component: api
        strategy: RollingUpdate
        rollingUpdate:
          unavailable: 0
          surge: 1

        # Note: Database initialization (table creation, migrations) is now handled
        # by the updated entrypoint.sh in the Cognee image, which runs
        # create_db_and_tables() before Alembic migrations.

        containers:
          app:
            image:
              repository: ghcr.io/jrmatherly/cognee
              tag: "0.5.1"
              pullPolicy: Always

            env:
              # =================================================================
              # Core Server Settings
              # =================================================================
              TZ: "America/New_York"
              ENVIRONMENT: "production"
              DEBUG: "false"
              HOST: "0.0.0.0"
              PYTHONPATH: "."
              LOG_LEVEL: "INFO"

              # =================================================================
              # Relational Database Configuration (PostgreSQL)
              # Used for core data, ACLs, and application state
              # =================================================================
              DB_PROVIDER: "postgres"
              DB_HOST: "cognee-db-rw.ai-system.svc.cluster.local"
              DB_PORT: "5432"
              DB_NAME: "cognee"
              DB_USERNAME: "cognee"

              # =================================================================
              # Migration Database Configuration
              # Same as relational DB for consistent migration tracking
              # =================================================================
              MIGRATION_DB_PROVIDER: "postgres"
              MIGRATION_DB_HOST: "cognee-db-rw.ai-system.svc.cluster.local"
              MIGRATION_DB_PORT: "5432"
              MIGRATION_DB_NAME: "cognee"
              MIGRATION_DB_USERNAME: "cognee"

              # =================================================================
              # Vector Database Configuration (pgvector)
              # Used for vector embeddings storage and similarity search
              # =================================================================
              VECTOR_DB_PROVIDER: "pgvector"
              VECTOR_DB_URL:
                valueFrom:
                  secretKeyRef:
                    name: cognee-api-secrets
                    key: COGNEE_DB_DSN
              VECTOR_DATASET_DATABASE_HANDLER: "pgvector"

              # =================================================================
              # Graph Database Configuration (Neo4j)
              # Used for knowledge graph storage and traversal
              # =================================================================
              GRAPH_DATABASE_PROVIDER: "neo4j"
              GRAPH_DATABASE_URL: "bolt://neo4j.storage.svc.cluster.local:7687"
              GRAPH_DATABASE_NAME: "neo4j"
              GRAPH_DATABASE_USERNAME: "neo4j"
              GRAPH_DATABASE_PORT: "7687"
              GRAPH_DATASET_DATABASE_HANDLER: "neo4j"

              # =================================================================
              # LLM Configuration
              # Uses LiteLLM proxy for multi-provider routing
              # =================================================================
              LLM_PROVIDER: "openai"
              LLM_ENDPOINT: "https://llms.${SECRET_DOMAIN}/v1"
              LLM_MODEL: "gpt-5-mini"
              LLM_TEMPERATURE: "0.0"
              LLM_MAX_COMPLETION_TOKENS: "16384"
              LLM_STREAMING: "false"
              STRUCTURED_OUTPUT_FRAMEWORK: "instructor"

              # =================================================================
              # Embedding Configuration
              # Also uses LiteLLM proxy for embedding models
              # =================================================================
              EMBEDDING_PROVIDER: "openai"
              EMBEDDING_ENDPOINT: "https://llms.${SECRET_DOMAIN}/v1"
              EMBEDDING_MODEL: "text-embedding-3-large"
              EMBEDDING_DIMENSIONS: "3072"
              EMBEDDING_BATCH_SIZE: "36"
              EMBEDDING_MAX_COMPLETION_TOKENS: "8191"

              # =================================================================
              # Storage Configuration
              # Local filesystem for data/document storage
              # =================================================================
              STORAGE_BACKEND: "local"
              DATA_ROOT_DIRECTORY: "/data"
              SYSTEM_ROOT_DIRECTORY: "/data/system"

              # =================================================================
              # Security & Access Control Settings
              # =================================================================
              REQUIRE_AUTHENTICATION: "false"
              ENABLE_BACKEND_ACCESS_CONTROL: "false"
              ACCEPT_LOCAL_FILE_PATH: "true"
              ALLOW_HTTP_REQUESTS: "true"
              ALLOW_CYPHER_QUERY: "true"

            envFrom:
              - secretRef:
                  name: cognee-api-secrets

            resources:
              requests:
                cpu: "100m"
                memory: "512Mi"
              limits:
                cpu: "2000m"
                memory: "4Gi"

            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop: ["ALL"]
              seccompProfile:
                type: RuntimeDefault

            probes:
              startup:
                enabled: true
                spec:
                  httpGet:
                    path: /health
                    port: http
                  initialDelaySeconds: 30
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 30
              liveness:
                enabled: true
                spec:
                  httpGet:
                    path: /health
                    port: http
                  periodSeconds: 30
                  timeoutSeconds: 10
                  failureThreshold: 3
              readiness:
                enabled: true
                spec:
                  httpGet:
                    path: /health
                    port: http
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3

      # ========================================================================
      # Frontend Controller
      # ========================================================================
      frontend:
        type: deployment
        replicas: 1
        strategy: RollingUpdate
        rollingUpdate:
          unavailable: 0
          surge: 1

        pod:
          labels:
            app.kubernetes.io/component: frontend
          securityContext:
            runAsUser: 10001
            runAsGroup: 10001
            fsGroup: 10001
            runAsNonRoot: true

        containers:
          app:
            image:
              repository: ghcr.io/jrmatherly/cognee-frontend
              tag: "latest"
              pullPolicy: Always

            env:
              # Backend API URL (internal service)
              NEXT_PUBLIC_BACKEND_API_URL: "http://cognee-cognee.ai-system.svc.cluster.local:8000"
              # Frontend base URL (external hostname)
              APP_BASE_URL: "https://cognee.matherly.net"

            resources:
              requests:
                cpu: "100m"
                memory: "256Mi"
              limits:
                cpu: "500m"
                memory: "512Mi"

            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop: ["ALL"]
              runAsNonRoot: true
              runAsUser: 10001
              runAsGroup: 10001
              seccompProfile:
                type: RuntimeDefault

            probes:
              startup:
                enabled: true
                spec:
                  httpGet:
                    path: /api/health
                    port: http
                  initialDelaySeconds: 5
                  periodSeconds: 3
                  timeoutSeconds: 3
                  failureThreshold: 20
              liveness:
                enabled: true
                spec:
                  httpGet:
                    path: /api/health
                    port: http
                  periodSeconds: 30
                  timeoutSeconds: 5
                  failureThreshold: 3
              readiness:
                enabled: true
                spec:
                  httpGet:
                    path: /api/health
                    port: http
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3

    # ==========================================================================
    # Service Configuration
    # ==========================================================================
    service:
      cognee:
        controller: cognee
        ports:
          http:
            port: 8000
            targetPort: 8000
            protocol: HTTP
      frontend:
        controller: frontend
        ports:
          http:
            port: 3000
            targetPort: 3000
            protocol: HTTP

    # ==========================================================================
    # Persistence - Data storage for Cognee
    # ==========================================================================
    persistence:
      data:
        enabled: true
        type: emptyDir
        sizeLimit: 10Gi
        globalMounts:
          - path: /data

