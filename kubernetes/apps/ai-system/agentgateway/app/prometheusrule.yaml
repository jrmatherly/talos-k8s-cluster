---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: agentgateway-alerts
  labels:
    release: kube-prometheus-stack
spec:
  groups:
    - name: agentgateway.ai.rules
      rules:
        - alert: AgentgatewayAIHighErrorRate
          expr: |
            (
              sum(rate(envoy_cluster_upstream_rq_xx{envoy_response_code_class="5", envoy_cluster_name=~".*azure.*|.*openai.*"}[5m])) by (envoy_cluster_name)
              /
              sum(rate(envoy_cluster_upstream_rq_total{envoy_cluster_name=~".*azure.*|.*openai.*"}[5m])) by (envoy_cluster_name)
            ) > 0.1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High error rate on AI Gateway cluster {{ $labels.envoy_cluster_name }}"
            description: "Error rate is {{ $value | humanizePercentage }} for cluster {{ $labels.envoy_cluster_name }}"

        - alert: AgentgatewayAIConnectionFailures
          expr: |
            sum(rate(envoy_cluster_upstream_cx_connect_fail{envoy_cluster_name=~".*azure.*|.*openai.*"}[5m])) by (envoy_cluster_name) > 0.5
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Connection failures to AI backend {{ $labels.envoy_cluster_name }}"
            description: "{{ $value }} connection failures per second to {{ $labels.envoy_cluster_name }}"

        - alert: AgentgatewayAIHighLatency
          expr: |
            histogram_quantile(0.99,
              sum(rate(envoy_cluster_upstream_rq_time_bucket{envoy_cluster_name=~".*azure.*|.*openai.*"}[5m])) by (le, envoy_cluster_name)
            ) > 30000
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High latency on AI Gateway cluster {{ $labels.envoy_cluster_name }}"
            description: "P99 latency is {{ $value | humanizeDuration }} for cluster {{ $labels.envoy_cluster_name }}"

        - alert: AgentgatewayAICircuitBreakerTripped
          expr: |
            envoy_cluster_outlier_detection_ejections_enforced_total{envoy_cluster_name=~".*azure.*|.*openai.*"} > 0
          for: 1m
          labels:
            severity: warning
          annotations:
            summary: "Circuit breaker tripped for AI backend {{ $labels.envoy_cluster_name }}"
            description: "Backend {{ $labels.envoy_cluster_name }} has been ejected due to health check failures"

    - name: agentgateway.mcp.rules
      rules:
        - alert: AgentgatewayMCPErrors
          expr: |
            sum(rate(envoy_http_downstream_rq_xx{envoy_response_code_class="5", envoy_http_conn_manager_prefix=~".*mcp.*"}[5m])) > 0.1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "MCP Gateway returning errors"
            description: "MCP Gateway has {{ $value }} 5xx errors per second"

        - alert: AgentgatewayMCPHighSessionCount
          expr: |
            envoy_http_downstream_cx_active{envoy_http_conn_manager_prefix=~".*mcp.*"} > 100
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High MCP session count"
            description: "{{ $value }} active MCP sessions (may indicate connection leaks)"

    - name: agentgateway.controller.rules
      rules:
        - alert: AgentgatewayControllerDown
          expr: |
            up{job="agentgateway-controller"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "agentgateway controller is down"
            description: "The agentgateway controller has been down for more than 5 minutes"

        - alert: AgentgatewayProxyNotReady
          expr: |
            kube_pod_status_ready{namespace="ai-system", pod=~"agentgateway-.*", condition="true"} == 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "agentgateway proxy pod {{ $labels.pod }} is not ready"
            description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has been not ready for 5 minutes"

        - alert: AgentgatewayReconciliationErrors
          expr: |
            sum(rate(controller_runtime_reconcile_errors_total{controller=~".*agentgateway.*"}[5m])) > 0.1
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "agentgateway controller reconciliation errors"
            description: "{{ $value }} reconciliation errors per second"
