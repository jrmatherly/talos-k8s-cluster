---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: GatewayParameters
metadata:
  name: agentgateway-params
spec:
  kube:
    deployment:
      replicas: 1
    service:
      type: LoadBalancer
    agentgateway:
      env:
        - name: ADMIN_ADDR
          value: "0.0.0.0:15000"
        - name: METRICS_ENABLED
          value: "true"
        - name: METRICS_PORT
          value: "9090"
---
apiVersion: v1
kind: Service
metadata:
  name: agentgateway-metrics
  labels:
    app.kubernetes.io/name: agentgateway
    gateway.networking.k8s.io/gateway-name: agentgateway
spec:
  selector:
    app.kubernetes.io/name: agentgateway
    gateway.networking.k8s.io/gateway-name: agentgateway
  ports:
  - name: metrics
    port: 9090
    targetPort: 9090
    protocol: TCP
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: agentgateway-admin
  labels:
    app.kubernetes.io/name: agentgateway-admin
spec:
  selector:
    app.kubernetes.io/name: agentgateway
    gateway.networking.k8s.io/gateway-name: agentgateway
  ports:
  - name: admin
    port: 15000
    targetPort: 15000
    protocol: TCP
  type: ClusterIP
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: agentgateway-ui
spec:
  parentRefs:
  - name: agentgateway
    namespace: agentgateway
    sectionName: https
  hostnames:
  - "mcp-gw.matherly.net"
  rules:
  - backendRefs:
    - name: agentgateway-admin
      port: 15000
---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: Backend
metadata:
  name: mcp-backend
spec:
  type: MCP
  mcp:
    targets:
    - name: placeholder
      static:
        host: localhost
        port: 9999
        protocol: HTTP
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: mcp-route
spec:
  parentRefs:
  - name: agentgateway
    namespace: agentgateway
    sectionName: mcp
  rules:
  - backendRefs:
    - group: gateway.kgateway.dev
      kind: Backend
      name: mcp-backend
---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: agentgateway-rate-limit
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: agentgateway
  rateLimit:
    local:
      tokenBucket:
        maxTokens: 100           # Maximum burst capacity (requests)
        tokensPerFill: 50        # Requests added per interval
        fillInterval: "60s"      # Refill interval (1 minute)
---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: HTTPListenerPolicy
metadata:
  name: agentgateway-logging
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: agentgateway
  accessLog:
  - fileSink:
      path: /dev/stdout
      jsonFormat:
        timestamp: "%START_TIME%"
        method: "%REQ(:METHOD)%"
        path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
        protocol: "%PROTOCOL%"
        responseCode: "%RESPONSE_CODE%"
        responseFlags: "%RESPONSE_FLAGS%"
        bytesReceived: "%BYTES_RECEIVED%"
        bytesSent: "%BYTES_SENT%"
        duration: "%DURATION%"
        upstreamHost: "%UPSTREAM_HOST%"
        userAgent: "%REQ(USER-AGENT)%"
        requestId: "%REQ(X-REQUEST-ID)%"
        authority: "%REQ(:AUTHORITY)%"
        xAiModel: "%REQ(X-AI-EG-MODEL)%"
        inputTokens: "%RESP(X-INPUT-TOKENS)%"
        outputTokens: "%RESP(X-OUTPUT-TOKENS)%"
        costUsd: "%RESP(X-COST-USD)%"
        promptGuardAction: "%RESP(X-PROMPT-GUARD-ACTION)%"
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: azure-openai-us-east
  labels:
    provider: azure-openai
    region: us-east
spec:
  ai:
    provider:
      azureopenai:
        endpoint: "aaronsai.openai.azure.com"
        deploymentName: "gpt-4.1"
        apiVersion: "2025-01-01-preview"
  policies:
    auth:
      secretRef:
        name: azure-openai-us-east-secret
    ai:
      routes:
        "/v1/chat/completions": "completions"
        "/v1/embeddings": "passthrough"
        "/v1/models": "passthrough"
        "*": "passthrough"
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: azure-openai-us-east-route
spec:
  parentRefs:
  - name: agentgateway
    namespace: agentgateway
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /azure-us-east
    backendRefs:
    - name: azure-openai-us-east
      namespace: agentgateway
      group: agentgateway.dev
      kind: AgentgatewayBackend
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: azure-openai-us-east2
  labels:
    provider: azure-openai
    region: us-east2
spec:
  ai:
    provider:
      azureopenai:
        endpoint: "ets-east-us2.openai.azure.com"
        deploymentName: "gpt-5"
        apiVersion: "2025-01-01-preview"
  policies:
    auth:
      secretRef:
        name: azure-openai-us-east2-secret
    ai:
      routes:
        "/v1/chat/completions": "completions"
        "/v1/embeddings": "passthrough"
        "/v1/models": "passthrough"
        "*": "passthrough"
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: azure-openai-us-east2-route
spec:
  parentRefs:
  - name: agentgateway
    namespace: agentgateway
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /azure-us-east2
    backendRefs:
    - name: azure-openai-us-east2
      namespace: agentgateway
      group: agentgateway.dev
      kind: AgentgatewayBackend
