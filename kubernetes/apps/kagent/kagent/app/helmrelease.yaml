---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kagent
spec:
  chartRef:
    kind: OCIRepository
    name: kagent
  interval: 1h
  timeout: 15m
  dependsOn:
    - name: kagent-crds
  valuesFrom:
    - kind: Secret
      name: kagent-grafana-secret
      valuesKey: GRAFANA_API_KEY
      targetPath: grafana-mcp.grafana.apiKey
  values:
    # ============================================================
    # Global Configuration
    # ============================================================
    imagePullPolicy: IfNotPresent

    # ============================================================
    # Controller Configuration
    # ============================================================
    controller:
      replicas: 1
      loglevel: "info"
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: "2"
          memory: 512Mi
      # Network policy labels for CCNP tiered policies
      podLabels:
        network.cilium.io/api-access: "true"

    # ============================================================
    # UI Configuration
    # ============================================================
    ui:
      replicas: 1
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 1000m
          memory: 1Gi
      service:
        type: ClusterIP
        ports:
          port: 8080
          targetPort: 8080

    # ============================================================
    # LLM Provider Configuration
    # ============================================================
    providers:
      default: "openAI"
      openAI:
        provider: OpenAI
        model: "gpt-5-mini"
        apiKeySecretRef: kagent-provider-secret
        apiKeySecretKey: OPENAI_API_KEY
        config:
          baseUrl: "http://litellm.ai-system.svc.cluster.local:4000/v1"

    # ============================================================
    # Pre-built Agents Configuration
    # ============================================================
    agents:
      k8s-agent:
        enabled: true
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      helm-agent:
        enabled: true
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      observability-agent:
        enabled: true
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      cilium_debug-agent:
        enabled: true
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      cilium_manager-agent:
        enabled: true
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      cilium_policy-agent:
        enabled: true
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      kgateway-agent:
        enabled: true
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi

    # ============================================================
    # kmcp Controller (MCP Server Lifecycle Management)
    # ============================================================
    kmcp:
      enabled: true

    # ============================================================
    # Database Configuration
    # ============================================================
    database:
      type: "postgres"
      postgres:
        # CNPG creates kagent-db-rw service for read-write connections
        url: "postgres://kagent:BzJfIhaKiEin085Zr2ifDQj3@kagent-db-rw.kagent.svc.cluster.local:5432/kagent?sslmode=require"

    # ============================================================
    # Observability Configuration (OpenTelemetry)
    # ============================================================

    # ============================================================
    # Tools Configuration
    # ============================================================
    tools:
      grafana-mcp:
        enabled: false
      querydoc:
        enabled: true

    # grafana-mcp configuration - connects to existing cluster Grafana
    # NOTE: apiKey is injected via valuesFrom from kagent-grafana-secret (SOPS-encrypted)
    grafana-mcp:
      grafana:
        url: "http://vm-grafana.observability.svc:80/api"

    kagent-tools:
      enabled: true
      replicaCount: 1
      tools:
        loglevel: "info"
