---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: envoy-gateway
spec:
  chartRef:
    kind: OCIRepository
    name: envoy-gateway
  interval: 1h
  values:
    global:
      imageRegistry: mirror.gcr.io
    config:
      envoyGateway:
        # Enable extension APIs for AI Gateway
        # - enableBackend: Required for routing to external backends (Backend CRD)
        # - enableEnvoyPatchPolicy: Required for AI Gateway to inject ext_proc filter
        extensionApis:
          enableBackend: true
          enableEnvoyPatchPolicy: true
        provider:
          type: Kubernetes
          kubernetes:
            deploy:
              type: GatewayNamespace
            # Rate limit deployment configuration for AI Gateway
            rateLimitDeployment:
              patch:
                type: StrategicMerge
                value:
                  spec:
                    template:
                      spec:
                        containers:
                          - name: envoy-ratelimit
                            imagePullPolicy: IfNotPresent
        # Global rate limit backend (Redis)
        rateLimit:
          backend:
            type: Redis
            redis:
              url: redis.envoy-ai-gateway-system.svc.cluster.local:6379
