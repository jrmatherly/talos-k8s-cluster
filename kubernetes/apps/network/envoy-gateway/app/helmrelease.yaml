---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: envoy-gateway
spec:
  chartRef:
    kind: OCIRepository
    name: envoy-gateway
  interval: 1h
  values:
    global:
      imageRegistry: mirror.gcr.io
    config:
      envoyGateway:
        # Enable extension APIs for AI Gateway
        # - enableBackend: Required for routing to external backends (Backend CRD)
        # - enableEnvoyPatchPolicy: Required for AI Gateway to inject ext_proc filter
        extensionApis:
          enableBackend: true
          enableEnvoyPatchPolicy: true
        # Disable XDSNameSchemeV2 for AI Gateway v0.4.0 compatibility
        # In EG v1.6, listener names changed from "namespace/gateway/section" to "port/protocol"
        # AI Gateway extension manager expects the old naming scheme
        runtimeFlags:
          disabled:
            - XDSNameSchemeV2
        # Extension manager for AI Gateway to hook into xDS translation
        # This allows AI Gateway controller to inject ext_proc filter for request/response transformation
        extensionManager:
          # failOpen: true allows xDS to continue even if extension errors occur
          # This helps diagnose issues - errors are logged but config is still pushed
          failOpen: true
          hooks:
            xdsTranslator:
              translation:
                listener:
                  includeAll: true
                route:
                  includeAll: true
                cluster:
                  includeAll: true
                secret:
                  includeAll: true
              post:
                - Translation
                - Cluster
                - Route
          service:
            fqdn:
              hostname: ai-gateway-controller.envoy-ai-gateway-system.svc.cluster.local
              port: 1063
        provider:
          type: Kubernetes
          kubernetes:
            deploy:
              type: GatewayNamespace
            # Rate limit deployment configuration for AI Gateway
            rateLimitDeployment:
              patch:
                type: StrategicMerge
                value:
                  spec:
                    template:
                      spec:
                        containers:
                          - name: envoy-ratelimit
                            imagePullPolicy: IfNotPresent
        # Global rate limit backend (Redis)
        rateLimit:
          backend:
            type: Redis
            redis:
              url: redis.envoy-ai-gateway-system.svc.cluster.local:6379
