---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: mcp-jwt-auth
  namespace: network
  labels:
    gateway-type: mcp
    app.kubernetes.io/part-of: mcp-gateway
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: envoy-mcp
  jwt:
    providers:
      - name: keycloak
        issuer: https://auth.matherly.net/realms/k8s-cluster
        remoteJWKS:
          uri: https://auth.matherly.net/realms/k8s-cluster/protocol/openid-connect/certs
        claimToHeaders:
          - header: x-jwt-sub
            claim: sub
          - header: x-jwt-email
            claim: email
          - header: x-jwt-scope
            claim: scope
          - header: x-jwt-azp
            claim: azp
        audiences:
          - mcp-gateway
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: BackendTrafficPolicy
metadata:
  name: mcp-ratelimit
  namespace: network
  labels:
    gateway-type: mcp
    app.kubernetes.io/part-of: mcp-gateway
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: envoy-mcp
  rateLimit:
    type: Local
    local:
      rules:
        - clientSelectors:
            - headers:
                - name: x-jwt-sub
                  type: Distinct
          limit:
            requests: 1000
            unit: Minute
        - limit:
            requests: 10
            unit: Minute
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: mcp-cors
  namespace: network
  labels:
    gateway-type: mcp
    app.kubernetes.io/part-of: mcp-gateway
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: envoy-mcp
  cors:
    allowOrigins:
      - "https://*.matherly.net"
      - "https://*.spoonsofsalt.org"
    allowMethods:
      - GET
      - POST
      - OPTIONS
    allowHeaders:
      - Authorization
      - Content-Type
      - X-Requested-With
      - X-MCP-Session-ID
    exposeHeaders:
      - X-MCP-Session-ID
      - X-Request-ID
    maxAge: 86400s
    allowCredentials: true
