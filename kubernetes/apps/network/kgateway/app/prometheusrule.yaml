---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kgateway-alerts
  labels:
    release: kube-prometheus-stack
spec:
  groups:
    - name: kgateway.envoy.rules
      rules:
        - alert: KgatewayHighErrorRate
          expr: |
            (
              sum(rate(envoy_cluster_upstream_rq_xx{envoy_response_code_class="5"}[5m])) by (envoy_cluster_name)
              /
              sum(rate(envoy_cluster_upstream_rq_total[5m])) by (envoy_cluster_name)
            ) > 0.1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High error rate on kgateway cluster {{ $labels.envoy_cluster_name }}"
            description: "Error rate is {{ $value | humanizePercentage }} for cluster {{ $labels.envoy_cluster_name }}"

        - alert: KgatewayConnectionFailures
          expr: |
            sum(rate(envoy_cluster_upstream_cx_connect_fail[5m])) by (envoy_cluster_name) > 0.5
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Connection failures to backend {{ $labels.envoy_cluster_name }}"
            description: "{{ $value }} connection failures per second to {{ $labels.envoy_cluster_name }}"

        - alert: KgatewayCircuitBreakerTripped
          expr: |
            envoy_cluster_outlier_detection_ejections_enforced_total > 0
          for: 1m
          labels:
            severity: warning
          annotations:
            summary: "Circuit breaker tripped for backend {{ $labels.envoy_cluster_name }}"
            description: "Backend {{ $labels.envoy_cluster_name }} has been ejected due to health check failures"

        - alert: KgatewayHighLatency
          expr: |
            histogram_quantile(0.99,
              sum(rate(envoy_cluster_upstream_rq_time_bucket[5m])) by (le, envoy_cluster_name)
            ) > 10000
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "High latency on kgateway cluster {{ $labels.envoy_cluster_name }}"
            description: "P99 latency is {{ $value | humanizeDuration }} for cluster {{ $labels.envoy_cluster_name }}"

        - alert: KgatewayProxyNotReady
          expr: |
            kube_pod_status_ready{namespace="network", pod=~"external-.*|internal-.*", condition="true"} == 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "kgateway proxy pod {{ $labels.pod }} is not ready"
            description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has been not ready for 5 minutes"

    - name: kgateway.controller.rules
      rules:
        - alert: KgatewayControllerDown
          expr: |
            up{job="kgateway-controller"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "kgateway controller is down"
            description: "The kgateway controller has been down for more than 5 minutes"

        - alert: KgatewayReconciliationErrors
          expr: |
            sum(rate(controller_runtime_reconcile_errors_total{controller=~".*gateway.*"}[5m])) > 0.1
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "kgateway controller reconciliation errors"
            description: "{{ $value }} reconciliation errors per second"
