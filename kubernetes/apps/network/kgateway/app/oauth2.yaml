---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: GatewayExtension
metadata:
  name: keycloak-oauth2
spec:
  type: OAuth2
  oauth2:
    issuerURI: "https://auth.matherly.net/realms/k8s-cluster"
    redirectURI: "https://sso.matherly.net/oauth2/redirect"
    backendRef:
      name: keycloak-http
      namespace: keycloak
      port: 8080
    credentials:
      clientID: "kgateway"
      clientSecretRef:
        name: keycloak-oidc-credentials
    scopes:
      - openid
      - profile
      - email
    forwardAccessToken: true
    logoutPath: "/logout"
    endSessionEndpoint: "https://auth.matherly.net/realms/k8s-cluster/protocol/openid-connect/logout"
    cookies:
      domain: "matherly.net"
      sameSite: Lax
    denyRedirect:
      headers:
        - name: "X-Requested-With"
          value: "XMLHttpRequest"
---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: kgateway-internal-oauth2
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: internal
  oauth2:
    extensionRef:
      name: keycloak-oauth2
      namespace: network
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: sso-callback
spec:
  hostnames:
    - sso.matherly.net
  parentRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: internal
      namespace: network
      sectionName: https
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /oauth2/redirect
      backendRefs:
        - name: keycloak-http
          namespace: keycloak
          port: 8080
    - matches:
        - path:
            type: PathPrefix
            value: /
      filters:
        - type: RequestRedirect
          requestRedirect:
            hostname: auth.matherly.net
            path:
              type: ReplaceFullPath
              replaceFullPath: /realms/k8s-cluster/account
            statusCode: 302
