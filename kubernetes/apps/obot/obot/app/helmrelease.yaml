---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: obot
spec:
  chartRef:
    kind: OCIRepository
    name: obot
  interval: 1h
  timeout: 15m
  values:
    # ============================================================
    # Image Configuration
    # ============================================================
    image:
      repository: ghcr.io/jrmatherly/obot-entraid
      tag: v0.2.18

    # ============================================================
    # Replicas - Limited to 1 with RWO storage, multiple with S3
    # ============================================================
    replicaCount: 2

    # ============================================================
    # Deployment Strategy
    # - Recreate: Required for RWO PVC (Multi-Attach errors with RollingUpdate)
    # - RollingUpdate: Can be used with S3 workspace storage
    # ============================================================
    updateStrategy: RollingUpdate

    # ============================================================
    # Service Configuration
    # Note: port 80 is required because MCP server token exchange URLs
    # are generated without explicit ports (defaulting to HTTP port 80)
    # The service routes port 80 -> targetPort 8080 (container port)
    # ============================================================
    service:
      type: ClusterIP
      port: 80

    # ============================================================
    # Ingress - Disabled (using Gateway API HTTPRoute instead)
    # ============================================================
    ingress:
      enabled: false

    # ============================================================
    # Configuration - All environment variables in one section
    # ============================================================
    config:
      # Server Hostname (CRITICAL: Required for OAuth callbacks and LLM proxying)
      OBOT_SERVER_HOSTNAME: "https://obot.${SECRET_DOMAIN}"

      # Database Configuration
      OBOT_SERVER_DSN: "postgresql://obot:${OBOT_DB_PASSWORD}@obot-db-rw.obot.svc.cluster.local:5432/obot?sslmode=require"

      # MCP Runtime Configuration
      # Note: OBOT_SERVER_MCPNAMESPACE, OBOT_SERVER_SERVICE_NAME, and OBOT_SERVER_SERVICE_NAMESPACE
      # are automatically set by the chart when OBOT_SERVER_MCPRUNTIME_BACKEND is "kubernetes"
      OBOT_SERVER_MCPRUNTIME_BACKEND: "kubernetes"

      # Authentication (must be boolean for chart's NOTES.txt template)
      OBOT_SERVER_ENABLE_AUTHENTICATION: true
      OBOT_SERVER_AUTH_ADMIN_EMAILS: "jasonrmatherly@gmail.com"
      OBOT_SERVER_AUTH_OWNER_EMAILS: "jasonrmatherly@gmail.com"
      OBOT_BOOTSTRAP_TOKEN: "${OBOT_BOOTSTRAP_TOKEN}"

      # Entra ID OAuth Configuration
      OBOT_SERVER_AUTH_PROVIDER: "entra-id"
      OBOT_SERVER_AUTH_ENTRA_TENANT_ID: "f505346f-75cf-458b-baeb-10708d41967d"
      OBOT_SERVER_AUTH_ENTRA_CLIENT_ID: "${OBOT_ENTRA_CLIENT_ID}"
      OBOT_SERVER_AUTH_ENTRA_CLIENT_SECRET: "${OBOT_ENTRA_CLIENT_SECRET}"
      OBOT_SERVER_AUTH_REDIRECT_URL: "https://obot.${SECRET_DOMAIN}/oauth2/callback"
      # Token audience validation (security hardening - prevents token confusion attacks)
      OBOT_SERVER_AUTH_AUDIENCE: "${OBOT_ENTRA_CLIENT_ID}"
      OBOT_SERVER_AUTH_REQUIRED_CLAIMS: "email,preferred_username"

      # Encryption Configuration
      # Per docs/obot-docs/configuration/encryption-providers/custom-provider.md:
      # - OBOT_SERVER_ENCRYPTION_PROVIDER must be "custom"
      # - OBOT_SERVER_ENCRYPTION_KEY via Flux substitution from cluster-secrets
      # - OBOT_SERVER_ENCRYPTION_CONFIG_FILE points to the config file created by initContainer
      # Chart's initContainer creates /config/encryption.yaml from the secret key
      OBOT_SERVER_ENCRYPTION_PROVIDER: "custom"
      OBOT_SERVER_ENCRYPTION_KEY: "${OBOT_SERVER_ENCRYPTION_KEY}"
      OBOT_SERVER_ENCRYPTION_CONFIG_FILE: "/config/encryption.yaml"

      # AI Gateway Integration
      # Supports two gateway options:
      # - agentgateway (ai-gw): MCP/AI-focused gateway with rate limiting, prompt guards, FinOps metrics
      # - Envoy AI Gateway (llms): Legacy Azure OpenAI routing gateway
      OBOT_SERVER_LLM_BASE_URL: "https://llms.${SECRET_DOMAIN}/v1"

      # Tool Registries - Unified path containing all auth providers (upstream + custom)
      # The Docker build merges GitHub, Google, EntraID, and Keycloak providers into single index.yaml
      OBOT_SERVER_TOOL_REGISTRIES: "/obot-tools/tools"

      # Disable update check - using forked repo, upstream version checks are not relevant
      OBOT_SERVER_DISABLE_UPDATE_CHECK: "true"

      # ============================================================
      # S3 Workspace Provider Configuration
      # Enables multi-replica scaling by using S3-compatible storage (MinIO)
      # REF: https://docs.obot.ai/configuration/workspace-provider/
      # ============================================================
      OBOT_WORKSPACE_PROVIDER_TYPE: "s3"
      WORKSPACE_PROVIDER_S3_BUCKET: "obot-workspaces"
      WORKSPACE_PROVIDER_S3_BASE_ENDPOINT: "http://minio.storage.svc.cluster.local:9000"
      AWS_ACCESS_KEY_ID: "${OBOT_S3_ACCESS_KEY}"
      AWS_SECRET_ACCESS_KEY: "${OBOT_S3_SECRET_KEY}"
      AWS_REGION: "us-east-1"
      # Use path-style URLs for S3-compatible storage (MinIO without wildcard DNS)
      # Format: https://my-s3-endpoint.domain.com/bucket instead of https://bucket.s3.domain.com
      WORKSPACE_PROVIDER_S3_USE_PATH_STYLE: "true"

    # ============================================================
    # Storage Configuration
    # Note: PVC persistence is disabled when using S3 workspace provider
    # ============================================================
    persistence:
      enabled: false

    # ============================================================
    # MCP Kubernetes Runtime Settings
    # ============================================================
    mcpNamespace:
      name: obot-mcp
      create: false  # Created via Flux, not Helm

    mcpServerDefaults:
      resources:
        requests:
          cpu: "100m"
          memory: "256Mi"
        limits:
          cpu: "500m"
          memory: "512Mi"
      podSecurityContext:
        runAsNonRoot: true
        runAsUser: 65534
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL

    # ============================================================
    # Resource Limits
    # ============================================================
    resources:
      requests:
        cpu: "500m"
        memory: "1Gi"
      limits:
        cpu: "2000m"
        memory: "4Gi"

    # ============================================================
    # Security Context
    # ============================================================
    podSecurityContext:
      fsGroup: 1000

    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      capabilities:
        drop:
          - ALL

    # ============================================================
    # Probes
    # ============================================================
    livenessProbe:
      httpGet:
        path: /api/healthz
        port: 8080
      initialDelaySeconds: 60
      periodSeconds: 15
      failureThreshold: 5
      timeoutSeconds: 10

    readinessProbe:
      httpGet:
        path: /api/healthz
        port: 8080
      initialDelaySeconds: 30
      periodSeconds: 10
      failureThreshold: 3
      timeoutSeconds: 5

    # ============================================================
    # Service Account
    # ============================================================
    serviceAccount:
      create: true
      name: obot

    # ============================================================
    # RBAC for MCP Namespace
    # ============================================================
    rbac:
      create: true
