---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: obot
  namespace: obot
spec:
  chart:
    spec:
      chart: obot
      version: ">=0.1.0"
      sourceRef:
        kind: HelmRepository
        name: obot
  interval: 1h
  timeout: 15m
  values:
    # ============================================================
    # Image Configuration
    # ============================================================
    image:
      repository: ghcr.io/jrmatherly/obot-entraid
      pullPolicy: IfNotPresent

    # ============================================================
    # Replicas - Set to 1 for RWO storage
    # ============================================================
    replicaCount: 1

    # ============================================================
    # Service Configuration
    # ============================================================
    service:
      type: ClusterIP
      port: 8080

    # ============================================================
    # Ingress - Disabled (using Gateway API HTTPRoute instead)
    # ============================================================
    ingress:
      enabled: false

    # ============================================================
    # Configuration - All environment variables in one section
    # ============================================================
    config:
      # Database Configuration
      OBOT_SERVER_DSN: "postgresql://obot:${OBOT_DB_PASSWORD}@obot-db-rw.obot.svc.cluster.local:5432/obot?sslmode=require"

      # Authentication
      OBOT_SERVER_ENABLE_AUTHENTICATION: "true"

      # Entra ID OAuth Configuration
      OBOT_SERVER_AUTH_PROVIDER: "entra-id"
      OBOT_SERVER_AUTH_ENTRA_TENANT_ID: "f505346f-75cf-458b-baeb-10708d41967d"
      OBOT_SERVER_AUTH_ENTRA_CLIENT_ID: "${OBOT_ENTRA_CLIENT_ID}"
      OBOT_SERVER_AUTH_ENTRA_CLIENT_SECRET: "${OBOT_ENTRA_CLIENT_SECRET}"
      OBOT_SERVER_AUTH_REDIRECT_URL: "https://obot.${SECRET_DOMAIN}/oauth2/callback"
      # Token audience validation (security hardening - prevents token confusion attacks)
      OBOT_SERVER_AUTH_AUDIENCE: "${OBOT_ENTRA_CLIENT_ID}"
      OBOT_SERVER_AUTH_REQUIRED_CLAIMS: "email,preferred_username"

      # Encryption Configuration
      OBOT_SERVER_ENCRYPTION_PROVIDER: "custom"
      OBOT_SERVER_ENCRYPTION_KEY: "${OBOT_ENCRYPTION_KEY}"

      # MCP Namespace Configuration
      OBOT_SERVER_MCPNAMESPACE: "obot-mcp"

      # AI Gateway Integration
      OBOT_SERVER_LLM_BASE_URL: "https://llms.${SECRET_DOMAIN}/v1"

    # ============================================================
    # Storage Configuration
    # ============================================================
    persistence:
      enabled: true
      storageClass: proxmox-csi
      size: 20Gi
      accessMode: ReadWriteOnce

    # ============================================================
    # MCP Kubernetes Runtime Settings
    # ============================================================
    mcpNamespace:
      name: obot-mcp
      create: false  # Created via Flux, not Helm

    mcpServerDefaults:
      resources:
        requests:
          cpu: "100m"
          memory: "256Mi"
        limits:
          cpu: "500m"
          memory: "512Mi"
      podSecurityContext:
        runAsNonRoot: true
        runAsUser: 65534
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL

    # ============================================================
    # Resource Limits
    # ============================================================
    resources:
      requests:
        cpu: "500m"
        memory: "1Gi"
      limits:
        cpu: "2000m"
        memory: "4Gi"

    # ============================================================
    # Security Context
    # ============================================================
    podSecurityContext:
      fsGroup: 1000

    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      capabilities:
        drop:
          - ALL

    # ============================================================
    # Probes
    # ============================================================
    livenessProbe:
      httpGet:
        path: /api/healthz
        port: 8080
      initialDelaySeconds: 60
      periodSeconds: 15
      failureThreshold: 5
      timeoutSeconds: 10

    readinessProbe:
      httpGet:
        path: /api/healthz
        port: 8080
      initialDelaySeconds: 30
      periodSeconds: 10
      failureThreshold: 3
      timeoutSeconds: 5

    # ============================================================
    # Existing Secret for Sensitive Configuration
    # ============================================================
    existingSecret: obot-config-secret

    # ============================================================
    # Service Account
    # ============================================================
    serviceAccount:
      create: true
      name: obot

    # ============================================================
    # RBAC for MCP Namespace
    # ============================================================
    rbac:
      create: true
