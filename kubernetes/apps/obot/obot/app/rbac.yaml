---
# Explicit Role for obot ServiceAccount to manage MCP servers
# Security hardening: Least-privilege RBAC for MCP server lifecycle management
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: obot-mcp-manager
  namespace: obot-mcp
rules:
  # Pod lifecycle management for MCP servers
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch", "create", "delete"]
  # Service management for MCP server endpoints
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get", "list", "watch", "create", "delete"]
  # ConfigMaps for MCP server configuration (read-only)
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]
  # Pod logs for debugging (read-only)
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get"]
  # Events for observability (read-only)
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["get", "list", "watch"]
  # Explicitly DENY: secrets, pods/exec, pods/attach, pods/portforward
  # (These are not listed, so they are denied by default)
---
# RoleBinding for obot ServiceAccount
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: obot-mcp-manager
  namespace: obot-mcp
subjects:
  - kind: ServiceAccount
    name: obot
    namespace: obot
roleRef:
  kind: Role
  name: obot-mcp-manager
  apiGroup: rbac.authorization.k8s.io
---
# Role for obot to read its own namespace resources
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: obot-self
  namespace: obot
rules:
  # Read secrets (for database credentials lookup)
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get"]
    resourceNames: ["obot-config-secret", "obot-db-secret"]
  # Read configmaps
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]
  # Events for observability
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["get", "list", "watch"]
---
# RoleBinding for obot to access its own namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: obot-self
  namespace: obot
subjects:
  - kind: ServiceAccount
    name: obot
    namespace: obot
roleRef:
  kind: Role
  name: obot-self
  apiGroup: rbac.authorization.k8s.io
