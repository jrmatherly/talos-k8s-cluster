---
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-realm-config
  labels:
    app: keycloak
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/component: configuration
    app.kubernetes.io/part-of: mcp-gateway
data:
  realm.json: |
    {
      "realm": "k8s-cluster",
      "enabled": true,
      "sslRequired": "external",
      "registrationAllowed": false,
      "resetPasswordAllowed": true,
      "rememberMe": true,
      "accessTokenLifespan": 3600,
      "ssoSessionIdleTimeout": 1800,
      "ssoSessionMaxLifespan": 36000,
      "offlineSessionIdleTimeout": 2592000,
      "clientPolicies": {
        "policies": [
          {
            "name": "mcp-servers-policy",
            "description": "RFC 8707 Resource Indicators for MCP servers",
            "enabled": true,
            "conditions": [],
            "profiles": ["resource-server-profile"]
          }
        ]
      },
      "clients": [
        {
          "clientId": "mcp-gateway",
          "name": "MCP Authorization Gateway",
          "enabled": true,
          "publicClient": false,
          "serviceAccountsEnabled": true,
          "authorizationServicesEnabled": true,
          "standardFlowEnabled": true,
          "directAccessGrantsEnabled": false,
          "attributes": {
            "oauth2.token.exchange.grant.enabled": "true",
            "use.resource.indicators": "true"
          }
        },
        {
          "clientId": "envoy-gateway",
          "name": "Envoy Gateway OIDC Client",
          "description": "OIDC client for Envoy Gateway SecurityPolicy authentication",
          "enabled": true,
          "publicClient": false,
          "standardFlowEnabled": true,
          "directAccessGrantsEnabled": false,
          "serviceAccountsEnabled": false,
          "redirectUris": [
            "https://auth-internal.matherly.net/oauth2/callback",
            "https://auth-external.matherly.net/oauth2/callback"
          ],
          "webOrigins": [
            "https://*.matherly.net"
          ],
          "attributes": {
            "pkce.code.challenge.method": "S256",
            "post.logout.redirect.uris": "https://*.matherly.net/*"
          }
        }
      ],
      "identityProviders": [
        {
          "alias": "google",
          "providerId": "google",
          "enabled": true,
          "trustEmail": true,
          "config": {
            "clientId": "976645342576-h0l683golj85f3jse02oe48dhkeq33nf.apps.googleusercontent.com",
            "defaultScope": "openid profile email"
          }
        },
        {}
      ]
    }
