---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: flux-operator
spec:
  chartRef:
    kind: OCIRepository
    name: flux-operator
  interval: 1h
  valuesFrom:
    - kind: Secret
      name: flux-web-oidc-credentials
      valuesKey: client-id
      targetPath: web.config.authentication.oauth2.clientID
    - kind: Secret
      name: flux-web-oidc-credentials
      valuesKey: client-secret
      targetPath: web.config.authentication.oauth2.clientSecret
  values:
    # Network policy labels for CCNP tiered policies (commonLabels applies to all resources including pods)
    commonLabels:
      network.cilium.io/api-access: "true"
    serviceMonitor:
      create: true
    # Disable the built-in NetworkPolicy which only allows port 9080 (web)
    # but blocks port 8080 (metrics) that the serviceMonitor scrapes
    statusPage:
      networkPolicy:
        create: false
    # ============================================================
    # Web UI Configuration
    # REF: https://fluxoperator.dev/docs/web-ui/
    # ============================================================
    web:
      enabled: true
      # Web Config API specification for OAuth2/OIDC authentication
      config:
        baseURL: "https://flux.matherly.net"
        sessionDuration: "168h"
        userCacheSize: 100
        authentication:
          type: OAuth2
          oauth2:
            provider: OIDC
            issuerURL: "https://auth.matherly.net/realms/k8s-cluster"
            scopes:
              - openid
              - profile
              - email
              - groups
            # CEL-based claims mapping for Kubernetes RBAC
            impersonation:
              username: "claims.email"
              groups: "claims.groups"
