---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: flux-mcp
spec:
  serviceAccountName: flux-operator
  chartRef:
    kind: OCIRepository
    name: flux-mcp
  interval: 30m
  timeout: 10m
  values:
    # ============================================================
    # Server Configuration (top-level per chart schema)
    # ============================================================
    # Transport mode: sse (Server-Sent Events) or http (Streamable HTTP)
    transport: http
    # Read-only mode disables modification operations
    readonly: True

    # ============================================================
    # NetworkPolicy (built-in chart feature)
    # ============================================================
    networkPolicy:
      ingress:
        namespaces:
          - flux-system
          - agentgateway-system
          - network

    # ============================================================
    # Pod Labels for CiliumNetworkPolicy matching
    # ============================================================
    podLabels:
      app.kubernetes.io/name: flux-mcp
      app.kubernetes.io/component: mcp-server
      # Label for AgentGateway dynamic MCP backend discovery
      agentgateway.dev/mcp: "true"
      # Label for CiliumClusterwideNetworkPolicy tiered policy matching
      network.cilium.io/api-access: "true"

    # ============================================================
    # Service Configuration
    # ============================================================
    service:
      # Labels for AgentGateway dynamic MCP backend discovery
      labels:
        agentgateway.dev/mcp: "true"

    # ============================================================
    # Resource Limits
    # ============================================================
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi
