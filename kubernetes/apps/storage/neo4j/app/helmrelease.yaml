---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: neo4j
spec:
  chart:
    spec:
      chart: neo4j
      version: "5.26.18"
      sourceRef:
        kind: HelmRepository
        name: neo4j
  interval: 1h
  timeout: 15m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
      remediateLastFailure: true

  values:
    # ==========================================================================
    # Neo4j Community Edition - Single Instance Graph Database
    # Deployed in storage namespace for shared access across AI workloads
    # Note: CE only supports single instance, clustering requires Enterprise
    # ==========================================================================

    fullnameOverride: neo4j

    neo4j:
      name: neo4j
      edition: community
      minimumClusterSize: 1

      # Password from SOPS-encrypted secret (format: neo4j/<password> in NEO4J_AUTH key)
      passwordFromSecret: neo4j-secrets

      # Resource allocation
      resources:
        cpu: "1000m"
        memory: "2Gi"

    # ==========================================================================
    # Volumes Configuration
    # ==========================================================================
    volumes:
      data:
        # Use dynamic mode with explicit storage class when Proxmox CSI is configured
        mode: dynamic
        dynamic:
          storageClassName: proxmox-csi
          requests:
            storage: 40Gi

    # ==========================================================================
    # Services Configuration
    # ==========================================================================
    services:
      # Main Neo4j service for Bolt connections
      neo4j:
        enabled: true
        spec:
          type: ClusterIP
          selector:
            app.kubernetes.io/name: neo4j
          ports:
            bolt:
              protocol: TCP
              port: 7687
              targetPort: 7687
            http:
              protocol: TCP
              port: 7474
              targetPort: 7474


    # ==========================================================================
    # Pod Security Context
    # ==========================================================================
    securityContext:
      runAsNonRoot: true
      runAsUser: 7474
      runAsGroup: 7474
      fsGroup: 7474
      fsGroupChangePolicy: OnRootMismatch
      seccompProfile:
        type: RuntimeDefault

    # ==========================================================================
    # Container Security Context
    # ==========================================================================
    containerSecurityContext:
      allowPrivilegeEscalation: false
      privileged: false
      readOnlyRootFilesystem: false
      capabilities:
        drop: ["ALL"]
      seccompProfile:
        type: RuntimeDefault

    # ==========================================================================
    # Startup/Liveness/Readiness Probes
    # ==========================================================================
    startupProbe:
      enabled: true
      failureThreshold: 30
      periodSeconds: 10

    livenessProbe:
      enabled: true
      failureThreshold: 3
      periodSeconds: 15

    readinessProbe:
      enabled: true
      failureThreshold: 3
      periodSeconds: 10

    # ==========================================================================
    # Additional labels for NetworkPolicy targeting
    # ==========================================================================
    podLabels:
      app.kubernetes.io/name: neo4j
      app.kubernetes.io/component: graph-database

    # ==========================================================================
    # Environment Variables
    # ==========================================================================
    env:
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
